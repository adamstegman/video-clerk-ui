import{a as i,C as pe,v as be,w as ye}from"./chunk-JMJ3UQ3L-DPj_BNs_.js";import{j as t}from"./jsx-runtime-u17CrQMm.js";import{c as M}from"./client-B_XR4Hye.js";import{A as G}from"./action-button-BX2IeZ2i.js";import{c as v,p as we,s as Y,e as te,b as V,a as je}from"./utils-ByhHhwOs.js";import{b as ke}from"./tmdb-configuration-BxuIu_6_.js";import{S as ne,a as _e}from"./settings-subsection-X7Eq6pXz.js";import{c as Ee}from"./createLucideIcon-CMzVMv86.js";const Se=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],Ne=Ee("arrow-left",Se);function ve({entry:e}){const a=i.useContext(ke),s=a.images.poster_sizes.length>2?2:a.images.poster_sizes.length-1,d=a.images.poster_sizes[s]||a.images.poster_sizes[0];return t.jsxs("div",{className:"flex gap-4 md:gap-6 items-start",children:[e.posterPath&&a.images.secure_base_url&&d&&t.jsx("img",{src:`${a.images.secure_base_url}${d}${e.posterPath}`,alt:e.title,className:"flex-shrink-0 w-16 h-24 object-cover rounded md:w-20 md:h-[120px]"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h3",{className:v("font-bold text-base md:text-lg",we),children:e.title}),e.releaseYear&&t.jsx("p",{className:v("text-sm md:text-base",Y),children:e.releaseYear})]})]})}function ze({watched:e,onWatchedChange:a}){return t.jsx(ne,{title:"Status",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("input",{id:"entry-watched",type:"checkbox",checked:e,onChange:s=>a(s.target.checked),className:"h-4 w-4 rounded border-zinc-300 text-indigo-600 focus:ring-indigo-500 dark:border-zinc-700 dark:bg-zinc-950"}),t.jsx("label",{htmlFor:"entry-watched",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Watched"})]})})}function re({tag:e,variant:a,selected:s,onClick:d,ariaLabel:m}){return t.jsx("button",{type:"button",onClick:()=>d(e),"aria-label":m,"aria-pressed":a==="toggle"?s:void 0,className:v("rounded-full border px-3 py-1 text-xs font-medium",a==="removable"&&"border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 dark:border-indigo-700 dark:bg-indigo-950 dark:text-indigo-200",a==="toggle"&&"transition",a==="toggle"&&s&&"border-indigo-400 bg-indigo-500 text-white hover:bg-indigo-400 dark:border-indigo-500 dark:bg-indigo-500",a==="toggle"&&!s&&"border-zinc-200 bg-white text-zinc-600 hover:bg-zinc-100 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-200 dark:hover:bg-zinc-800"),children:e.name})}function Ce({selectedTags:e,onRemoveTag:a}){return t.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.length===0&&t.jsx("p",{className:v("text-sm",Y),children:"No tags selected."}),e.map(s=>t.jsx(re,{tag:s,variant:"removable",selected:!0,onClick:a,ariaLabel:`Remove tag ${s.name}`},s.id))]})}function Te({tagQuery:e,onTagQueryChange:a,onCreateTag:s,creatingTag:d,suggestions:m,canCreateTag:h}){return t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx("label",{htmlFor:"entry-tag-query",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Add tag"}),t.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:[t.jsx("input",{id:"entry-tag-query",value:e,onChange:f=>a(f.target.value),onKeyDown:f=>{if(f.key==="Enter"||f.key==="Tab"||f.key===","){if(e.trim().length===0)return;f.preventDefault(),s(e)}},placeholder:"Type a tag name",className:"w-full rounded-md border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder:text-zinc-400 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-100","aria-autocomplete":"list","aria-expanded":m.length>0||h,"aria-controls":"entry-tag-suggestions"}),t.jsx(G,{onClick:()=>s(e),disabled:e.trim().length===0||d,loading:d,loadingText:"Adding...",variant:"secondary",size:"sm",className:"sm:w-auto",children:"Add"})]})]})}function Ae({suggestions:e,canCreateTag:a,tagQuery:s,onCreateTag:d,onAddTag:m}){return e.length===0&&!a?null:t.jsxs("div",{id:"entry-tag-suggestions",role:"listbox",className:"rounded-md border border-zinc-200 bg-white p-2 text-sm shadow-sm dark:border-zinc-700 dark:bg-zinc-900",children:[a&&t.jsxs("button",{type:"button",onClick:()=>d(s),className:"w-full rounded-md px-2 py-1 text-left text-indigo-600 hover:bg-indigo-50 dark:text-indigo-300 dark:hover:bg-indigo-900/40",children:['Create "',s.trim(),'"']}),e.map(h=>t.jsx("button",{type:"button",onClick:()=>m(h),className:"w-full rounded-md px-2 py-1 text-left hover:bg-zinc-100 dark:hover:bg-zinc-800",children:h.name},h.id))]})}function De({availableTags:e,selectedTags:a,onToggleTag:s}){return t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx("p",{className:"text-xs font-medium text-zinc-500 dark:text-zinc-400",children:"Existing tags"}),e.length===0?t.jsx("p",{className:v("text-sm",Y),children:"No tags available."}):t.jsx("div",{className:"flex flex-wrap gap-2",children:e.map(d=>{const m=a.some(h=>h.id===d.id);return t.jsx(re,{tag:d,variant:"toggle",selected:m,onClick:s,ariaLabel:`${m?"Deselect":"Select"} tag ${d.name}`},d.id)})})]})}function Ie({selectedTags:e,availableTags:a,tagQuery:s,suggestions:d,canCreateTag:m,creatingTag:h,saveError:f,onTagQueryChange:D,onAddTag:S,onRemoveTag:E,onToggleTag:w,onCreateTag:b}){return t.jsx(ne,{title:"Tags",children:t.jsxs(_e,{description:"",error:f,children:[t.jsx(Ce,{selectedTags:e,onRemoveTag:E}),t.jsx(Te,{tagQuery:s,onTagQueryChange:D,onCreateTag:b,creatingTag:h,suggestions:d,canCreateTag:m}),t.jsx(Ae,{suggestions:d,canCreateTag:m,tagQuery:s,onCreateTag:b,onAddTag:S}),t.jsx(De,{availableTags:a,selectedTags:e,onToggleTag:w})]})})}function Fe({deleting:e,deleteError:a,onDelete:s}){return t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx(G,{onClick:s,loading:e,loadingText:"Deleting...",variant:"secondary",className:"border border-red-300 text-red-600 hover:bg-red-50 dark:border-red-700 dark:text-red-400 dark:hover:bg-red-900/20 w-full md:w-auto",children:"Delete entry"}),a&&t.jsx("p",{className:v("text-sm",te),children:a})]})}function qe({entry:e,loading:a,error:s,selectedTags:d,availableTags:m,tagQuery:h,suggestions:f,canCreateTag:D,watched:S,onWatchedChange:E,onTagQueryChange:w,onAddTag:b,onRemoveTag:T,onToggleTag:j,onCreateTag:N,onSaveTags:I,saving:F,saveError:B,saveCompleted:q,creatingTag:R,deleting:L,deleteError:K,onDelete:z}){return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:V,children:t.jsx("div",{className:"flex items-center justify-between gap-4",children:t.jsx("h2",{className:je,children:"Edit entry"})})}),t.jsxs("div",{className:"flex-1 overflow-y-auto min-h-0 pb-4",children:[a&&!s&&t.jsx("div",{className:"flex items-center justify-center py-12",children:t.jsxs("div",{className:"flex flex-col items-center gap-4",children:[t.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),t.jsx("p",{className:Y,children:"Loading entry..."})]})}),s&&t.jsx("p",{className:v("text-sm",te),children:s}),!a&&!s&&e&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:V,children:t.jsx(ve,{entry:e})}),t.jsx(ze,{watched:S,onWatchedChange:E}),t.jsx(Ie,{selectedTags:d,availableTags:m,tagQuery:h,suggestions:f,canCreateTag:D,creatingTag:R,saveError:B,onTagQueryChange:w,onAddTag:b,onRemoveTag:T,onToggleTag:j,onCreateTag:N}),t.jsxs("div",{className:v(V,"flex flex-col gap-3 md:flex-row md:items-start md:justify-between"),children:[t.jsx(Fe,{deleting:L,deleteError:K,onDelete:z}),t.jsx(G,{onClick:I,loading:F,disabled:!e||R,loadingText:"Saving...",completed:q,completedText:"Saved!",className:"w-full md:w-auto md:ml-auto",children:"Save"})]})]})]})]})}function Be(e){return e&&e.split("-")[0]||""}function Re(e){return e?Array.isArray(e)?e[0]??null:e:null}function Le(e){return e?Array.isArray(e)?e[0]??null:e:null}function g(e){return H(e).toLowerCase()}function H(e){return e.trim().replace(/\s+/g," ")}function W(e,a){return e instanceof Error?e.message:typeof e=="object"&&e!==null&&"message"in e&&typeof e.message=="string"?String(e.message):a}function Pe(){const e=pe(),a=be(),s=i.useMemo(()=>{const n=e.entryId;if(!n)return null;const r=Number(n);return Number.isFinite(r)&&r>0?Math.trunc(r):null},[e.entryId]),[d,m]=i.useState(null),[h,f]=i.useState(!0),[D,S]=i.useState(null),[E,w]=i.useState([]),[b,T]=i.useState([]),[j,N]=i.useState(""),[I,F]=i.useState(!1),[B,q]=i.useState(null),[R,L]=i.useState(!1),[K,z]=i.useState(null),[se,P]=i.useState(!1),[O,J]=i.useState(!1),[U,X]=i.useState(!1),[ae,Z]=i.useState(null),Q=i.useCallback(async()=>{if(!s){m(null),S("Invalid entry."),f(!1);return}f(!0),S(null);try{const n=M(),[r,o]=await Promise.all([n.from("entries").select(`
              id,
              added_at,
              watched_at,
              tmdb_details (
                poster_path,
                name,
                release_date
              ),
              entry_tags (
                tags (
                  id,
                  name,
                  is_custom
                )
              )
            `).eq("id",s).maybeSingle(),n.from("tags").select("id,name,is_custom").order("name")]);if(r.error)throw r.error;if(!r.data){m(null),S("Entry not found.");return}if(o.error)console.error("Failed to load tags",o.error),T([]);else{const u=o.data?.filter(l=>l.name&&typeof l.id=="number").map(l=>({id:l.id,name:l.name,is_custom:!!l.is_custom}))??[];T(u)}const c=r.data,p=Re(c.tmdb_details),x=c.entry_tags?.map(u=>Le(u.tags)).filter(u=>!!u&&typeof u.id=="number"&&!!u.name).map(u=>({id:u.id,name:u.name,is_custom:!!u.is_custom}))??[];m({id:c.id,title:p?.name||"Untitled",releaseYear:Be(p?.release_date??null),posterPath:p?.poster_path??null}),w(x),F(!!c.watched_at),q(c.watched_at??null)}catch(n){m(null),S(W(n,"Failed to load entry"))}finally{f(!1)}},[s]);i.useEffect(()=>{Q()},[Q]);const A=i.useRef(null);i.useEffect(()=>{d&&(N(""),z(null),P(!1))},[d?.id]),i.useEffect(()=>()=>{A.current!==null&&(window.clearTimeout(A.current),A.current=null)},[]);const y=i.useCallback(()=>{z(null),P(!1)},[]),ie=i.useCallback(n=>{F(n),q(r=>n?r??new Date().toISOString():null),y()},[y]),oe=i.useCallback(n=>{N(n),y()},[y]),le=i.useCallback(n=>{w(r=>r.some(c=>g(c.name)===g(n.name))?r:[...r,n]),N(""),y()},[y]),de=i.useCallback(n=>{w(r=>r.filter(o=>o.id!==n.id)),y()},[y]),ce=i.useCallback(n=>{w(r=>r.some(c=>c.id===n.id)?r.filter(c=>c.id!==n.id):[...r,n]),N(""),y()},[y]),ee=i.useCallback(async(n,r)=>{const o=H(r);if(!o)return null;const{data:c,error:p}=await n.from("tags").select("id,name,is_custom").ilike("name",o);if(p)throw p;const x=c?.filter(l=>l.name&&typeof l.id=="number").map(l=>({id:l.id,name:l.name,is_custom:!!l.is_custom}))??[];if(x.length===0)return null;const u=x.find(l=>l.is_custom)??x[0]??null;return u?(T(l=>l.some(C=>g(C.name)===g(u.name))?l:[...l,u]),u):null},[]),$=i.useCallback(async n=>{const r=H(n);if(!r)return null;const o=g(r),c=b.find(_=>g(_.name)===o);if(c)return c;const p=M(),{data:x,error:u}=await p.rpc("current_user_group_id");if(u)throw u;if(!x)throw new Error("Could not determine group.");const{data:l,error:k}=await p.from("tags").insert({name:r,tmdb_id:null,group_id:x,is_custom:!0}).select("id,name,is_custom").maybeSingle();if(k){const _=await ee(p,r);if(_)return _;throw k}if(!l||!l.name||typeof l.id!="number")return null;const C={id:l.id,name:l.name,is_custom:!!l.is_custom};return T(_=>_.some(he=>g(he.name)===o)?_:[..._,C]),C},[b,ee]),ue=i.useCallback(async n=>{if(O)return;const r=H(n);if(r){J(!0),y();try{const o=await $(r);o&&w(c=>c.some(x=>g(x.name)===g(o.name))?c:[...c,o]),N("")}catch(o){z(W(o,"Failed to create tag"))}finally{J(!1)}}},[O,$,y]),me=i.useMemo(()=>{const n=g(j);if(!n)return[];const r=new Set(E.map(o=>g(o.name)));return b.filter(o=>{const c=g(o.name);return c.includes(n)&&!r.has(c)})},[b,E,j]),ge=i.useMemo(()=>{const n=g(j);return n?!b.some(r=>g(r.name)===n):!1},[b,j]),fe=i.useCallback(async()=>{if(!(!s||!d)){L(!0),z(null),P(!1);try{let n=E;if(j.trim().length>0){const k=await $(j);k&&(n.some(_=>g(_.name)===g(k.name))||(n=[...n,k]),w(n)),N("")}const r=M(),{data:o,error:c}=await r.rpc("current_user_group_id");if(c)throw c;if(!o)throw new Error("Could not determine group.");const p=I?B??new Date().toISOString():null,{data:x,error:u}=await r.from("entries").update({watched_at:p}).eq("id",s).eq("group_id",o).select("watched_at").maybeSingle();if(u)throw u;if(!x)throw new Error("Unable to update watched status.");q(x?.watched_at??null),F(!!x?.watched_at);const{error:l}=await r.from("entry_tags").delete().eq("entry_id",s);if(l)throw l;if(n.length>0){const{error:k}=await r.from("entry_tags").insert(n.map(C=>({entry_id:s,tag_id:C.id})));if(k)throw k}P(!0),A.current!==null&&window.clearTimeout(A.current),A.current=window.setTimeout(()=>{a("/app/list")},500)}catch(n){z(W(n,"Failed to update tags"))}finally{L(!1)}}},[d,s,$,a,E,j,I,B]),xe=i.useCallback(async()=>{if(!(!s||U||!window.confirm(d?.title?`Delete "${d.title}" from your list?`:"Delete this entry from your list?"))){X(!0),Z(null);try{const r=M(),{error:o}=await r.from("entries").delete().eq("id",s);if(o)throw o;a("/app/list")}catch(r){Z(W(r,"Failed to delete entry"))}finally{X(!1)}}},[U,d?.title,s,a]);return t.jsx(qe,{entry:d,loading:h,error:D,selectedTags:E,availableTags:b,tagQuery:j,suggestions:me,canCreateTag:ge,watched:I,onWatchedChange:ie,onTagQueryChange:oe,onAddTag:le,onRemoveTag:de,onToggleTag:ce,onCreateTag:ue,onSaveTags:fe,saving:R,saveError:K,saveCompleted:se,creatingTag:O,deleting:U,deleteError:ae,onDelete:xe})}const Ge={leftHeaderAction:{to:"/app/list",icon:t.jsx(Ne,{})}};function Je({}){return[{title:"Video Clerk - Edit Entry"},{name:"description",content:"Edit saved list entries and update tags."}]}const Xe=ye(function(){return t.jsx(Pe,{})});export{Xe as default,Ge as handle,Je as meta};
