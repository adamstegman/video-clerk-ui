import{a as n,v as z,t as D,B as E,w as P}from"./chunk-JMJ3UQ3L-DPj_BNs_.js";import{j as a}from"./jsx-runtime-u17CrQMm.js";import{b as L,c as k}from"./tmdb-configuration-BxuIu_6_.js";import{c as T,p as q,s as H,b as I,a as $}from"./utils-ByhHhwOs.js";import{A as F}from"./action-button-BX2IeZ2i.js";import{c as R}from"./client-B_XR4Hye.js";import{a as G}from"./tmdb-genres-CfkZN3qk.js";import{a as U}from"./app-data-provider-CKFs_dDM.js";import{C as O}from"./check-wh8VUCb4.js";import"./createLucideIcon-CMzVMv86.js";function W({result:e,onSave:r,saving:i=!1,saved:d=!1,saveError:h=null}){const s=n.useContext(L),l=s.images.poster_sizes.length>2?2:s.images.poster_sizes.length-1,u=s.images.poster_sizes[l]||s.images.poster_sizes[0];return a.jsxs("div",{className:"flex gap-4 md:gap-6 items-start",children:[e.poster_path&&s.images.secure_base_url&&a.jsx("img",{src:`${s.images.secure_base_url}${u}${e.poster_path}`,alt:e.name,className:"flex-shrink-0 w-16 h-24 object-cover rounded md:w-20 md:h-[120px]"}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("h3",{className:T("font-bold text-base md:text-lg",q),children:e.name}),a.jsxs("p",{className:T("text-sm md:text-base",H),children:[e.release_year," - ",e.media_type_display]}),a.jsx("p",{className:T("text-sm md:text-base",H),children:e.genres.map(v=>v.name).join(", ")}),h&&a.jsx("p",{className:"mt-2 text-sm text-red-500",children:h})]}),a.jsx(F,{onClick:r,disabled:!r,loading:i,completed:d,loadingText:"Saving…",completedText:"Saved",className:"flex-shrink-0",ariaLabel:d?`Saved ${e.name}`:`Save ${e.name}`,children:"Save"})]})}function J({result:e,initiallySaved:r=!1}){const i=n.useContext(k),[d,h]=n.useState(!1),[s,l]=n.useState(!1),[u,v]=n.useState(null),x=s||r,j=async()=>{if(!i)return null;if(e.media_type==="movie"){const c=await i.fetchMovieDetails(e.id);return typeof c.runtime=="number"?c.runtime:null}if(e.media_type==="tv"){const c=await i.fetchTVDetails(e.id),o=(Array.isArray(c.episode_run_time)?c.episode_run_time:[]).filter(m=>typeof m=="number"&&Number.isFinite(m)&&m>0);return o.length===0?null:Math.round(o.reduce((m,b)=>m+b,0)/o.length)}return null},y=async()=>{if(!(d||x)){h(!0),v(null);try{const c=await j(),_=R(),{error:o}=await _.rpc("save_tmdb_result_to_list",{p_tmdb_id:e.id,p_media_type:e.media_type,p_title:e.name,p_adult:e.adult,p_backdrop_path:e.backdrop_path,p_poster_path:e.poster_path,p_original_language:e.original_language,p_overview:e.overview,p_popularity:e.popularity,p_vote_average:e.vote_average,p_vote_count:e.vote_count,p_original_name:e.original_name??null,p_release_date:e.release_date||null,p_origin_country:e.origin_country??null,p_genre_ids:e.genres.map(m=>m.id),p_genre_names:e.genres.map(m=>m.name),p_runtime:c});if(o)throw o;l(!0)}catch(c){console.error(c),v(c instanceof Error?c.message:"Failed to save")}finally{h(!1)}}};return a.jsx(W,{result:e,onSave:y,saving:d,saved:x,saveError:u})}const K="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20viewBox='0%200%20489.04%2035.4'%3e%3cdefs%3e%3cstyle%3e.cls-1{fill:url(%23linear-gradient);}%3c/style%3e%3clinearGradient%20id='linear-gradient'%20y1='17.7'%20x2='489.04'%20y2='17.7'%20gradientUnits='userSpaceOnUse'%3e%3cstop%20offset='0'%20stop-color='%2390cea1'/%3e%3cstop%20offset='0.56'%20stop-color='%233cbec9'/%3e%3cstop%20offset='1'%20stop-color='%2300b3e5'/%3e%3c/linearGradient%3e%3c/defs%3e%3ctitle%3eAsset%205%3c/title%3e%3cg%20id='Layer_2'%20data-name='Layer%202'%3e%3cg%20id='Layer_1-2'%20data-name='Layer%201'%3e%3cpath%20class='cls-1'%20d='M293.5,0h8.9l8.75,23.2h.1L320.15,0h8.35L313.9,35.4h-6.25Zm46.6,0h7.8V35.4h-7.8Zm22.2,0h24.05V7.2H370.1v6.6h15.35V21H370.1v7.2h17.15v7.2H362.3Zm55,0H429a33.54,33.54,0,0,1,8.07,1A18.55,18.55,0,0,1,443.75,4a15.1,15.1,0,0,1,4.52,5.53A18.5,18.5,0,0,1,450,17.8a16.91,16.91,0,0,1-1.63,7.58,16.37,16.37,0,0,1-4.37,5.5,19.52,19.52,0,0,1-6.35,3.37A24.59,24.59,0,0,1,430,35.4H417.29Zm7.81,28.2h4a21.57,21.57,0,0,0,5-.55,10.87,10.87,0,0,0,4-1.83,8.69,8.69,0,0,0,2.67-3.34,11.92,11.92,0,0,0,1-5.08,9.87,9.87,0,0,0-1-4.52,9,9,0,0,0-2.62-3.18,11.68,11.68,0,0,0-3.88-1.88,17.43,17.43,0,0,0-4.67-.62h-4.6ZM461.24,0h13.2a34.42,34.42,0,0,1,4.63.32,12.9,12.9,0,0,1,4.17,1.3,7.88,7.88,0,0,1,3,2.73A8.34,8.34,0,0,1,487.39,9a7.42,7.42,0,0,1-1.67,5,9.28,9.28,0,0,1-4.43,2.82v.1a10,10,0,0,1,3.18,1,8.38,8.38,0,0,1,2.45,1.85,7.79,7.79,0,0,1,1.57,2.62,9.16,9.16,0,0,1,.55,3.2,8.52,8.52,0,0,1-1.2,4.68,9.42,9.42,0,0,1-3.1,3,13.38,13.38,0,0,1-4.27,1.65,23.11,23.11,0,0,1-4.73.5h-14.5ZM469,14.15h5.65a8.16,8.16,0,0,0,1.78-.2A4.78,4.78,0,0,0,478,13.3a3.34,3.34,0,0,0,1.13-1.2,3.63,3.63,0,0,0,.42-1.8,3.22,3.22,0,0,0-.47-1.82,3.33,3.33,0,0,0-1.23-1.13,5.77,5.77,0,0,0-1.7-.58,10.79,10.79,0,0,0-1.85-.17H469Zm0,14.65h7a8.91,8.91,0,0,0,1.83-.2,4.78,4.78,0,0,0,1.67-.7,4,4,0,0,0,1.23-1.3,3.71,3.71,0,0,0,.47-2,3.13,3.13,0,0,0-.62-2A4,4,0,0,0,479,21.45,7.83,7.83,0,0,0,477,20.9a15.12,15.12,0,0,0-2.05-.15H469Zm-265,6.53H271a17.66,17.66,0,0,0,17.66-17.66h0A17.67,17.67,0,0,0,271,0H204.06A17.67,17.67,0,0,0,186.4,17.67h0A17.66,17.66,0,0,0,204.06,35.33ZM10.1,6.9H0V0H28V6.9H17.9V35.4H10.1ZM39,0h7.8V13.2H61.9V0h7.8V35.4H61.9V20.1H46.75V35.4H39ZM80.2,0h24V7.2H88v6.6h15.35V21H88v7.2h17.15v7.2h-25Zm55,0H147l8.15,23.1h.1L163.45,0H175.2V35.4h-7.8V8.25h-.1L158,35.4h-5.95l-9-27.15H143V35.4h-7.8Z'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e";function X({onSearch:e,results:r,savedByMediaType:i,error:d,warning:h,loading:s,initialQuery:l}){const u=n.useRef(null),v=n.useRef(null),x=n.useContext(L),j=z(),[y]=D(),[c,_]=n.useState(l||""),o=d||x.error;n.useEffect(()=>{l!==void 0&&_(l)},[l]);const m=t=>{const p=new URLSearchParams(y);t?p.set("q",t):p.delete("q"),j(`?${p.toString()}`,{replace:!0})},b=(t,p=250)=>{u.current&&clearTimeout(u.current);const g=()=>{m(t||""),e(t||"")};p===0||!t?g():u.current=setTimeout(g,p)},M=t=>{t.preventDefault(),v.current?.blur();const g=new FormData(t.currentTarget).get("q");b(g,0)};return a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:I,children:[a.jsx("p",{className:T("mb-3",$),children:"Search for titles to add to your list"}),a.jsx(E,{onSubmit:M,children:a.jsx("input",{ref:v,type:"search",name:"q",placeholder:"Type a title...",value:c,className:"w-full p-2 border rounded text-black dark:bg-zinc-800 dark:text-zinc-100 dark:border-zinc-600",onChange:t=>{_(t.target.value),b(t.target.value)}})}),o&&a.jsx("div",{className:"mt-2 text-red-500",children:o}),!o&&h&&a.jsx("div",{className:"mt-2 text-sm text-amber-700 dark:text-amber-400",children:h})]}),a.jsxs("div",{className:"flex-1 overflow-y-auto min-h-0 pb-4",children:[s&&!o&&r.length===0&&a.jsx("div",{className:"flex items-center justify-center py-12",children:a.jsxs("div",{className:"flex flex-col items-center gap-4",children:[a.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),a.jsx("p",{className:H,children:"Searching..."})]})}),r.length>0&&!o&&a.jsxs("div",{className:"space-y-4 md:space-y-6",children:[r.map(t=>a.jsx(J,{result:t,initiallySaved:i?.get(t.media_type)?.has(t.id)??!1},`${t.media_type}-${t.id}`)),a.jsxs("div",{className:"flex items-center gap-2 py-4",children:["Results by ",a.jsx("img",{src:K,alt:"TMDB",className:"h-4"})]})]})]})]})}var B=(e=>(e.MOVIE="movie",e.TV="tv",e))(B||{});const Y={movie:"Movie",tv:"TV Series"};function Q(e,r){let i=[];e.media_type==="movie"?i=e.genre_ids.map(s=>r.movieGenres.find(l=>l.id===s)).filter(s=>!!s):e.media_type==="tv"&&(i=e.genre_ids.map(s=>r.tvGenres.find(l=>l.id===s)).filter(s=>!!s));const d=e.release_date||e.first_air_date||"",h=e.name||e.title||"";return{...e,genres:i,media_type:e.media_type,media_type_display:Y[e.media_type],name:h,release_date:d,release_year:d?d.split("-")[0]:""}}function ee({initialQuery:e}){const r=n.useContext(k),i=n.useContext(G),{user:d}=n.useContext(U),[h,s]=n.useState([]),[l,u]=n.useState(null),[v,x]=n.useState(null),[j,y]=n.useState(!1),[c,_]=n.useState(new Map),o=n.useRef(0),m="Couldn't verify whether search results are already saved. Some results may show “Save” even if already saved.",b=async t=>{if(!d)return new Map;const p=Array.from(new Set(t.map(w=>w.id)));if(p.length===0)return new Map;const g=Array.from(new Set(t.map(w=>w.media_type))),f=R(),{data:S,error:C}=await f.from("entries").select("tmdb_id, media_type").in("tmdb_id",p).in("media_type",g);if(C)throw C;const A=new Map;for(const w of S??[]){const V=w.media_type,Z=w.tmdb_id,N=A.get(V)??new Set;N.add(Z),A.set(V,N)}return A},M=n.useCallback(async t=>{if(u(null),!t){s([]),_(new Map),x(null),y(!1);return}if(!r){u("TMDB API is not available. Please refresh the page."),y(!1);return}const p=++o.current;y(!0),_(new Map),x(null);let g=[];try{const f=await r.multiSearch(t);f.results&&(g=f.results.filter(S=>Object.values(B).includes(S.media_type)).map(S=>Q(S,i))),g.sort((S,C)=>C.popularity-S.popularity)}catch(f){console.error(f),f instanceof Error?u(f.message):u("An unexpected error occurred")}s(g),y(!1),b(g).then(f=>{o.current===p&&(_(f),x(null))}).catch(f=>{console.error(f),o.current===p&&(_(new Map),x(m))})},[r,i,d]);return n.useEffect(()=>{e&&M(e)},[e,M]),a.jsx(X,{onSearch:M,results:h,error:l,warning:v,loading:j,initialQuery:e,savedByMediaType:c})}function ae({initialQuery:e}){return a.jsx(ee,{initialQuery:e})}const pe={rightHeaderAction:{to:"/app/list",icon:a.jsx(O,{})}};function he({}){return[{title:"Video Clerk - Add to List"},{name:"description",content:"Add movies and TV shows to your watch list."}]}const ue=P(function(){const[r]=D(),i=r.get("q")||"";return a.jsx(ae,{initialQuery:i})});export{ue as default,pe as handle,he as meta};
