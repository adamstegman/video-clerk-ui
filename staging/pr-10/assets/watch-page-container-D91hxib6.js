import{j as e}from"./jsx-runtime-u17CrQMm.js";import{a as n,C as Q,v as Z}from"./chunk-JMJ3UQ3L-DNRSL2Hf.js";import{c as $}from"./client-B_XR4Hye.js";import{b as ee}from"./tmdb-configuration-CpwZmLCk.js";import{a as te,c as u,s as v,p as B}from"./utils-ByhHhwOs.js";function L(t,c,g){return Math.min(g,Math.max(c,t))}function X(t){return{x:t.clientX,y:t.clientY}}function F({entry:t,isTop:c,style:g,onPointerDown:O,likeOpacity:P,nopeOpacity:z}){const h=n.useContext(ee),w=n.useMemo(()=>{const o=h.images.poster_sizes;if(!o.length)return null;const k=o.length>4?3:o.length-1;return o[k]||o[0]||null},[h.images.poster_sizes]),_=n.useMemo(()=>{const o=h.images.backdrop_sizes;if(!o.length)return null;const k=o.length>2?1:o.length-1;return o[k]||o[0]||null},[h.images.backdrop_sizes]),N=h.images.secure_base_url&&(t.backdropPath||t.posterPath)?t.backdropPath&&_?`${h.images.secure_base_url}${_}${t.backdropPath}`:t.posterPath&&w?`${h.images.secure_base_url}${w}${t.posterPath}`:null:null;return e.jsx("div",{className:u("absolute inset-0 rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 shadow-lg","overflow-hidden select-none touch-none",c?"cursor-grab active:cursor-grabbing":"pointer-events-none"),style:g,onPointerDown:O,role:c?"group":void 0,"aria-label":c?`Swipe card for ${t.title}`:void 0,children:e.jsxs("div",{className:"flex h-full w-full flex-col",children:[e.jsxs("div",{className:"relative w-full flex-none shrink-0 basis-[62%]",children:[N?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:N,alt:t.title,className:"absolute inset-0 h-full w-full object-cover",draggable:!1}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/45 via-black/15 to-black/0"})]}):e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-zinc-900 via-zinc-800 to-zinc-700"}),e.jsx("div",{className:"absolute left-4 top-4 rounded-lg border-2 border-emerald-300 bg-emerald-500/10 px-3 py-1 text-lg font-extrabold tracking-widest text-emerald-100",style:{opacity:P},children:"LIKE"}),e.jsx("div",{className:"absolute right-4 top-4 rounded-lg border-2 border-rose-300 bg-rose-500/10 px-3 py-1 text-lg font-extrabold tracking-widest text-rose-100",style:{opacity:z},children:"NOPE"})]}),e.jsxs("div",{className:"flex-1 min-h-0 border-t border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-5 pt-5 pb-6",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("h3",{className:u("text-xl font-bold",B),children:t.title}),t.releaseYear&&e.jsx("span",{className:u("text-sm",v),children:t.releaseYear})]}),t.overview&&e.jsx("p",{className:u("mt-2 line-clamp-4 text-sm",v),children:t.overview}),e.jsx("p",{className:u("mt-3 text-xs",v),children:t.mediaType==="movie"?"Movie":t.mediaType==="tv"?"TV":t.mediaType})]})]})})}function se({initialEntries:t,loading:c,error:g,onReload:O,winnerEntryId:P,winnerEntry:z,winnerLoading:h,winnerError:w,onGoToWinner:_,onMarkWatched:N,onBackToCards:o}){const[k,I]=n.useState([]),[f,C]=n.useState([]),[y,W]=n.useState(null),[T,D]=n.useState(!1),[r,i]=n.useState(null),[a,b]=n.useState({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null}),p=n.useRef(null),m=()=>{p.current&&(window.clearTimeout(p.current),p.current=null)},M=()=>{m(),I(t),C([]),W(null),i(null),D(!1),b({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null})};n.useEffect(()=>{M()},[t]),n.useEffect(()=>()=>{m()},[]);const x=k[0]??null,q=k.slice(1,4),E=110,j=t.length===0?0:t.length<3?1:3,A=j>0&&f.length>=j&&!a.animatingOut,G=x?L(Math.max(0,a.dx)/E,0,1):0,H=x?L(Math.max(0,-a.dx)/E,0,1):0;function Y(s){if(!x)return;const l=x,S=s==="like"?420:-420;b(d=>({...d,animatingOut:!0,decision:s,dx:S,dy:d.dy,isDragging:!1,activeId:l.id})),s==="like"&&C(d=>d.length>=j?d:[...d,l]),m(),p.current=window.setTimeout(()=>{I(d=>d[0]?.id===l.id?d.slice(1):d.filter(J=>J.id!==l.id)),b({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null}),p.current=null},220)}async function K(s){D(!0),i(null);try{await N(s)}catch(l){const S=l instanceof Error?l.message:typeof l=="object"&&l!==null&&"message"in l&&typeof l.message=="string"?String(l.message):"Failed to mark watched";i(S)}finally{D(!1)}}const V=P!==null;return e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsxs("div",{className:"flex-shrink-0 pb-2 pt-4",children:[e.jsx("h2",{className:te,children:"Watch"}),e.jsx("p",{className:u("mt-1 text-sm",v),children:"Swipe right to like, left to skip. Pick 1 once you have enough likes."})]}),e.jsx("div",{className:"flex-1 min-h-0 pb-4 overflow-y-auto",children:V?e.jsxs("div",{className:"mx-auto w-full max-w-md",children:[h&&e.jsx("p",{className:u("text-sm",v),children:"Loading selectionâ€¦"}),w&&e.jsx("p",{className:"text-sm text-red-500",children:w}),!h&&!w&&z&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:u("mb-3 text-sm",v),children:"Selected to watch:"}),e.jsx("div",{className:"relative h-[520px] md:h-[560px]",children:e.jsx(F,{entry:z,isTop:!1,likeOpacity:0,nopeOpacity:0,style:{zIndex:1,transform:"none",transition:"none"}})}),r&&e.jsx("p",{className:"mt-3 text-sm text-red-500",children:r}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("button",{className:"flex-1 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-4 py-3 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900",onClick:o,disabled:T,children:"Back to cards"}),e.jsx("button",{className:"flex-1 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>void K(z.id),disabled:T,children:T?"Marking...":"Mark as Watched"})]})]})]}):e.jsxs(e.Fragment,{children:[c&&!g&&k.length===0&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),e.jsx("p",{className:v,children:"Loading..."})]})}),g&&e.jsx("p",{className:"text-sm text-red-500",children:g}),!c&&!g&&k.length===0&&f.length<j&&e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 py-12 text-center",children:[e.jsx("p",{className:u("text-sm",v),children:"No unwatched items to swipe on."}),e.jsx("button",{className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500",onClick:()=>void O(),children:"Reload"})]}),A?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:u("text-sm",v),children:["You liked ",f.length,". Pick one to watch:"]}),e.jsx("div",{className:"grid gap-3 md:grid-cols-3",children:(j===1?f:f.slice(0,3)).map(s=>e.jsxs("button",{className:u("rounded-xl border p-4 text-left transition","bg-white dark:bg-zinc-950 border-zinc-200 dark:border-zinc-800 hover:border-indigo-400",y===s.id?"ring-2 ring-indigo-500":""),onClick:()=>W(s.id),children:[e.jsx("div",{className:u("font-semibold",B),children:s.title}),s.releaseYear&&e.jsx("div",{className:u("text-sm",v),children:s.releaseYear}),s.overview&&e.jsx("div",{className:u("mt-2 text-sm line-clamp-3",v),children:s.overview})]},s.id))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"rounded-lg border border-zinc-200 dark:border-zinc-800 px-4 py-2 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900",onClick:()=>{M()},disabled:T,children:"Start over"}),e.jsx("button",{className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>{if(!y)return;const s=f.find(l=>l.id===y);s&&(i(null),_(s))},disabled:!y,children:"Choose winner"})]})]}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-md flex-col",children:[e.jsxs("div",{className:"relative flex-1 min-h-[440px] md:min-h-[520px]",children:[x&&e.jsx(F,{entry:x,isTop:!0,likeOpacity:G,nopeOpacity:H,style:{zIndex:50,transform:`translate3d(${a.dx}px, ${a.dy}px, 0) rotate(${a.dx/14}deg)`,transition:a.isDragging?"none":"transform 220ms ease"},onPointerDown:s=>{if(!x||a.animatingOut||f.length>=j)return;s.currentTarget.setPointerCapture(s.pointerId);const{x:l,y:S}=X(s);b(d=>({...d,activeId:x.id,startX:l,startY:S,dx:0,dy:0,isDragging:!0,animatingOut:!1,decision:null}))}}),q.map((s,l)=>e.jsx(F,{entry:s,isTop:!1,likeOpacity:0,nopeOpacity:0,style:{zIndex:40-l,transform:`translate3d(0, ${10+l*10}px, 0) scale(${1-(l+1)*.03})`,transition:"transform 220ms ease"}},s.id)),e.jsx("div",{className:"absolute inset-0",onPointerMove:s=>{if(!x||!a.isDragging||a.activeId!==x.id)return;const{x:l,y:S}=X(s);b(d=>({...d,dx:l-d.startX,dy:S-d.startY}))},onPointerUp:()=>{if(x&&a.isDragging&&a.activeId===x.id){if(a.dx>E)return Y("like");if(a.dx<-E)return Y("nope");b(s=>({...s,isDragging:!1,dx:0,dy:0}))}},onPointerCancel:()=>{b(s=>({...s,isDragging:!1,dx:0,dy:0}))}})]}),e.jsx("div",{className:"mt-4 flex-shrink-0 pb-2",children:e.jsxs("div",{className:"flex w-full items-center justify-between gap-3",children:[e.jsx("button",{className:"flex-1 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-4 py-3 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900 disabled:opacity-60",onClick:()=>Y("nope"),disabled:!x||a.animatingOut||f.length>=j,children:"Nope"}),e.jsxs("div",{className:u("text-sm",v),children:["Liked: ",e.jsx("span",{className:"font-semibold",children:f.length}),"/",j||3]}),e.jsx("button",{className:"flex-1 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>Y("like"),disabled:!x||a.animatingOut||f.length>=j,children:"Like"})]})})]})})]})})]})}function R(t){return t&&t.split("-")[0]||""}function U(t){return t?Array.isArray(t)?t[0]??null:t:null}function oe(){const t=Q(),c=Z(),g=n.useMemo(()=>{const r=t.entryId;if(!r)return null;const i=Number(r);return Number.isFinite(i)&&i>0?Math.trunc(i):null},[t.entryId]),[O,P]=n.useState([]),[z,h]=n.useState(!0),[w,_]=n.useState(null),[N,o]=n.useState(null),[k,I]=n.useState(!1),[f,C]=n.useState(null),y=n.useCallback(async()=>{h(!0),_(null);try{const r=$(),{data:i,error:a}=await r.from("entries").select(`
            id,
            added_at,
            media_type,
            watched_at,
            tmdb_details (
              poster_path,
              backdrop_path,
              overview,
              name,
              release_date
            )
          `).is("watched_at",null).order("added_at",{ascending:!1}).limit(50);if(a)throw a;const b=(i??[]).map(p=>{const m=U(p.tmdb_details),M=m?.name||"Untitled";return{id:p.id,title:M,overview:m?.overview??null,releaseYear:R(m?.release_date??null),posterPath:m?.poster_path??null,backdropPath:m?.backdrop_path??null,mediaType:p.media_type}});P(b)}catch(r){const i=r instanceof Error?r.message:typeof r=="object"&&r!==null&&"message"in r&&typeof r.message=="string"?String(r.message):"Failed to load watch deck";_(i),P([])}finally{h(!1)}},[]);n.useEffect(()=>((async()=>{await y()})(),()=>{}),[y]);const W=n.useCallback(async r=>{I(!0),C(null);try{const i=$(),{data:a,error:b}=await i.from("entries").select(`
              id,
              added_at,
              media_type,
              watched_at,
              tmdb_details (
                poster_path,
                backdrop_path,
                overview,
                name,
                release_date
              )
            `).eq("id",r).maybeSingle();if(b)throw b;if(!a){o(null),C("Could not find that entry.");return}const p=a,m=U(p.tmdb_details),M=m?.name||"Untitled";o({id:p.id,title:M,overview:m?.overview??null,releaseYear:R(m?.release_date??null),posterPath:m?.poster_path??null,backdropPath:m?.backdrop_path??null,mediaType:p.media_type})}catch(i){const a=i instanceof Error?i.message:typeof i=="object"&&i!==null&&"message"in i&&typeof i.message=="string"?String(i.message):"Failed to load selected entry";o(null),C(a)}finally{I(!1)}},[]);n.useEffect(()=>{if(!g){o(null),C(null),I(!1);return}N?.id!==g&&W(g)},[W,N?.id,g]);const T=n.useCallback(r=>{o(r),c(`/app/watch/${r.id}`)},[c]),D=n.useCallback(async r=>{const i=$(),{error:a}=await i.from("entries").update({watched_at:new Date().toISOString()}).eq("id",r);if(a)throw a;c("/app/watch"),await y()},[y,c]);return e.jsx(se,{initialEntries:O,loading:z,error:w,onReload:y,winnerEntryId:g,winnerEntry:N,winnerLoading:k,winnerError:f,onGoToWinner:T,onMarkWatched:D,onBackToCards:()=>c("/app/watch")})}export{oe as W};
