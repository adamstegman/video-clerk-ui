import{a,C as he,v as pe,w as be}from"./chunk-JMJ3UQ3L-DPj_BNs_.js";import{j as t}from"./jsx-runtime-u17CrQMm.js";import{c as L}from"./client-B_XR4Hye.js";import{A as G}from"./action-button-BX2IeZ2i.js";import{S as te,a as ye}from"./settings-subsection-X7Eq6pXz.js";import{c as N,p as we,s as Y,e as ne,b as V,a as je}from"./utils-ByhHhwOs.js";import{b as ke}from"./tmdb-configuration-BxuIu_6_.js";import{c as _e}from"./createLucideIcon-CMzVMv86.js";const Ee=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],Ne=_e("arrow-left",Ee);function Se({entry:e}){const i=a.useContext(ke),r=i.images.poster_sizes.length>2?2:i.images.poster_sizes.length-1,c=i.images.poster_sizes[r]||i.images.poster_sizes[0];return t.jsxs("div",{className:"flex gap-4 md:gap-6 items-start",children:[e.posterPath&&i.images.secure_base_url&&c&&t.jsx("img",{src:`${i.images.secure_base_url}${c}${e.posterPath}`,alt:e.title,className:"flex-shrink-0 w-16 h-24 object-cover rounded md:w-20 md:h-[120px]"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h3",{className:N("font-bold text-base md:text-lg",we),children:e.title}),e.releaseYear&&t.jsx("p",{className:N("text-sm md:text-base",Y),children:e.releaseYear})]})]})}function ze({watched:e,onWatchedChange:i}){return t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("input",{id:"entry-watched",type:"checkbox",checked:e,onChange:r=>i(r.target.checked),className:"h-4 w-4 rounded border-zinc-300 text-indigo-600 focus:ring-indigo-500 dark:border-zinc-700 dark:bg-zinc-950"}),t.jsx("label",{htmlFor:"entry-watched",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Watched"})]})}function ve({selectedTags:e,onRemoveTag:i}){return t.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.length===0&&t.jsx("p",{className:N("text-sm",Y),children:"No tags selected."}),e.map(r=>t.jsx("button",{type:"button",onClick:()=>i(r),className:"rounded-full border border-indigo-200 bg-indigo-50 px-3 py-1 text-xs font-medium text-indigo-700 hover:bg-indigo-100 dark:border-indigo-700 dark:bg-indigo-950 dark:text-indigo-200","aria-label":`Remove tag ${r.name}`,children:r.name},r.id))]})}function Ce({tagQuery:e,onTagQueryChange:i,onCreateTag:r,creatingTag:c,suggestions:g,canCreateTag:p}){return t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx("label",{htmlFor:"entry-tag-query",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Add tag"}),t.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:[t.jsx("input",{id:"entry-tag-query",value:e,onChange:x=>i(x.target.value),onKeyDown:x=>{if(x.key==="Enter"||x.key==="Tab"||x.key===","){if(e.trim().length===0)return;x.preventDefault(),r(e)}},placeholder:"Type a tag name",className:"w-full rounded-md border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder:text-zinc-400 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-100","aria-autocomplete":"list","aria-expanded":g.length>0||p,"aria-controls":"entry-tag-suggestions"}),t.jsx(G,{onClick:()=>r(e),disabled:e.trim().length===0||c,loading:c,loadingText:"Adding...",variant:"secondary",size:"sm",className:"sm:w-auto",children:"Add"})]})]})}function Te({suggestions:e,canCreateTag:i,tagQuery:r,onCreateTag:c,onAddTag:g}){return e.length===0&&!i?null:t.jsxs("div",{id:"entry-tag-suggestions",role:"listbox",className:"rounded-md border border-zinc-200 bg-white p-2 text-sm shadow-sm dark:border-zinc-700 dark:bg-zinc-900",children:[i&&t.jsxs("button",{type:"button",onClick:()=>c(r),className:"w-full rounded-md px-2 py-1 text-left text-indigo-600 hover:bg-indigo-50 dark:text-indigo-300 dark:hover:bg-indigo-900/40",children:['Create "',r.trim(),'"']}),e.map(p=>t.jsx("button",{type:"button",onClick:()=>g(p),className:"w-full rounded-md px-2 py-1 text-left hover:bg-zinc-100 dark:hover:bg-zinc-800",children:p.name},p.id))]})}function Ae({availableTags:e,selectedTags:i,onToggleTag:r}){return t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx("p",{className:"text-xs font-medium text-zinc-500 dark:text-zinc-400",children:"Existing tags"}),e.length===0?t.jsx("p",{className:N("text-sm",Y),children:"No tags available."}):t.jsx("div",{className:"flex flex-wrap gap-2",children:e.map(c=>{const g=i.some(p=>p.id===c.id);return t.jsx("button",{type:"button",onClick:()=>r(c),"aria-pressed":g,className:N("rounded-full border px-3 py-1 text-xs font-medium transition",g?"border-indigo-400 bg-indigo-500 text-white hover:bg-indigo-400 dark:border-indigo-500 dark:bg-indigo-500":"border-zinc-200 bg-white text-zinc-600 hover:bg-zinc-100 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-200 dark:hover:bg-zinc-800"),children:c.name},c.id)})})]})}function De({deleting:e,deleteError:i,onDelete:r}){return t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx(G,{onClick:r,loading:e,loadingText:"Deleting...",variant:"secondary",className:"border border-red-300 text-red-600 hover:bg-red-50 dark:border-red-700 dark:text-red-400 dark:hover:bg-red-900/20 w-full md:w-auto",children:"Delete entry"}),i&&t.jsx("p",{className:N("text-sm",ne),children:i})]})}function Ie({entry:e,loading:i,error:r,selectedTags:c,availableTags:g,tagQuery:p,suggestions:x,canCreateTag:q,watched:C,onWatchedChange:S,onTagQueryChange:E,onAddTag:k,onRemoveTag:T,onToggleTag:y,onCreateTag:_,onSaveTags:D,saving:I,saveError:R,saveCompleted:F,creatingTag:B,deleting:P,deleteError:K,onDelete:z}){return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:V,children:t.jsx("div",{className:"flex items-center justify-between gap-4",children:t.jsx("h2",{className:je,children:"Edit entry"})})}),t.jsxs("div",{className:"flex-1 overflow-y-auto min-h-0 pb-4",children:[i&&!r&&t.jsx("div",{className:"flex items-center justify-center py-12",children:t.jsxs("div",{className:"flex flex-col items-center gap-4",children:[t.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),t.jsx("p",{className:Y,children:"Loading entry..."})]})}),r&&t.jsx("p",{className:N("text-sm",ne),children:r}),!i&&!r&&e&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:V,children:t.jsx(Se,{entry:e})}),t.jsx(te,{title:"Status",children:t.jsx(ze,{watched:C,onWatchedChange:S})}),t.jsx(te,{title:"Tags",children:t.jsxs(ye,{description:"",error:R,children:[t.jsx(ve,{selectedTags:c,onRemoveTag:T}),t.jsx(Ce,{tagQuery:p,onTagQueryChange:E,onCreateTag:_,creatingTag:B,suggestions:x,canCreateTag:q}),t.jsx(Te,{suggestions:x,canCreateTag:q,tagQuery:p,onCreateTag:_,onAddTag:k}),t.jsx(Ae,{availableTags:g,selectedTags:c,onToggleTag:y})]})}),t.jsxs("div",{className:N(V,"flex flex-col gap-3 md:flex-row md:items-start md:justify-between"),children:[t.jsx(De,{deleting:P,deleteError:K,onDelete:z}),t.jsx(G,{onClick:D,loading:I,disabled:!e||B,loadingText:"Saving...",completed:F,completedText:"Saved!",className:"w-full md:w-auto md:ml-auto",children:"Save"})]})]})]})]})}function Fe(e){return e&&e.split("-")[0]||""}function qe(e){return e?Array.isArray(e)?e[0]??null:e:null}function Re(e){return e?Array.isArray(e)?e[0]??null:e:null}function m(e){return H(e).toLowerCase()}function H(e){return e.trim().replace(/\s+/g," ")}function $(e,i){return e instanceof Error?e.message:typeof e=="object"&&e!==null&&"message"in e&&typeof e.message=="string"?String(e.message):i}function Be(){const e=he(),i=pe(),r=a.useMemo(()=>{const n=e.entryId;if(!n)return null;const s=Number(n);return Number.isFinite(s)&&s>0?Math.trunc(s):null},[e.entryId]),[c,g]=a.useState(null),[p,x]=a.useState(!0),[q,C]=a.useState(null),[S,E]=a.useState([]),[k,T]=a.useState([]),[y,_]=a.useState(""),[D,I]=a.useState(!1),[R,F]=a.useState(null),[B,P]=a.useState(!1),[K,z]=a.useState(null),[se,M]=a.useState(!1),[O,J]=a.useState(!1),[U,X]=a.useState(!1),[re,Z]=a.useState(null),Q=a.useCallback(async()=>{if(!r){g(null),C("Invalid entry."),x(!1);return}x(!0),C(null);try{const n=L(),[s,o]=await Promise.all([n.from("entries").select(`
              id,
              added_at,
              watched_at,
              tmdb_details (
                poster_path,
                name,
                release_date
              ),
              entry_tags (
                tags (
                  id,
                  name,
                  is_custom
                )
              )
            `).eq("id",r).maybeSingle(),n.from("tags").select("id,name,is_custom").order("name")]);if(s.error)throw s.error;if(!s.data){g(null),C("Entry not found.");return}if(o.error)console.error("Failed to load tags",o.error),T([]);else{const u=o.data?.filter(l=>l.name&&typeof l.id=="number").map(l=>({id:l.id,name:l.name,is_custom:!!l.is_custom}))??[];T(u)}const d=s.data,h=qe(d.tmdb_details),f=d.entry_tags?.map(u=>Re(u.tags)).filter(u=>!!u&&typeof u.id=="number"&&!!u.name).map(u=>({id:u.id,name:u.name,is_custom:!!u.is_custom}))??[];g({id:d.id,title:h?.name||"Untitled",releaseYear:Fe(h?.release_date??null),posterPath:h?.poster_path??null}),E(f),I(!!d.watched_at),F(d.watched_at??null)}catch(n){g(null),C($(n,"Failed to load entry"))}finally{x(!1)}},[r]);a.useEffect(()=>{Q()},[Q]);const A=a.useRef(null);a.useEffect(()=>{c&&(_(""),z(null),M(!1))},[c?.id]),a.useEffect(()=>()=>{A.current!==null&&(window.clearTimeout(A.current),A.current=null)},[]);const b=a.useCallback(()=>{z(null),M(!1)},[]),ae=a.useCallback(n=>{I(n),F(s=>n?s??new Date().toISOString():null),b()},[b]),ie=a.useCallback(n=>{_(n),b()},[b]),oe=a.useCallback(n=>{E(s=>s.some(d=>m(d.name)===m(n.name))?s:[...s,n]),_(""),b()},[b]),le=a.useCallback(n=>{E(s=>s.filter(o=>o.id!==n.id)),b()},[b]),de=a.useCallback(n=>{E(s=>s.some(d=>d.id===n.id)?s.filter(d=>d.id!==n.id):[...s,n]),_(""),b()},[b]),ee=a.useCallback(async(n,s)=>{const o=H(s);if(!o)return null;const{data:d,error:h}=await n.from("tags").select("id,name,is_custom").ilike("name",o);if(h)throw h;const f=d?.filter(l=>l.name&&typeof l.id=="number").map(l=>({id:l.id,name:l.name,is_custom:!!l.is_custom}))??[];if(f.length===0)return null;const u=f.find(l=>l.is_custom)??f[0]??null;return u?(T(l=>l.some(v=>m(v.name)===m(u.name))?l:[...l,u]),u):null},[]),W=a.useCallback(async n=>{const s=H(n);if(!s)return null;const o=m(s),d=k.find(j=>m(j.name)===o);if(d)return d;const h=L(),{data:f,error:u}=await h.rpc("current_user_group_id");if(u)throw u;if(!f)throw new Error("Could not determine group.");const{data:l,error:w}=await h.from("tags").insert({name:s,tmdb_id:null,group_id:f,is_custom:!0}).select("id,name,is_custom").maybeSingle();if(w){const j=await ee(h,s);if(j)return j;throw w}if(!l||!l.name||typeof l.id!="number")return null;const v={id:l.id,name:l.name,is_custom:!!l.is_custom};return T(j=>j.some(xe=>m(xe.name)===o)?j:[...j,v]),v},[k,ee]),ce=a.useCallback(async n=>{if(O)return;const s=H(n);if(s){J(!0),b();try{const o=await W(s);o&&E(d=>d.some(f=>m(f.name)===m(o.name))?d:[...d,o]),_("")}catch(o){z($(o,"Failed to create tag"))}finally{J(!1)}}},[O,W,b]),ue=a.useMemo(()=>{const n=m(y);if(!n)return[];const s=new Set(S.map(o=>m(o.name)));return k.filter(o=>{const d=m(o.name);return d.includes(n)&&!s.has(d)})},[k,S,y]),me=a.useMemo(()=>{const n=m(y);return n?!k.some(s=>m(s.name)===n):!1},[k,y]),fe=a.useCallback(async()=>{if(!(!r||!c)){P(!0),z(null),M(!1);try{let n=S;if(y.trim().length>0){const w=await W(y);w&&(n.some(j=>m(j.name)===m(w.name))||(n=[...n,w]),E(n)),_("")}const s=L(),{data:o,error:d}=await s.rpc("current_user_group_id");if(d)throw d;if(!o)throw new Error("Could not determine group.");const h=D?R??new Date().toISOString():null,{data:f,error:u}=await s.from("entries").update({watched_at:h}).eq("id",r).eq("group_id",o).select("watched_at").maybeSingle();if(u)throw u;if(!f)throw new Error("Unable to update watched status.");F(f?.watched_at??null),I(!!f?.watched_at);const{error:l}=await s.from("entry_tags").delete().eq("entry_id",r);if(l)throw l;if(n.length>0){const{error:w}=await s.from("entry_tags").insert(n.map(v=>({entry_id:r,tag_id:v.id})));if(w)throw w}M(!0),A.current!==null&&window.clearTimeout(A.current),A.current=window.setTimeout(()=>{i("/app/list")},500)}catch(n){z($(n,"Failed to update tags"))}finally{P(!1)}}},[c,r,W,i,S,y,D,R]),ge=a.useCallback(async()=>{if(!(!r||U||!window.confirm(c?.title?`Delete "${c.title}" from your list?`:"Delete this entry from your list?"))){X(!0),Z(null);try{const s=L(),{error:o}=await s.from("entries").delete().eq("id",r);if(o)throw o;i("/app/list")}catch(s){Z($(s,"Failed to delete entry"))}finally{X(!1)}}},[U,c?.title,r,i]);return t.jsx(Ie,{entry:c,loading:p,error:q,selectedTags:S,availableTags:k,tagQuery:y,suggestions:ue,canCreateTag:me,watched:D,onWatchedChange:ae,onTagQueryChange:ie,onAddTag:oe,onRemoveTag:le,onToggleTag:de,onCreateTag:ce,onSaveTags:fe,saving:B,saveError:K,saveCompleted:se,creatingTag:O,deleting:U,deleteError:re,onDelete:ge})}const Ue={leftHeaderAction:{to:"/app/list",icon:t.jsx(Ne,{})}};function Ve({}){return[{title:"Video Clerk - Edit Entry"},{name:"description",content:"Edit saved list entries and update tags."}]}const Ge=be(function(){return t.jsx(Be,{})});export{Ge as default,Ue as handle,Ve as meta};
