import{a as i,C as he,v as pe,w as be}from"./chunk-JMJ3UQ3L-DPj_BNs_.js";import{j as t}from"./jsx-runtime-u17CrQMm.js";import{c as L}from"./client-B_XR4Hye.js";import{A as G}from"./action-button-BX2IeZ2i.js";import{c as v,p as ye,s as Y,e as te,b as V,a as we}from"./utils-ByhHhwOs.js";import{b as je}from"./tmdb-configuration-BxuIu_6_.js";import{S as ne,a as ke}from"./settings-subsection-X7Eq6pXz.js";import{c as _e}from"./createLucideIcon-CMzVMv86.js";const Ee=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],Ne=_e("arrow-left",Ee);function Se({entry:e}){const a=i.useContext(je),r=a.images.poster_sizes.length>2?2:a.images.poster_sizes.length-1,d=a.images.poster_sizes[r]||a.images.poster_sizes[0];return t.jsxs("div",{className:"flex gap-4 md:gap-6 items-start",children:[e.posterPath&&a.images.secure_base_url&&d&&t.jsx("img",{src:`${a.images.secure_base_url}${d}${e.posterPath}`,alt:e.title,className:"flex-shrink-0 w-16 h-24 object-cover rounded md:w-20 md:h-[120px]"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h3",{className:v("font-bold text-base md:text-lg",ye),children:e.title}),e.releaseYear&&t.jsx("p",{className:v("text-sm md:text-base",Y),children:e.releaseYear})]})]})}function ve({watched:e,onWatchedChange:a}){return t.jsx(ne,{title:"Status",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("input",{id:"entry-watched",type:"checkbox",checked:e,onChange:r=>a(r.target.checked),className:"h-4 w-4 rounded border-zinc-300 text-indigo-600 focus:ring-indigo-500 dark:border-zinc-700 dark:bg-zinc-950"}),t.jsx("label",{htmlFor:"entry-watched",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Watched"})]})})}function ze({tag:e,onRemove:a}){return t.jsx("button",{type:"button",onClick:()=>a(e),className:"rounded-full border border-indigo-200 bg-indigo-50 px-3 py-1 text-xs font-medium text-indigo-700 hover:bg-indigo-100 dark:border-indigo-700 dark:bg-indigo-950 dark:text-indigo-200","aria-label":`Remove tag ${e.name}`,children:e.name})}function Ce({selectedTags:e,onRemoveTag:a}){return t.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.length===0&&t.jsx("p",{className:v("text-sm",Y),children:"No tags selected."}),e.map(r=>t.jsx(ze,{tag:r,onRemove:a},r.id))]})}function Te({tagQuery:e,onTagQueryChange:a,onCreateTag:r,creatingTag:d,suggestions:m,canCreateTag:h}){return t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx("label",{htmlFor:"entry-tag-query",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Add tag"}),t.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:[t.jsx("input",{id:"entry-tag-query",value:e,onChange:g=>a(g.target.value),onKeyDown:g=>{if(g.key==="Enter"||g.key==="Tab"||g.key===","){if(e.trim().length===0)return;g.preventDefault(),r(e)}},placeholder:"Type a tag name",className:"w-full rounded-md border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder:text-zinc-400 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-100","aria-autocomplete":"list","aria-expanded":m.length>0||h,"aria-controls":"entry-tag-suggestions"}),t.jsx(G,{onClick:()=>r(e),disabled:e.trim().length===0||d,loading:d,loadingText:"Adding...",variant:"secondary",size:"sm",className:"sm:w-auto",children:"Add"})]})]})}function Ae({suggestions:e,canCreateTag:a,tagQuery:r,onCreateTag:d,onAddTag:m}){return e.length===0&&!a?null:t.jsxs("div",{id:"entry-tag-suggestions",role:"listbox",className:"rounded-md border border-zinc-200 bg-white p-2 text-sm shadow-sm dark:border-zinc-700 dark:bg-zinc-900",children:[a&&t.jsxs("button",{type:"button",onClick:()=>d(r),className:"w-full rounded-md px-2 py-1 text-left text-indigo-600 hover:bg-indigo-50 dark:text-indigo-300 dark:hover:bg-indigo-900/40",children:['Create "',r.trim(),'"']}),e.map(h=>t.jsx("button",{type:"button",onClick:()=>m(h),className:"w-full rounded-md px-2 py-1 text-left hover:bg-zinc-100 dark:hover:bg-zinc-800",children:h.name},h.id))]})}function De({availableTags:e,selectedTags:a,onToggleTag:r}){return t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx("p",{className:"text-xs font-medium text-zinc-500 dark:text-zinc-400",children:"Existing tags"}),e.length===0?t.jsx("p",{className:v("text-sm",Y),children:"No tags available."}):t.jsx("div",{className:"flex flex-wrap gap-2",children:e.map(d=>{const m=a.some(h=>h.id===d.id);return t.jsx("button",{type:"button",onClick:()=>r(d),"aria-pressed":m,className:v("rounded-full border px-3 py-1 text-xs font-medium transition",m?"border-indigo-400 bg-indigo-500 text-white hover:bg-indigo-400 dark:border-indigo-500 dark:bg-indigo-500":"border-zinc-200 bg-white text-zinc-600 hover:bg-zinc-100 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-200 dark:hover:bg-zinc-800"),children:d.name},d.id)})})]})}function Ie({selectedTags:e,availableTags:a,tagQuery:r,suggestions:d,canCreateTag:m,creatingTag:h,saveError:g,onTagQueryChange:D,onAddTag:N,onRemoveTag:E,onToggleTag:w,onCreateTag:b}){return t.jsx(ne,{title:"Tags",children:t.jsxs(ke,{description:"",error:g,children:[t.jsx(Ce,{selectedTags:e,onRemoveTag:E}),t.jsx(Te,{tagQuery:r,onTagQueryChange:D,onCreateTag:b,creatingTag:h,suggestions:d,canCreateTag:m}),t.jsx(Ae,{suggestions:d,canCreateTag:m,tagQuery:r,onCreateTag:b,onAddTag:N}),t.jsx(De,{availableTags:a,selectedTags:e,onToggleTag:w})]})})}function Fe({deleting:e,deleteError:a,onDelete:r}){return t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx(G,{onClick:r,loading:e,loadingText:"Deleting...",variant:"secondary",className:"border border-red-300 text-red-600 hover:bg-red-50 dark:border-red-700 dark:text-red-400 dark:hover:bg-red-900/20 w-full md:w-auto",children:"Delete entry"}),a&&t.jsx("p",{className:v("text-sm",te),children:a})]})}function Re({entry:e,loading:a,error:r,selectedTags:d,availableTags:m,tagQuery:h,suggestions:g,canCreateTag:D,watched:N,onWatchedChange:E,onTagQueryChange:w,onAddTag:b,onRemoveTag:T,onToggleTag:j,onCreateTag:S,onSaveTags:I,saving:F,saveError:q,saveCompleted:R,creatingTag:B,deleting:P,deleteError:K,onDelete:z}){return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:V,children:t.jsx("div",{className:"flex items-center justify-between gap-4",children:t.jsx("h2",{className:we,children:"Edit entry"})})}),t.jsxs("div",{className:"flex-1 overflow-y-auto min-h-0 pb-4",children:[a&&!r&&t.jsx("div",{className:"flex items-center justify-center py-12",children:t.jsxs("div",{className:"flex flex-col items-center gap-4",children:[t.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),t.jsx("p",{className:Y,children:"Loading entry..."})]})}),r&&t.jsx("p",{className:v("text-sm",te),children:r}),!a&&!r&&e&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:V,children:t.jsx(Se,{entry:e})}),t.jsx(ve,{watched:N,onWatchedChange:E}),t.jsx(Ie,{selectedTags:d,availableTags:m,tagQuery:h,suggestions:g,canCreateTag:D,creatingTag:B,saveError:q,onTagQueryChange:w,onAddTag:b,onRemoveTag:T,onToggleTag:j,onCreateTag:S}),t.jsxs("div",{className:v(V,"flex flex-col gap-3 md:flex-row md:items-start md:justify-between"),children:[t.jsx(Fe,{deleting:P,deleteError:K,onDelete:z}),t.jsx(G,{onClick:I,loading:F,disabled:!e||B,loadingText:"Saving...",completed:R,completedText:"Saved!",className:"w-full md:w-auto md:ml-auto",children:"Save"})]})]})]})]})}function qe(e){return e&&e.split("-")[0]||""}function Be(e){return e?Array.isArray(e)?e[0]??null:e:null}function Pe(e){return e?Array.isArray(e)?e[0]??null:e:null}function f(e){return H(e).toLowerCase()}function H(e){return e.trim().replace(/\s+/g," ")}function $(e,a){return e instanceof Error?e.message:typeof e=="object"&&e!==null&&"message"in e&&typeof e.message=="string"?String(e.message):a}function Me(){const e=he(),a=pe(),r=i.useMemo(()=>{const n=e.entryId;if(!n)return null;const s=Number(n);return Number.isFinite(s)&&s>0?Math.trunc(s):null},[e.entryId]),[d,m]=i.useState(null),[h,g]=i.useState(!0),[D,N]=i.useState(null),[E,w]=i.useState([]),[b,T]=i.useState([]),[j,S]=i.useState(""),[I,F]=i.useState(!1),[q,R]=i.useState(null),[B,P]=i.useState(!1),[K,z]=i.useState(null),[se,M]=i.useState(!1),[O,J]=i.useState(!1),[U,X]=i.useState(!1),[re,Z]=i.useState(null),Q=i.useCallback(async()=>{if(!r){m(null),N("Invalid entry."),g(!1);return}g(!0),N(null);try{const n=L(),[s,o]=await Promise.all([n.from("entries").select(`
              id,
              added_at,
              watched_at,
              tmdb_details (
                poster_path,
                name,
                release_date
              ),
              entry_tags (
                tags (
                  id,
                  name,
                  is_custom
                )
              )
            `).eq("id",r).maybeSingle(),n.from("tags").select("id,name,is_custom").order("name")]);if(s.error)throw s.error;if(!s.data){m(null),N("Entry not found.");return}if(o.error)console.error("Failed to load tags",o.error),T([]);else{const u=o.data?.filter(l=>l.name&&typeof l.id=="number").map(l=>({id:l.id,name:l.name,is_custom:!!l.is_custom}))??[];T(u)}const c=s.data,p=Be(c.tmdb_details),x=c.entry_tags?.map(u=>Pe(u.tags)).filter(u=>!!u&&typeof u.id=="number"&&!!u.name).map(u=>({id:u.id,name:u.name,is_custom:!!u.is_custom}))??[];m({id:c.id,title:p?.name||"Untitled",releaseYear:qe(p?.release_date??null),posterPath:p?.poster_path??null}),w(x),F(!!c.watched_at),R(c.watched_at??null)}catch(n){m(null),N($(n,"Failed to load entry"))}finally{g(!1)}},[r]);i.useEffect(()=>{Q()},[Q]);const A=i.useRef(null);i.useEffect(()=>{d&&(S(""),z(null),M(!1))},[d?.id]),i.useEffect(()=>()=>{A.current!==null&&(window.clearTimeout(A.current),A.current=null)},[]);const y=i.useCallback(()=>{z(null),M(!1)},[]),ae=i.useCallback(n=>{F(n),R(s=>n?s??new Date().toISOString():null),y()},[y]),ie=i.useCallback(n=>{S(n),y()},[y]),oe=i.useCallback(n=>{w(s=>s.some(c=>f(c.name)===f(n.name))?s:[...s,n]),S(""),y()},[y]),le=i.useCallback(n=>{w(s=>s.filter(o=>o.id!==n.id)),y()},[y]),de=i.useCallback(n=>{w(s=>s.some(c=>c.id===n.id)?s.filter(c=>c.id!==n.id):[...s,n]),S(""),y()},[y]),ee=i.useCallback(async(n,s)=>{const o=H(s);if(!o)return null;const{data:c,error:p}=await n.from("tags").select("id,name,is_custom").ilike("name",o);if(p)throw p;const x=c?.filter(l=>l.name&&typeof l.id=="number").map(l=>({id:l.id,name:l.name,is_custom:!!l.is_custom}))??[];if(x.length===0)return null;const u=x.find(l=>l.is_custom)??x[0]??null;return u?(T(l=>l.some(C=>f(C.name)===f(u.name))?l:[...l,u]),u):null},[]),W=i.useCallback(async n=>{const s=H(n);if(!s)return null;const o=f(s),c=b.find(_=>f(_.name)===o);if(c)return c;const p=L(),{data:x,error:u}=await p.rpc("current_user_group_id");if(u)throw u;if(!x)throw new Error("Could not determine group.");const{data:l,error:k}=await p.from("tags").insert({name:s,tmdb_id:null,group_id:x,is_custom:!0}).select("id,name,is_custom").maybeSingle();if(k){const _=await ee(p,s);if(_)return _;throw k}if(!l||!l.name||typeof l.id!="number")return null;const C={id:l.id,name:l.name,is_custom:!!l.is_custom};return T(_=>_.some(xe=>f(xe.name)===o)?_:[..._,C]),C},[b,ee]),ce=i.useCallback(async n=>{if(O)return;const s=H(n);if(s){J(!0),y();try{const o=await W(s);o&&w(c=>c.some(x=>f(x.name)===f(o.name))?c:[...c,o]),S("")}catch(o){z($(o,"Failed to create tag"))}finally{J(!1)}}},[O,W,y]),ue=i.useMemo(()=>{const n=f(j);if(!n)return[];const s=new Set(E.map(o=>f(o.name)));return b.filter(o=>{const c=f(o.name);return c.includes(n)&&!s.has(c)})},[b,E,j]),me=i.useMemo(()=>{const n=f(j);return n?!b.some(s=>f(s.name)===n):!1},[b,j]),fe=i.useCallback(async()=>{if(!(!r||!d)){P(!0),z(null),M(!1);try{let n=E;if(j.trim().length>0){const k=await W(j);k&&(n.some(_=>f(_.name)===f(k.name))||(n=[...n,k]),w(n)),S("")}const s=L(),{data:o,error:c}=await s.rpc("current_user_group_id");if(c)throw c;if(!o)throw new Error("Could not determine group.");const p=I?q??new Date().toISOString():null,{data:x,error:u}=await s.from("entries").update({watched_at:p}).eq("id",r).eq("group_id",o).select("watched_at").maybeSingle();if(u)throw u;if(!x)throw new Error("Unable to update watched status.");R(x?.watched_at??null),F(!!x?.watched_at);const{error:l}=await s.from("entry_tags").delete().eq("entry_id",r);if(l)throw l;if(n.length>0){const{error:k}=await s.from("entry_tags").insert(n.map(C=>({entry_id:r,tag_id:C.id})));if(k)throw k}M(!0),A.current!==null&&window.clearTimeout(A.current),A.current=window.setTimeout(()=>{a("/app/list")},500)}catch(n){z($(n,"Failed to update tags"))}finally{P(!1)}}},[d,r,W,a,E,j,I,q]),ge=i.useCallback(async()=>{if(!(!r||U||!window.confirm(d?.title?`Delete "${d.title}" from your list?`:"Delete this entry from your list?"))){X(!0),Z(null);try{const s=L(),{error:o}=await s.from("entries").delete().eq("id",r);if(o)throw o;a("/app/list")}catch(s){Z($(s,"Failed to delete entry"))}finally{X(!1)}}},[U,d?.title,r,a]);return t.jsx(Re,{entry:d,loading:h,error:D,selectedTags:E,availableTags:b,tagQuery:j,suggestions:ue,canCreateTag:me,watched:I,onWatchedChange:ae,onTagQueryChange:ie,onAddTag:oe,onRemoveTag:le,onToggleTag:de,onCreateTag:ce,onSaveTags:fe,saving:B,saveError:K,saveCompleted:se,creatingTag:O,deleting:U,deleteError:re,onDelete:ge})}const Ge={leftHeaderAction:{to:"/app/list",icon:t.jsx(Ne,{})}};function Je({}){return[{title:"Video Clerk - Edit Entry"},{name:"description",content:"Edit saved list entries and update tags."}]}const Xe=be(function(){return t.jsx(Me,{})});export{Xe as default,Ge as handle,Je as meta};
