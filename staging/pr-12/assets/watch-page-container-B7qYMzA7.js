import{j as e}from"./jsx-runtime-u17CrQMm.js";import{a as l,C as ce,v as de,D as ue}from"./chunk-JMJ3UQ3L-DPj_BNs_.js";import{c as A}from"./client-B_XR4Hye.js";import{b as me}from"./tmdb-configuration-BxuIu_6_.js";import{a as ge,c as f,s as y,p as te}from"./utils-ByhHhwOs.js";function J(n,d,x){return Math.min(x,Math.max(d,n))}function B(n){return{x:n.clientX,y:n.clientY}}function U(n){return{x:n.clientX,y:n.clientY}}function q(n,d){for(let x=0;x<n.length;x+=1){const p=n.item(x);if(p&&p.identifier===d)return p}return null}function G({entry:n,isTop:d,style:x,onPointerDown:p,onPointerMove:O,onPointerUp:T,onPointerCancel:M,onTouchStart:C,onTouchMove:Y,onTouchEnd:W,onTouchCancel:I,likeOpacity:k,nopeOpacity:j}){const c=l.useContext(me),N=l.useMemo(()=>{const g=c.images.poster_sizes;if(!g.length)return null;const z=g.length>4?3:g.length-1;return g[z]||g[0]||null},[c.images.poster_sizes]),_=l.useMemo(()=>{const g=c.images.backdrop_sizes;if(!g.length)return null;const z=g.length>2?1:g.length-1;return g[z]||g[0]||null},[c.images.backdrop_sizes]),w=c.images.secure_base_url&&(n.backdropPath||n.posterPath)?n.backdropPath&&_?`${c.images.secure_base_url}${_}${n.backdropPath}`:n.posterPath&&N?`${c.images.secure_base_url}${N}${n.posterPath}`:null:null,b=n.mediaType==="movie"?"Movie":n.mediaType==="tv"?"TV":n.mediaType,P=n.tags.length>0?` | ${n.tags.join(", ")}`:"";return e.jsx("div",{className:f("absolute inset-0 rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 shadow-lg","overflow-hidden select-none touch-none",d?"cursor-grab active:cursor-grabbing":"pointer-events-none"),style:x,onPointerDown:p,onPointerMove:O,onPointerUp:T,onPointerCancel:M,onTouchStart:C,onTouchMove:Y,onTouchEnd:W,onTouchCancel:I,role:d?"group":void 0,"aria-label":d?`Swipe card for ${n.title}`:void 0,children:e.jsxs("div",{className:"flex h-full w-full flex-col",children:[e.jsxs("div",{className:"relative w-full flex-none shrink-0 basis-[62%]",children:[w?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:w,alt:n.title,className:"absolute inset-0 h-full w-full object-cover",draggable:!1}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/45 via-black/15 to-black/0"})]}):e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-zinc-900 via-zinc-800 to-zinc-700"}),e.jsx("div",{className:"absolute left-4 top-4 rounded-lg border-2 border-emerald-300 bg-emerald-500/10 px-3 py-1 text-lg font-extrabold tracking-widest text-emerald-100",style:{opacity:k},children:"LIKE"}),e.jsx("div",{className:"absolute right-4 top-4 rounded-lg border-2 border-rose-300 bg-rose-500/10 px-3 py-1 text-lg font-extrabold tracking-widest text-rose-100",style:{opacity:j},children:"NOPE"})]}),e.jsxs("div",{className:"flex-1 min-h-0 border-t border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-5 pt-5 pb-6",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("h3",{className:f("text-xl font-bold",te),children:n.title}),n.releaseYear&&e.jsx("span",{className:f("text-sm",y),children:n.releaseYear})]}),n.overview&&e.jsx("p",{className:f("mt-2 line-clamp-4 text-sm",y),children:n.overview}),e.jsxs("p",{className:f("mt-3 text-xs",y),children:[b,P]})]})]})})}function he({initialEntries:n,loading:d,error:x,onReload:p,winnerEntryId:O,winnerEntry:T,winnerLoading:M,winnerError:C,onGoToWinner:Y,onMarkWatched:W,onBackToCards:I}){const[k,j]=l.useState([]),[c,N]=l.useState([]),[_,w]=l.useState(null),[b,P]=l.useState(!1),[g,z]=l.useState(null),[a,i]=l.useState({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null}),h=l.useRef(null),u=l.useRef({id:null,type:null}),v=()=>{j(n),N([]),w(null),z(null),P(!1),u.current={id:null,type:null},i({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null})};l.useEffect(()=>{v()},[n]),l.useEffect(()=>()=>{h.current&&window.clearTimeout(h.current)},[]);const r=k[0]??null,$=k.slice(1,4),D=110,m=n.length===0?0:n.length<3?1:3,ne=m>0&&c.length>=m,F=!!r&&a.activeId===r.id,L=F?a.dx:0,se=F?a.dy:0,ae=r?J(Math.max(0,L)/D,0,1):0,re=r?J(Math.max(0,-L)/D,0,1):0,H=(t,s,o)=>!r||a.animatingOut||c.length>=m||a.isDragging||u.current.id!==null?!1:(u.current={id:s,type:o},i(S=>({...S,activeId:r.id,startX:t.x,startY:t.y,dx:0,dy:0,isDragging:!0,animatingOut:!1,decision:null})),!0),K=(t,s,o)=>{if(!r||!a.isDragging||a.activeId!==r.id)return;const S=u.current;S.id!==s||S.type!==o||i(E=>({...E,dx:t.x-E.startX,dy:t.y-E.startY}))},V=(t,s,o)=>{const S=u.current;if(S.id!==s||S.type!==o||(u.current={id:null,type:null},!r)||!a.isDragging||a.activeId!==r.id)return;const E=t.x-a.startX;if(E>D)return X("like");if(E<-D)return X("nope");i(oe=>({...oe,isDragging:!1,dx:0,dy:0}))},R=t=>{u.current.type===t&&(u.current={id:null,type:null},i(s=>({...s,isDragging:!1,dx:0,dy:0})))};function X(t){if(!r)return;u.current={id:null,type:null};const s=t==="like"?420:-420;i(o=>({...o,animatingOut:!0,decision:t,dx:s,dy:o.dy,isDragging:!1,activeId:r.id})),h.current&&window.clearTimeout(h.current),h.current=window.setTimeout(()=>{j(o=>o.slice(1)),t==="like"&&N(o=>o.length>=m?o:[...o,r]),i({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null})},220)}async function ie(t){P(!0),z(null);try{await W(t)}catch(s){const o=s instanceof Error?s.message:typeof s=="object"&&s!==null&&"message"in s&&typeof s.message=="string"?String(s.message):"Failed to mark watched";z(o)}finally{P(!1)}}const le=O!==null;return e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsxs("div",{className:"flex-shrink-0 pb-2 pt-4",children:[e.jsx("h2",{className:ge,children:"Watch"}),e.jsx("p",{className:f("mt-1 text-sm",y),children:"Swipe right to like, left to skip. Pick 1 once you have enough likes."})]}),e.jsx("div",{className:"flex-1 min-h-0 pb-4 overflow-y-auto",children:le?e.jsxs("div",{className:"mx-auto w-full max-w-md",children:[M&&e.jsx("p",{className:f("text-sm",y),children:"Loading selectionâ€¦"}),C&&e.jsx("p",{className:"text-sm text-red-500",children:C}),!M&&!C&&T&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:f("mb-3 text-sm",y),children:"Selected to watch:"}),e.jsx("div",{className:"relative h-[520px] md:h-[560px]",children:e.jsx(G,{entry:T,isTop:!1,likeOpacity:0,nopeOpacity:0,style:{zIndex:1,transform:"none",transition:"none"}})}),g&&e.jsx("p",{className:"mt-3 text-sm text-red-500",children:g}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("button",{className:"flex-1 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-4 py-3 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900",onClick:I,disabled:b,children:"Back to cards"}),e.jsx("button",{className:"flex-1 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>void ie(T.id),disabled:b,children:b?"Marking...":"Mark as Watched"})]})]})]}):e.jsxs(e.Fragment,{children:[d&&!x&&k.length===0&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),e.jsx("p",{className:y,children:"Loading..."})]})}),x&&e.jsx("p",{className:"text-sm text-red-500",children:x}),!d&&!x&&k.length===0&&c.length<m&&e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 py-12 text-center",children:[e.jsx("p",{className:f("text-sm",y),children:"No unwatched items to swipe on."}),e.jsx("button",{className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500",onClick:()=>void p(),children:"Reload"})]}),ne?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:f("text-sm",y),children:["You liked ",c.length,". Pick one to watch:"]}),e.jsx("div",{className:"grid gap-3 md:grid-cols-3",children:(m===1?c:c.slice(0,3)).map(t=>e.jsxs("button",{className:f("rounded-xl border p-4 text-left transition","bg-white dark:bg-zinc-950 border-zinc-200 dark:border-zinc-800 hover:border-indigo-400",_===t.id?"ring-2 ring-indigo-500":""),onClick:()=>w(t.id),children:[e.jsx("div",{className:f("font-semibold",te),children:t.title}),t.releaseYear&&e.jsx("div",{className:f("text-sm",y),children:t.releaseYear}),t.overview&&e.jsx("div",{className:f("mt-2 text-sm line-clamp-3",y),children:t.overview})]},t.id))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"rounded-lg border border-zinc-200 dark:border-zinc-800 px-4 py-2 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900",onClick:()=>{v()},disabled:b,children:"Start over"}),e.jsx("button",{className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>{if(!_)return;const t=c.find(s=>s.id===_);t&&(z(null),Y(t))},disabled:!_,children:"Choose winner"})]})]}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-md flex-col",children:[e.jsxs("div",{className:"relative flex-1 min-h-[440px] md:min-h-[520px]",children:[r&&e.jsx(G,{entry:r,isTop:!0,likeOpacity:ae,nopeOpacity:re,style:{zIndex:50,transform:`translate3d(${L}px, ${se}px, 0) rotate(${L/14}deg)`,transition:F&&!a.isDragging?"transform 220ms ease":"none"},onPointerDown:t=>{if(H(B(t),t.pointerId,"pointer"))try{t.currentTarget.setPointerCapture(t.pointerId)}catch{}},onPointerMove:t=>{K(B(t),t.pointerId,"pointer")},onPointerUp:t=>{V(B(t),t.pointerId,"pointer");try{t.currentTarget.releasePointerCapture(t.pointerId)}catch{}},onPointerCancel:t=>{R("pointer");try{t.currentTarget.releasePointerCapture(t.pointerId)}catch{}},onTouchStart:t=>{if(u.current.id!==null)return;const s=t.changedTouches[0];s&&H(U(s),s.identifier,"touch")},onTouchMove:t=>{const s=u.current;if(s.type!=="touch"||s.id===null)return;const o=q(t.touches,s.id)??q(t.changedTouches,s.id);o&&(a.isDragging&&t.cancelable&&t.preventDefault(),K(U(o),s.id,"touch"))},onTouchEnd:t=>{const s=u.current;if(s.type!=="touch"||s.id===null)return;const o=q(t.changedTouches,s.id);if(!o){R("touch");return}V(U(o),s.id,"touch")},onTouchCancel:()=>{R("touch")}}),$.map((t,s)=>e.jsx(G,{entry:t,isTop:!1,likeOpacity:0,nopeOpacity:0,style:{zIndex:40-s,transform:`translate3d(0, ${10+s*10}px, 0) scale(${1-(s+1)*.03})`,transition:"transform 220ms ease"}},t.id))]}),e.jsx("div",{className:"mt-4 flex-shrink-0 pb-2",children:e.jsxs("div",{className:"flex w-full items-center justify-between gap-3",children:[e.jsx("button",{className:"flex-1 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-4 py-3 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900 disabled:opacity-60",onClick:()=>X("nope"),disabled:!r||a.animatingOut||c.length>=m,children:"Nope"}),e.jsxs("div",{className:f("text-sm",y),children:["Liked: ",e.jsx("span",{className:"font-semibold",children:c.length}),"/",m||3]}),e.jsx("button",{className:"flex-1 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>X("like"),disabled:!r||a.animatingOut||c.length>=m,children:"Like"})]})})]})})]})})]})}function Q(n){return n&&n.split("-")[0]||""}function Z(n){return n?Array.isArray(n)?n[0]??null:n:null}function ee(n){return n?Array.isArray(n)?n[0]?.name??null:n.name??null:null}function ye(){const n=ce(),d=de(),x=ue(),p=l.useMemo(()=>{const a=n.entryId;if(!a)return null;const i=Number(a);return Number.isFinite(i)&&i>0?Math.trunc(i):null},[n.entryId]),[O,T]=l.useState([]),[M,C]=l.useState(!0),[Y,W]=l.useState(null),I=x.state?.winnerEntry??null,[k,j]=l.useState(I),[c,N]=l.useState(!1),[_,w]=l.useState(null),b=l.useCallback(async()=>{C(!0),W(null);try{const a=A(),{data:i,error:h}=await a.from("entries").select(`
            id,
            added_at,
            media_type,
            watched_at,
            tmdb_details (
              poster_path,
              backdrop_path,
              overview,
              name,
              release_date
            ),
            entry_tags (
              tags (
                name
              )
            )
          `).is("watched_at",null).order("added_at",{ascending:!1}).limit(50);if(h)throw h;const u=(i??[]).map(v=>{const r=Z(v.tmdb_details),$=r?.name||"Untitled",D=v.entry_tags?.map(m=>ee(m.tags)).filter(m=>!!m)??[];return{id:v.id,title:$,overview:r?.overview??null,releaseYear:Q(r?.release_date??null),posterPath:r?.poster_path??null,backdropPath:r?.backdrop_path??null,mediaType:v.media_type,tags:D}});T(u)}catch(a){const i=a instanceof Error?a.message:typeof a=="object"&&a!==null&&"message"in a&&typeof a.message=="string"?String(a.message):"Failed to load watch deck";W(i),T([])}finally{C(!1)}},[]);l.useEffect(()=>((async()=>{await b()})(),()=>{}),[b]);const P=l.useCallback(async a=>{N(!0),w(null);try{const i=A(),{data:h,error:u}=await i.from("entries").select(`
              id,
              added_at,
              media_type,
              watched_at,
              tmdb_details (
                poster_path,
                backdrop_path,
                overview,
                name,
                release_date
              ),
              entry_tags (
                tags (
                  name
                )
              )
            `).eq("id",a).maybeSingle();if(u)throw u;if(!h){j(null),w("Could not find that entry.");return}const v=h,r=Z(v.tmdb_details),$=r?.name||"Untitled",D=v.entry_tags?.map(m=>ee(m.tags)).filter(m=>!!m)??[];j({id:v.id,title:$,overview:r?.overview??null,releaseYear:Q(r?.release_date??null),posterPath:r?.poster_path??null,backdropPath:r?.backdrop_path??null,mediaType:v.media_type,tags:D})}catch(i){const h=i instanceof Error?i.message:typeof i=="object"&&i!==null&&"message"in i&&typeof i.message=="string"?String(i.message):"Failed to load selected entry";j(null),w(h)}finally{N(!1)}},[]);l.useEffect(()=>{if(!p){j(null),w(null),N(!1);return}if(I?.id===p){k?.id!==p&&j(I),w(null),N(!1);return}k?.id!==p&&P(p)},[P,I,k?.id,p]);const g=l.useCallback(a=>{j(a),d(`/app/watch/${a.id}`,{state:{winnerEntry:a}})},[d]),z=l.useCallback(async a=>{const i=A(),{error:h}=await i.from("entries").update({watched_at:new Date().toISOString()}).eq("id",a);if(h)throw h;d("/app/watch"),await b()},[b,d]);return e.jsx(he,{initialEntries:O,loading:M,error:Y,onReload:b,winnerEntryId:p,winnerEntry:k,winnerLoading:c,winnerError:_,onGoToWinner:g,onMarkWatched:z,onBackToCards:()=>d("/app/watch")})}export{ye as W};
