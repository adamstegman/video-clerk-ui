import{j as e}from"./jsx-runtime-u17CrQMm.js";import{a as l,C as ie,v as le,D as oe}from"./chunk-JMJ3UQ3L-DPj_BNs_.js";import{c as F}from"./client-B_XR4Hye.js";import{b as ce}from"./tmdb-configuration-BxuIu_6_.js";import{a as de,c as x,s as y,p as Z}from"./utils-ByhHhwOs.js";function K(n,d,f){return Math.min(f,Math.max(d,n))}function R(n){return{x:n.clientX,y:n.clientY}}function A(n){return{x:n.clientX,y:n.clientY}}function B(n,d){for(let f=0;f<n.length;f+=1){const p=n.item(f);if(p&&p.identifier===d)return p}return null}function U({entry:n,isTop:d,style:f,onPointerDown:p,onPointerMove:O,onPointerUp:C,onPointerCancel:M,onTouchStart:T,onTouchMove:Y,onTouchEnd:W,onTouchCancel:P,likeOpacity:k,nopeOpacity:j}){const c=l.useContext(ce),N=l.useMemo(()=>{const g=c.images.poster_sizes;if(!g.length)return null;const z=g.length>4?3:g.length-1;return g[z]||g[0]||null},[c.images.poster_sizes]),_=l.useMemo(()=>{const g=c.images.backdrop_sizes;if(!g.length)return null;const z=g.length>2?1:g.length-1;return g[z]||g[0]||null},[c.images.backdrop_sizes]),w=c.images.secure_base_url&&(n.backdropPath||n.posterPath)?n.backdropPath&&_?`${c.images.secure_base_url}${_}${n.backdropPath}`:n.posterPath&&N?`${c.images.secure_base_url}${N}${n.posterPath}`:null:null,b=n.mediaType==="movie"?"Movie":n.mediaType==="tv"?"TV":n.mediaType,I=n.tags.length>0?` | ${n.tags.join(", ")}`:"";return e.jsx("div",{className:x("absolute inset-0 rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 shadow-lg","overflow-hidden select-none touch-none",d?"cursor-grab active:cursor-grabbing":"pointer-events-none"),style:f,onPointerDown:p,onPointerMove:O,onPointerUp:C,onPointerCancel:M,onTouchStart:T,onTouchMove:Y,onTouchEnd:W,onTouchCancel:P,role:d?"group":void 0,"aria-label":d?`Swipe card for ${n.title}`:void 0,children:e.jsxs("div",{className:"flex h-full w-full flex-col",children:[e.jsxs("div",{className:"relative w-full flex-none shrink-0 basis-[62%]",children:[w?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:w,alt:n.title,className:"absolute inset-0 h-full w-full object-cover",draggable:!1}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/45 via-black/15 to-black/0"})]}):e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-zinc-900 via-zinc-800 to-zinc-700"}),e.jsx("div",{className:"absolute left-4 top-4 rounded-lg border-2 border-emerald-300 bg-emerald-500/10 px-3 py-1 text-lg font-extrabold tracking-widest text-emerald-100",style:{opacity:k},children:"LIKE"}),e.jsx("div",{className:"absolute right-4 top-4 rounded-lg border-2 border-rose-300 bg-rose-500/10 px-3 py-1 text-lg font-extrabold tracking-widest text-rose-100",style:{opacity:j},children:"NOPE"})]}),e.jsxs("div",{className:"flex-1 min-h-0 border-t border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-5 pt-5 pb-6",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("h3",{className:x("text-xl font-bold",Z),children:n.title}),n.releaseYear&&e.jsx("span",{className:x("text-sm",y),children:n.releaseYear})]}),n.overview&&e.jsx("p",{className:x("mt-2 line-clamp-4 text-sm",y),children:n.overview}),e.jsxs("p",{className:x("mt-3 text-xs",y),children:[b,I]})]})]})})}function ue({initialEntries:n,loading:d,error:f,onReload:p,winnerEntryId:O,winnerEntry:C,winnerLoading:M,winnerError:T,onGoToWinner:Y,onMarkWatched:W,onBackToCards:P}){const[k,j]=l.useState([]),[c,N]=l.useState([]),[_,w]=l.useState(null),[b,I]=l.useState(!1),[g,z]=l.useState(null),[a,r]=l.useState({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null}),h=l.useRef(null),u=l.useRef({id:null,type:null}),v=()=>{j(n),N([]),w(null),z(null),I(!1),u.current={id:null,type:null},r({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null})};l.useEffect(()=>{v()},[n]),l.useEffect(()=>()=>{h.current&&window.clearTimeout(h.current)},[]);const i=k[0]??null,$=k.slice(1,4),S=110,m=n.length===0?0:n.length<3?1:3,ee=m>0&&c.length>=m,te=i?K(Math.max(0,a.dx)/S,0,1):0,ne=i?K(Math.max(0,-a.dx)/S,0,1):0,q=(t,s,o)=>!i||a.animatingOut||c.length>=m||a.isDragging||u.current.id!==null?!1:(u.current={id:s,type:o},r(D=>({...D,activeId:i.id,startX:t.x,startY:t.y,dx:0,dy:0,isDragging:!0,animatingOut:!1,decision:null})),!0),G=(t,s,o)=>{if(!i||!a.isDragging||a.activeId!==i.id)return;const D=u.current;D.id!==s||D.type!==o||r(E=>({...E,dx:t.x-E.startX,dy:t.y-E.startY}))},H=(t,s,o)=>{const D=u.current;if(D.id!==s||D.type!==o||(u.current={id:null,type:null},!i)||!a.isDragging||a.activeId!==i.id)return;const E=t.x-a.startX;if(E>S)return L("like");if(E<-S)return L("nope");r(re=>({...re,isDragging:!1,dx:0,dy:0}))},X=t=>{u.current.type===t&&(u.current={id:null,type:null},r(s=>({...s,isDragging:!1,dx:0,dy:0})))};function L(t){if(!i)return;u.current={id:null,type:null};const s=t==="like"?420:-420;r(o=>({...o,animatingOut:!0,decision:t,dx:s,dy:o.dy,isDragging:!1,activeId:i.id})),h.current&&window.clearTimeout(h.current),h.current=window.setTimeout(()=>{j(o=>o.slice(1)),t==="like"&&N(o=>o.length>=m?o:[...o,i]),r({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null})},220)}async function se(t){I(!0),z(null);try{await W(t)}catch(s){const o=s instanceof Error?s.message:typeof s=="object"&&s!==null&&"message"in s&&typeof s.message=="string"?String(s.message):"Failed to mark watched";z(o)}finally{I(!1)}}const ae=O!==null;return e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsxs("div",{className:"flex-shrink-0 pb-2 pt-4",children:[e.jsx("h2",{className:de,children:"Watch"}),e.jsx("p",{className:x("mt-1 text-sm",y),children:"Swipe right to like, left to skip. Pick 1 once you have enough likes."})]}),e.jsx("div",{className:"flex-1 min-h-0 pb-4 overflow-y-auto",children:ae?e.jsxs("div",{className:"mx-auto w-full max-w-md",children:[M&&e.jsx("p",{className:x("text-sm",y),children:"Loading selectionâ€¦"}),T&&e.jsx("p",{className:"text-sm text-red-500",children:T}),!M&&!T&&C&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:x("mb-3 text-sm",y),children:"Selected to watch:"}),e.jsx("div",{className:"relative h-[520px] md:h-[560px]",children:e.jsx(U,{entry:C,isTop:!1,likeOpacity:0,nopeOpacity:0,style:{zIndex:1,transform:"none",transition:"none"}})}),g&&e.jsx("p",{className:"mt-3 text-sm text-red-500",children:g}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("button",{className:"flex-1 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-4 py-3 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900",onClick:P,disabled:b,children:"Back to cards"}),e.jsx("button",{className:"flex-1 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>void se(C.id),disabled:b,children:b?"Marking...":"Mark as Watched"})]})]})]}):e.jsxs(e.Fragment,{children:[d&&!f&&k.length===0&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),e.jsx("p",{className:y,children:"Loading..."})]})}),f&&e.jsx("p",{className:"text-sm text-red-500",children:f}),!d&&!f&&k.length===0&&c.length<m&&e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 py-12 text-center",children:[e.jsx("p",{className:x("text-sm",y),children:"No unwatched items to swipe on."}),e.jsx("button",{className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500",onClick:()=>void p(),children:"Reload"})]}),ee?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:x("text-sm",y),children:["You liked ",c.length,". Pick one to watch:"]}),e.jsx("div",{className:"grid gap-3 md:grid-cols-3",children:(m===1?c:c.slice(0,3)).map(t=>e.jsxs("button",{className:x("rounded-xl border p-4 text-left transition","bg-white dark:bg-zinc-950 border-zinc-200 dark:border-zinc-800 hover:border-indigo-400",_===t.id?"ring-2 ring-indigo-500":""),onClick:()=>w(t.id),children:[e.jsx("div",{className:x("font-semibold",Z),children:t.title}),t.releaseYear&&e.jsx("div",{className:x("text-sm",y),children:t.releaseYear}),t.overview&&e.jsx("div",{className:x("mt-2 text-sm line-clamp-3",y),children:t.overview})]},t.id))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"rounded-lg border border-zinc-200 dark:border-zinc-800 px-4 py-2 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900",onClick:()=>{v()},disabled:b,children:"Start over"}),e.jsx("button",{className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>{if(!_)return;const t=c.find(s=>s.id===_);t&&(z(null),Y(t))},disabled:!_,children:"Choose winner"})]})]}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-md flex-col",children:[e.jsxs("div",{className:"relative flex-1 min-h-[440px] md:min-h-[520px]",children:[i&&e.jsx(U,{entry:i,isTop:!0,likeOpacity:te,nopeOpacity:ne,style:{zIndex:50,transform:`translate3d(${a.dx}px, ${a.dy}px, 0) rotate(${a.dx/14}deg)`,transition:a.isDragging?"none":"transform 220ms ease"},onPointerDown:t=>{if(q(R(t),t.pointerId,"pointer"))try{t.currentTarget.setPointerCapture(t.pointerId)}catch{}},onPointerMove:t=>{G(R(t),t.pointerId,"pointer")},onPointerUp:t=>{H(R(t),t.pointerId,"pointer");try{t.currentTarget.releasePointerCapture(t.pointerId)}catch{}},onPointerCancel:t=>{X("pointer");try{t.currentTarget.releasePointerCapture(t.pointerId)}catch{}},onTouchStart:t=>{if(u.current.id!==null)return;const s=t.changedTouches[0];s&&q(A(s),s.identifier,"touch")},onTouchMove:t=>{const s=u.current;if(s.type!=="touch"||s.id===null)return;const o=B(t.touches,s.id)??B(t.changedTouches,s.id);o&&(a.isDragging&&t.cancelable&&t.preventDefault(),G(A(o),s.id,"touch"))},onTouchEnd:t=>{const s=u.current;if(s.type!=="touch"||s.id===null)return;const o=B(t.changedTouches,s.id);if(!o){X("touch");return}H(A(o),s.id,"touch")},onTouchCancel:()=>{X("touch")}}),$.map((t,s)=>e.jsx(U,{entry:t,isTop:!1,likeOpacity:0,nopeOpacity:0,style:{zIndex:40-s,transform:`translate3d(0, ${10+s*10}px, 0) scale(${1-(s+1)*.03})`,transition:"transform 220ms ease"}},t.id))]}),e.jsx("div",{className:"mt-4 flex-shrink-0 pb-2",children:e.jsxs("div",{className:"flex w-full items-center justify-between gap-3",children:[e.jsx("button",{className:"flex-1 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-4 py-3 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900 disabled:opacity-60",onClick:()=>L("nope"),disabled:!i||a.animatingOut||c.length>=m,children:"Nope"}),e.jsxs("div",{className:x("text-sm",y),children:["Liked: ",e.jsx("span",{className:"font-semibold",children:c.length}),"/",m||3]}),e.jsx("button",{className:"flex-1 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>L("like"),disabled:!i||a.animatingOut||c.length>=m,children:"Like"})]})})]})})]})})]})}function V(n){return n&&n.split("-")[0]||""}function J(n){return n?Array.isArray(n)?n[0]??null:n:null}function Q(n){return n?Array.isArray(n)?n[0]?.name??null:n.name??null:null}function fe(){const n=ie(),d=le(),f=oe(),p=l.useMemo(()=>{const a=n.entryId;if(!a)return null;const r=Number(a);return Number.isFinite(r)&&r>0?Math.trunc(r):null},[n.entryId]),[O,C]=l.useState([]),[M,T]=l.useState(!0),[Y,W]=l.useState(null),P=f.state?.winnerEntry??null,[k,j]=l.useState(P),[c,N]=l.useState(!1),[_,w]=l.useState(null),b=l.useCallback(async()=>{T(!0),W(null);try{const a=F(),{data:r,error:h}=await a.from("entries").select(`
            id,
            added_at,
            media_type,
            watched_at,
            tmdb_details (
              poster_path,
              backdrop_path,
              overview,
              name,
              release_date
            ),
            entry_tags (
              tags (
                name
              )
            )
          `).is("watched_at",null).order("added_at",{ascending:!1}).limit(50);if(h)throw h;const u=(r??[]).map(v=>{const i=J(v.tmdb_details),$=i?.name||"Untitled",S=v.entry_tags?.map(m=>Q(m.tags)).filter(m=>!!m)??[];return{id:v.id,title:$,overview:i?.overview??null,releaseYear:V(i?.release_date??null),posterPath:i?.poster_path??null,backdropPath:i?.backdrop_path??null,mediaType:v.media_type,tags:S}});C(u)}catch(a){const r=a instanceof Error?a.message:typeof a=="object"&&a!==null&&"message"in a&&typeof a.message=="string"?String(a.message):"Failed to load watch deck";W(r),C([])}finally{T(!1)}},[]);l.useEffect(()=>((async()=>{await b()})(),()=>{}),[b]);const I=l.useCallback(async a=>{N(!0),w(null);try{const r=F(),{data:h,error:u}=await r.from("entries").select(`
              id,
              added_at,
              media_type,
              watched_at,
              tmdb_details (
                poster_path,
                backdrop_path,
                overview,
                name,
                release_date
              ),
              entry_tags (
                tags (
                  name
                )
              )
            `).eq("id",a).maybeSingle();if(u)throw u;if(!h){j(null),w("Could not find that entry.");return}const v=h,i=J(v.tmdb_details),$=i?.name||"Untitled",S=v.entry_tags?.map(m=>Q(m.tags)).filter(m=>!!m)??[];j({id:v.id,title:$,overview:i?.overview??null,releaseYear:V(i?.release_date??null),posterPath:i?.poster_path??null,backdropPath:i?.backdrop_path??null,mediaType:v.media_type,tags:S})}catch(r){const h=r instanceof Error?r.message:typeof r=="object"&&r!==null&&"message"in r&&typeof r.message=="string"?String(r.message):"Failed to load selected entry";j(null),w(h)}finally{N(!1)}},[]);l.useEffect(()=>{if(!p){j(null),w(null),N(!1);return}if(P?.id===p){k?.id!==p&&j(P),w(null),N(!1);return}k?.id!==p&&I(p)},[I,P,k?.id,p]);const g=l.useCallback(a=>{j(a),d(`/app/watch/${a.id}`,{state:{winnerEntry:a}})},[d]),z=l.useCallback(async a=>{const r=F(),{error:h}=await r.from("entries").update({watched_at:new Date().toISOString()}).eq("id",a);if(h)throw h;d("/app/watch"),await b()},[b,d]);return e.jsx(ue,{initialEntries:O,loading:M,error:Y,onReload:b,winnerEntryId:p,winnerEntry:k,winnerLoading:c,winnerError:_,onGoToWinner:g,onMarkWatched:z,onBackToCards:()=>d("/app/watch")})}export{fe as W};
