import{j as e}from"./jsx-runtime-u17CrQMm.js";import{a as r,C as K,v as V}from"./chunk-JMJ3UQ3L-DNRSL2Hf.js";import{c as E}from"./client-B_XR4Hye.js";import{b as J}from"./tmdb-configuration-CpwZmLCk.js";import{a as Q,c as m,s as b,p as U}from"./utils-ByhHhwOs.js";function F(t,c,u){return Math.min(u,Math.max(c,t))}function L(t){return{x:t.clientX,y:t.clientY}}function $({entry:t,isTop:c,style:u,onPointerDown:T,likeOpacity:C,nopeOpacity:z}){const x=r.useContext(J),j=r.useMemo(()=>{const o=x.images.poster_sizes;if(!o.length)return null;const v=o.length>4?3:o.length-1;return o[v]||o[0]||null},[x.images.poster_sizes]),_=r.useMemo(()=>{const o=x.images.backdrop_sizes;if(!o.length)return null;const v=o.length>2?1:o.length-1;return o[v]||o[0]||null},[x.images.backdrop_sizes]),w=x.images.secure_base_url&&(t.backdropPath||t.posterPath)?t.backdropPath&&_?`${x.images.secure_base_url}${_}${t.backdropPath}`:t.posterPath&&j?`${x.images.secure_base_url}${j}${t.posterPath}`:null:null;return e.jsx("div",{className:m("absolute inset-0 rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 shadow-lg","overflow-hidden select-none touch-none",c?"cursor-grab active:cursor-grabbing":"pointer-events-none"),style:u,onPointerDown:T,role:c?"group":void 0,"aria-label":c?`Swipe card for ${t.title}`:void 0,children:e.jsxs("div",{className:"flex h-full w-full flex-col",children:[e.jsxs("div",{className:"relative w-full flex-none shrink-0 basis-[62%]",children:[w?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:w,alt:t.title,className:"absolute inset-0 h-full w-full object-cover",draggable:!1}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/45 via-black/15 to-black/0"})]}):e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-zinc-900 via-zinc-800 to-zinc-700"}),e.jsx("div",{className:"absolute left-4 top-4 rounded-lg border-2 border-emerald-300 bg-emerald-500/10 px-3 py-1 text-lg font-extrabold tracking-widest text-emerald-100",style:{opacity:C},children:"LIKE"}),e.jsx("div",{className:"absolute right-4 top-4 rounded-lg border-2 border-rose-300 bg-rose-500/10 px-3 py-1 text-lg font-extrabold tracking-widest text-rose-100",style:{opacity:z},children:"NOPE"})]}),e.jsxs("div",{className:"flex-1 min-h-0 border-t border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-5 pt-5 pb-6",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("h3",{className:m("text-xl font-bold",U),children:t.title}),t.releaseYear&&e.jsx("span",{className:m("text-sm",b),children:t.releaseYear})]}),t.overview&&e.jsx("p",{className:m("mt-2 line-clamp-4 text-sm",b),children:t.overview}),e.jsx("p",{className:m("mt-3 text-xs",b),children:t.mediaType==="movie"?"Movie":t.mediaType==="tv"?"TV":t.mediaType})]})]})})}function Z({initialEntries:t,loading:c,error:u,onReload:T,winnerEntryId:C,winnerEntry:z,winnerLoading:x,winnerError:j,onGoToWinner:_,onMarkWatched:w,onBackToCards:o}){const[v,S]=r.useState([]),[p,N]=r.useState([]),[k,P]=r.useState(null),[I,M]=r.useState(!1),[l,i]=r.useState(null),[n,f]=r.useState({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null}),h=r.useRef(null);r.useEffect(()=>{S(t),N([]),P(null),M(!1),i(null),f({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null})},[t]),r.useEffect(()=>()=>{h.current&&window.clearTimeout(h.current)},[]);const a=v[0]??null,W=v.slice(1,4),D=110,y=t.length===0?0:t.length<3?1:3,B=y>0&&p.length>=y,q=a?F(Math.max(0,n.dx)/D,0,1):0,A=a?F(Math.max(0,-n.dx)/D,0,1):0;function Y(s){if(!a)return;const d=s==="like"?420:-420;f(g=>({...g,animatingOut:!0,decision:s,dx:d,dy:g.dy,isDragging:!1,activeId:a.id})),h.current&&window.clearTimeout(h.current),h.current=window.setTimeout(()=>{S(g=>g.slice(1)),s==="like"&&N(g=>g.length>=y?g:[...g,a]),f({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null})},220)}async function G(s){M(!0),i(null);try{await w(s)}catch(d){const g=d instanceof Error?d.message:typeof d=="object"&&d!==null&&"message"in d&&typeof d.message=="string"?String(d.message):"Failed to mark watched";i(g)}finally{M(!1)}}const H=C!==null;return e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsxs("div",{className:"flex-shrink-0 pb-2 pt-4",children:[e.jsx("h2",{className:Q,children:"Watch"}),e.jsx("p",{className:m("mt-1 text-sm",b),children:"Swipe right to like, left to skip. Pick 1 once you have enough likes."})]}),e.jsx("div",{className:"flex-1 min-h-0 pb-4 overflow-y-auto",children:H?e.jsxs("div",{className:"mx-auto w-full max-w-md",children:[x&&e.jsx("p",{className:m("text-sm",b),children:"Loading selectionâ€¦"}),j&&e.jsx("p",{className:"text-sm text-red-500",children:j}),!x&&!j&&z&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:m("mb-3 text-sm",b),children:"Selected to watch:"}),e.jsx("div",{className:"relative h-[520px] md:h-[560px]",children:e.jsx($,{entry:z,isTop:!1,likeOpacity:0,nopeOpacity:0,style:{zIndex:1,transform:"none",transition:"none"}})}),l&&e.jsx("p",{className:"mt-3 text-sm text-red-500",children:l}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("button",{className:"flex-1 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-4 py-3 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900",onClick:o,disabled:I,children:"Back to cards"}),e.jsx("button",{className:"flex-1 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>void G(z.id),disabled:I,children:I?"Marking...":"Mark as Watched"})]})]})]}):e.jsxs(e.Fragment,{children:[c&&!u&&v.length===0&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),e.jsx("p",{className:b,children:"Loading..."})]})}),u&&e.jsx("p",{className:"text-sm text-red-500",children:u}),!c&&!u&&v.length===0&&p.length<y&&e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 py-12 text-center",children:[e.jsx("p",{className:m("text-sm",b),children:"No unwatched items to swipe on."}),e.jsx("button",{className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500",onClick:()=>void T(),children:"Reload"})]}),B?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:m("text-sm",b),children:["You liked ",p.length,". Pick one to watch:"]}),e.jsx("div",{className:"grid gap-3 md:grid-cols-3",children:(y===1?p:p.slice(0,3)).map(s=>e.jsxs("button",{className:m("rounded-xl border p-4 text-left transition","bg-white dark:bg-zinc-950 border-zinc-200 dark:border-zinc-800 hover:border-indigo-400",k===s.id?"ring-2 ring-indigo-500":""),onClick:()=>P(s.id),children:[e.jsx("div",{className:m("font-semibold",U),children:s.title}),s.releaseYear&&e.jsx("div",{className:m("text-sm",b),children:s.releaseYear}),s.overview&&e.jsx("div",{className:m("mt-2 text-sm line-clamp-3",b),children:s.overview})]},s.id))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"rounded-lg border border-zinc-200 dark:border-zinc-800 px-4 py-2 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900",onClick:()=>{N([]),P(null),i(null)},disabled:I,children:"Start over"}),e.jsx("button",{className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>{if(!k)return;const s=p.find(d=>d.id===k);s&&(i(null),_(s))},disabled:!k,children:"Choose winner"})]})]}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-md flex-col",children:[e.jsxs("div",{className:"relative flex-1 min-h-[440px] md:min-h-[520px]",children:[a&&e.jsx($,{entry:a,isTop:!0,likeOpacity:q,nopeOpacity:A,style:{zIndex:50,transform:`translate3d(${n.dx}px, ${n.dy}px, 0) rotate(${n.dx/14}deg)`,transition:n.isDragging?"none":"transform 220ms ease"},onPointerDown:s=>{if(!a||n.animatingOut||p.length>=y)return;s.currentTarget.setPointerCapture(s.pointerId);const{x:d,y:g}=L(s);f(O=>({...O,activeId:a.id,startX:d,startY:g,dx:0,dy:0,isDragging:!0,animatingOut:!1,decision:null}))}}),W.map((s,d)=>e.jsx($,{entry:s,isTop:!1,likeOpacity:0,nopeOpacity:0,style:{zIndex:40-d,transform:`translate3d(0, ${10+d*10}px, 0) scale(${1-(d+1)*.03})`,transition:"transform 220ms ease"}},s.id)),e.jsx("div",{className:"absolute inset-0",onPointerMove:s=>{if(!a||!n.isDragging||n.activeId!==a.id)return;const{x:d,y:g}=L(s);f(O=>({...O,dx:d-O.startX,dy:g-O.startY}))},onPointerUp:()=>{if(a&&n.isDragging&&n.activeId===a.id){if(n.dx>D)return Y("like");if(n.dx<-D)return Y("nope");f(s=>({...s,isDragging:!1,dx:0,dy:0}))}},onPointerCancel:()=>{f(s=>({...s,isDragging:!1,dx:0,dy:0}))}})]}),e.jsx("div",{className:"mt-4 flex-shrink-0 pb-2",children:e.jsxs("div",{className:"flex w-full items-center justify-between gap-3",children:[e.jsx("button",{className:"flex-1 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-4 py-3 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900 disabled:opacity-60",onClick:()=>Y("nope"),disabled:!a||n.animatingOut||p.length>=y,children:"Nope"}),e.jsxs("div",{className:m("text-sm",b),children:["Liked: ",e.jsx("span",{className:"font-semibold",children:p.length}),"/",y||3]}),e.jsx("button",{className:"flex-1 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>Y("like"),disabled:!a||n.animatingOut||p.length>=y,children:"Like"})]})})]})})]})})]})}function X(t){return t&&t.split("-")[0]||""}function R(t){return t?Array.isArray(t)?t[0]??null:t:null}function ie(){const t=K(),c=V(),u=r.useMemo(()=>{const l=t.entryId;if(!l)return null;const i=Number(l);return Number.isFinite(i)&&i>0?Math.trunc(i):null},[t.entryId]),[T,C]=r.useState([]),[z,x]=r.useState(!0),[j,_]=r.useState(null),[w,o]=r.useState(null),[v,S]=r.useState(!1),[p,N]=r.useState(null),k=r.useCallback(async()=>{x(!0),_(null);try{const l=E(),{data:i,error:n}=await l.from("entries").select(`
            id,
            added_at,
            media_type,
            watched_at,
            tmdb_details (
              poster_path,
              backdrop_path,
              overview,
              name,
              release_date
            )
          `).is("watched_at",null).order("added_at",{ascending:!1}).limit(50);if(n)throw n;const f=(i??[]).map(h=>{const a=R(h.tmdb_details),W=a?.name||"Untitled";return{id:h.id,title:W,overview:a?.overview??null,releaseYear:X(a?.release_date??null),posterPath:a?.poster_path??null,backdropPath:a?.backdrop_path??null,mediaType:h.media_type}});C(f)}catch(l){const i=l instanceof Error?l.message:typeof l=="object"&&l!==null&&"message"in l&&typeof l.message=="string"?String(l.message):"Failed to load watch deck";_(i),C([])}finally{x(!1)}},[]);r.useEffect(()=>((async()=>{await k()})(),()=>{}),[k]);const P=r.useCallback(async l=>{S(!0),N(null);try{const i=E(),{data:n,error:f}=await i.from("entries").select(`
              id,
              added_at,
              media_type,
              watched_at,
              tmdb_details (
                poster_path,
                backdrop_path,
                overview,
                name,
                release_date
              )
            `).eq("id",l).maybeSingle();if(f)throw f;if(!n){o(null),N("Could not find that entry.");return}const h=n,a=R(h.tmdb_details),W=a?.name||"Untitled";o({id:h.id,title:W,overview:a?.overview??null,releaseYear:X(a?.release_date??null),posterPath:a?.poster_path??null,backdropPath:a?.backdrop_path??null,mediaType:h.media_type})}catch(i){const n=i instanceof Error?i.message:typeof i=="object"&&i!==null&&"message"in i&&typeof i.message=="string"?String(i.message):"Failed to load selected entry";o(null),N(n)}finally{S(!1)}},[]);r.useEffect(()=>{if(!u){o(null),N(null),S(!1);return}w?.id!==u&&P(u)},[P,w?.id,u]);const I=r.useCallback(l=>{o(l),c(`/app/watch/${l.id}`)},[c]),M=r.useCallback(async l=>{const i=E(),{error:n}=await i.from("entries").update({watched_at:new Date().toISOString()}).eq("id",l);if(n)throw n;c("/app/watch"),await k()},[k,c]);return e.jsx(Z,{initialEntries:T,loading:z,error:j,onReload:k,winnerEntryId:u,winnerEntry:w,winnerLoading:v,winnerError:p,onGoToWinner:I,onMarkWatched:M,onBackToCards:()=>c("/app/watch")})}export{ie as W};
