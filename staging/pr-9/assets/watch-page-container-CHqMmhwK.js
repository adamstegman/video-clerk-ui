import{j as e}from"./jsx-runtime-u17CrQMm.js";import{a as r,C as J,v as Q,D as Z}from"./chunk-JMJ3UQ3L-DPj_BNs_.js";import{c as L}from"./client-B_XR4Hye.js";import{b as ee}from"./tmdb-configuration-BxuIu_6_.js";import{a as te,c as u,s as f,p as q}from"./utils-ByhHhwOs.js";function X(t,m,k){return Math.min(k,Math.max(m,t))}function R(t){return{x:t.clientX,y:t.clientY}}function F({entry:t,isTop:m,style:k,onPointerDown:b,likeOpacity:O,nopeOpacity:N}){const p=r.useContext(ee),j=r.useMemo(()=>{const l=p.images.poster_sizes;if(!l.length)return null;const d=l.length>4?3:l.length-1;return l[d]||l[0]||null},[p.images.poster_sizes]),I=r.useMemo(()=>{const l=p.images.backdrop_sizes;if(!l.length)return null;const d=l.length>2?1:l.length-1;return l[d]||l[0]||null},[p.images.backdrop_sizes]),S=p.images.secure_base_url&&(t.backdropPath||t.posterPath)?t.backdropPath&&I?`${p.images.secure_base_url}${I}${t.backdropPath}`:t.posterPath&&j?`${p.images.secure_base_url}${j}${t.posterPath}`:null:null,z=t.mediaType==="movie"?"Movie":t.mediaType==="tv"?"TV":t.mediaType,v=t.tags.length>0?` | ${t.tags.join(", ")}`:"";return e.jsx("div",{className:u("absolute inset-0 rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 shadow-lg","overflow-hidden select-none touch-none",m?"cursor-grab active:cursor-grabbing":"pointer-events-none"),style:k,onPointerDown:b,role:m?"group":void 0,"aria-label":m?`Swipe card for ${t.title}`:void 0,children:e.jsxs("div",{className:"flex h-full w-full flex-col",children:[e.jsxs("div",{className:"relative w-full flex-none shrink-0 basis-[62%]",children:[S?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:S,alt:t.title,className:"absolute inset-0 h-full w-full object-cover",draggable:!1}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/45 via-black/15 to-black/0"})]}):e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-zinc-900 via-zinc-800 to-zinc-700"}),e.jsx("div",{className:"absolute left-4 top-4 rounded-lg border-2 border-emerald-300 bg-emerald-500/10 px-3 py-1 text-lg font-extrabold tracking-widest text-emerald-100",style:{opacity:O},children:"LIKE"}),e.jsx("div",{className:"absolute right-4 top-4 rounded-lg border-2 border-rose-300 bg-rose-500/10 px-3 py-1 text-lg font-extrabold tracking-widest text-rose-100",style:{opacity:N},children:"NOPE"})]}),e.jsxs("div",{className:"flex-1 min-h-0 border-t border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-5 pt-5 pb-6",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("h3",{className:u("text-xl font-bold",q),children:t.title}),t.releaseYear&&e.jsx("span",{className:u("text-sm",f),children:t.releaseYear})]}),t.overview&&e.jsx("p",{className:u("mt-2 line-clamp-4 text-sm",f),children:t.overview}),e.jsxs("p",{className:u("mt-3 text-xs",f),children:[z,v]})]})]})})}function se({initialEntries:t,loading:m,error:k,onReload:b,winnerEntryId:O,winnerEntry:N,winnerLoading:p,winnerError:j,onGoToWinner:I,onMarkWatched:S,onBackToCards:z}){const[v,l]=r.useState([]),[d,P]=r.useState([]),[W,_]=r.useState(null),[y,M]=r.useState(!1),[Y,E]=r.useState(null),[s,n]=r.useState({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null}),c=r.useRef(null),T=()=>{l(t),P([]),_(null),E(null),M(!1),n({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null})};r.useEffect(()=>{T()},[t]),r.useEffect(()=>()=>{c.current&&window.clearTimeout(c.current)},[]);const i=v[0]??null,x=v.slice(1,4),C=110,h=t.length===0?0:t.length<3?1:3,w=h>0&&d.length>=h,G=i?X(Math.max(0,s.dx)/C,0,1):0,H=i?X(Math.max(0,-s.dx)/C,0,1):0;function $(a){if(!i)return;const o=a==="like"?420:-420;n(g=>({...g,animatingOut:!0,decision:a,dx:o,dy:g.dy,isDragging:!1,activeId:i.id})),c.current&&window.clearTimeout(c.current),c.current=window.setTimeout(()=>{l(g=>g.slice(1)),a==="like"&&P(g=>g.length>=h?g:[...g,i]),n({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null})},220)}async function K(a){M(!0),E(null);try{await S(a)}catch(o){const g=o instanceof Error?o.message:typeof o=="object"&&o!==null&&"message"in o&&typeof o.message=="string"?String(o.message):"Failed to mark watched";E(g)}finally{M(!1)}}const V=O!==null;return e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsxs("div",{className:"flex-shrink-0 pb-2 pt-4",children:[e.jsx("h2",{className:te,children:"Watch"}),e.jsx("p",{className:u("mt-1 text-sm",f),children:"Swipe right to like, left to skip. Pick 1 once you have enough likes."})]}),e.jsx("div",{className:"flex-1 min-h-0 pb-4 overflow-y-auto",children:V?e.jsxs("div",{className:"mx-auto w-full max-w-md",children:[p&&e.jsx("p",{className:u("text-sm",f),children:"Loading selectionâ€¦"}),j&&e.jsx("p",{className:"text-sm text-red-500",children:j}),!p&&!j&&N&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:u("mb-3 text-sm",f),children:"Selected to watch:"}),e.jsx("div",{className:"relative h-[520px] md:h-[560px]",children:e.jsx(F,{entry:N,isTop:!1,likeOpacity:0,nopeOpacity:0,style:{zIndex:1,transform:"none",transition:"none"}})}),Y&&e.jsx("p",{className:"mt-3 text-sm text-red-500",children:Y}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("button",{className:"flex-1 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-4 py-3 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900",onClick:z,disabled:y,children:"Back to cards"}),e.jsx("button",{className:"flex-1 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>void K(N.id),disabled:y,children:y?"Marking...":"Mark as Watched"})]})]})]}):e.jsxs(e.Fragment,{children:[m&&!k&&v.length===0&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),e.jsx("p",{className:f,children:"Loading..."})]})}),k&&e.jsx("p",{className:"text-sm text-red-500",children:k}),!m&&!k&&v.length===0&&d.length<h&&e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 py-12 text-center",children:[e.jsx("p",{className:u("text-sm",f),children:"No unwatched items to swipe on."}),e.jsx("button",{className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500",onClick:()=>void b(),children:"Reload"})]}),w?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:u("text-sm",f),children:["You liked ",d.length,". Pick one to watch:"]}),e.jsx("div",{className:"grid gap-3 md:grid-cols-3",children:(h===1?d:d.slice(0,3)).map(a=>e.jsxs("button",{className:u("rounded-xl border p-4 text-left transition","bg-white dark:bg-zinc-950 border-zinc-200 dark:border-zinc-800 hover:border-indigo-400",W===a.id?"ring-2 ring-indigo-500":""),onClick:()=>_(a.id),children:[e.jsx("div",{className:u("font-semibold",q),children:a.title}),a.releaseYear&&e.jsx("div",{className:u("text-sm",f),children:a.releaseYear}),a.overview&&e.jsx("div",{className:u("mt-2 text-sm line-clamp-3",f),children:a.overview})]},a.id))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"rounded-lg border border-zinc-200 dark:border-zinc-800 px-4 py-2 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900",onClick:()=>{T()},disabled:y,children:"Start over"}),e.jsx("button",{className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>{if(!W)return;const a=d.find(o=>o.id===W);a&&(E(null),I(a))},disabled:!W,children:"Choose winner"})]})]}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-md flex-col",children:[e.jsxs("div",{className:"relative flex-1 min-h-[440px] md:min-h-[520px]",children:[i&&e.jsx(F,{entry:i,isTop:!0,likeOpacity:G,nopeOpacity:H,style:{zIndex:50,transform:`translate3d(${s.dx}px, ${s.dy}px, 0) rotate(${s.dx/14}deg)`,transition:s.isDragging?"none":"transform 220ms ease"},onPointerDown:a=>{if(!i||s.animatingOut||d.length>=h)return;a.currentTarget.setPointerCapture(a.pointerId);const{x:o,y:g}=R(a);n(D=>({...D,activeId:i.id,startX:o,startY:g,dx:0,dy:0,isDragging:!0,animatingOut:!1,decision:null}))}}),x.map((a,o)=>e.jsx(F,{entry:a,isTop:!1,likeOpacity:0,nopeOpacity:0,style:{zIndex:40-o,transform:`translate3d(0, ${10+o*10}px, 0) scale(${1-(o+1)*.03})`,transition:"transform 220ms ease"}},a.id)),e.jsx("div",{className:"absolute inset-0",onPointerMove:a=>{if(!i||!s.isDragging||s.activeId!==i.id)return;const{x:o,y:g}=R(a);n(D=>({...D,dx:o-D.startX,dy:g-D.startY}))},onPointerUp:()=>{if(i&&s.isDragging&&s.activeId===i.id){if(s.dx>C)return $("like");if(s.dx<-C)return $("nope");n(a=>({...a,isDragging:!1,dx:0,dy:0}))}},onPointerCancel:()=>{n(a=>({...a,isDragging:!1,dx:0,dy:0}))}})]}),e.jsx("div",{className:"mt-4 flex-shrink-0 pb-2",children:e.jsxs("div",{className:"flex w-full items-center justify-between gap-3",children:[e.jsx("button",{className:"flex-1 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-4 py-3 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900 disabled:opacity-60",onClick:()=>$("nope"),disabled:!i||s.animatingOut||d.length>=h,children:"Nope"}),e.jsxs("div",{className:u("text-sm",f),children:["Liked: ",e.jsx("span",{className:"font-semibold",children:d.length}),"/",h||3]}),e.jsx("button",{className:"flex-1 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>$("like"),disabled:!i||s.animatingOut||d.length>=h,children:"Like"})]})})]})})]})})]})}function A(t){return t&&t.split("-")[0]||""}function U(t){return t?Array.isArray(t)?t[0]??null:t:null}function B(t){return t?Array.isArray(t)?t[0]?.name??null:t.name??null:null}function oe(){const t=J(),m=Q(),k=Z(),b=r.useMemo(()=>{const s=t.entryId;if(!s)return null;const n=Number(s);return Number.isFinite(n)&&n>0?Math.trunc(n):null},[t.entryId]),[O,N]=r.useState([]),[p,j]=r.useState(!0),[I,S]=r.useState(null),z=k.state?.winnerEntry??null,[v,l]=r.useState(z),[d,P]=r.useState(!1),[W,_]=r.useState(null),y=r.useCallback(async()=>{j(!0),S(null);try{const s=L(),{data:n,error:c}=await s.from("entries").select(`
            id,
            added_at,
            media_type,
            watched_at,
            tmdb_details (
              poster_path,
              backdrop_path,
              overview,
              name,
              release_date
            ),
            entry_tags (
              tags (
                name
              )
            )
          `).is("watched_at",null).order("added_at",{ascending:!1}).limit(50);if(c)throw c;const T=(n??[]).map(i=>{const x=U(i.tmdb_details),C=x?.name||"Untitled",h=i.entry_tags?.map(w=>B(w.tags)).filter(w=>!!w)??[];return{id:i.id,title:C,overview:x?.overview??null,releaseYear:A(x?.release_date??null),posterPath:x?.poster_path??null,backdropPath:x?.backdrop_path??null,mediaType:i.media_type,tags:h}});N(T)}catch(s){const n=s instanceof Error?s.message:typeof s=="object"&&s!==null&&"message"in s&&typeof s.message=="string"?String(s.message):"Failed to load watch deck";S(n),N([])}finally{j(!1)}},[]);r.useEffect(()=>((async()=>{await y()})(),()=>{}),[y]);const M=r.useCallback(async s=>{P(!0),_(null);try{const n=L(),{data:c,error:T}=await n.from("entries").select(`
              id,
              added_at,
              media_type,
              watched_at,
              tmdb_details (
                poster_path,
                backdrop_path,
                overview,
                name,
                release_date
              ),
              entry_tags (
                tags (
                  name
                )
              )
            `).eq("id",s).maybeSingle();if(T)throw T;if(!c){l(null),_("Could not find that entry.");return}const i=c,x=U(i.tmdb_details),C=x?.name||"Untitled",h=i.entry_tags?.map(w=>B(w.tags)).filter(w=>!!w)??[];l({id:i.id,title:C,overview:x?.overview??null,releaseYear:A(x?.release_date??null),posterPath:x?.poster_path??null,backdropPath:x?.backdrop_path??null,mediaType:i.media_type,tags:h})}catch(n){const c=n instanceof Error?n.message:typeof n=="object"&&n!==null&&"message"in n&&typeof n.message=="string"?String(n.message):"Failed to load selected entry";l(null),_(c)}finally{P(!1)}},[]);r.useEffect(()=>{if(!b){l(null),_(null),P(!1);return}if(z?.id===b){v?.id!==b&&l(z),_(null),P(!1);return}v?.id!==b&&M(b)},[M,z,v?.id,b]);const Y=r.useCallback(s=>{l(s),m(`/app/watch/${s.id}`,{state:{winnerEntry:s}})},[m]),E=r.useCallback(async s=>{const n=L(),{error:c}=await n.from("entries").update({watched_at:new Date().toISOString()}).eq("id",s);if(c)throw c;m("/app/watch"),await y()},[y,m]);return e.jsx(se,{initialEntries:O,loading:p,error:I,onReload:y,winnerEntryId:b,winnerEntry:v,winnerLoading:d,winnerError:W,onGoToWinner:Y,onMarkWatched:E,onBackToCards:()=>m("/app/watch")})}export{oe as W};
