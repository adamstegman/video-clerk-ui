import{j as e}from"./jsx-runtime-u17CrQMm.js";import{a as n,C as V,v as J}from"./chunk-JMJ3UQ3L-DNRSL2Hf.js";import{c as E}from"./client-B_XR4Hye.js";import{b as Q}from"./tmdb-configuration-CpwZmLCk.js";import{a as Z,c as m,s as v,p as U}from"./utils-ByhHhwOs.js";function F(t,c,u){return Math.min(u,Math.max(c,t))}function L(t){return{x:t.clientX,y:t.clientY}}function $({entry:t,isTop:c,style:u,onPointerDown:T,likeOpacity:S,nopeOpacity:z}){const h=n.useContext(Q),w=n.useMemo(()=>{const l=h.images.poster_sizes;if(!l.length)return null;const k=l.length>4?3:l.length-1;return l[k]||l[0]||null},[h.images.poster_sizes]),_=n.useMemo(()=>{const l=h.images.backdrop_sizes;if(!l.length)return null;const k=l.length>2?1:l.length-1;return l[k]||l[0]||null},[h.images.backdrop_sizes]),N=h.images.secure_base_url&&(t.backdropPath||t.posterPath)?t.backdropPath&&_?`${h.images.secure_base_url}${_}${t.backdropPath}`:t.posterPath&&w?`${h.images.secure_base_url}${w}${t.posterPath}`:null:null;return e.jsx("div",{className:m("absolute inset-0 rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 shadow-lg","overflow-hidden select-none touch-none",c?"cursor-grab active:cursor-grabbing":"pointer-events-none"),style:u,onPointerDown:T,role:c?"group":void 0,"aria-label":c?`Swipe card for ${t.title}`:void 0,children:e.jsxs("div",{className:"flex h-full w-full flex-col",children:[e.jsxs("div",{className:"relative w-full flex-none shrink-0 basis-[62%]",children:[N?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:N,alt:t.title,className:"absolute inset-0 h-full w-full object-cover",draggable:!1}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/45 via-black/15 to-black/0"})]}):e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-zinc-900 via-zinc-800 to-zinc-700"}),e.jsx("div",{className:"absolute left-4 top-4 rounded-lg border-2 border-emerald-300 bg-emerald-500/10 px-3 py-1 text-lg font-extrabold tracking-widest text-emerald-100",style:{opacity:S},children:"LIKE"}),e.jsx("div",{className:"absolute right-4 top-4 rounded-lg border-2 border-rose-300 bg-rose-500/10 px-3 py-1 text-lg font-extrabold tracking-widest text-rose-100",style:{opacity:z},children:"NOPE"})]}),e.jsxs("div",{className:"flex-1 min-h-0 border-t border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-5 pt-5 pb-6",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("h3",{className:m("text-xl font-bold",U),children:t.title}),t.releaseYear&&e.jsx("span",{className:m("text-sm",v),children:t.releaseYear})]}),t.overview&&e.jsx("p",{className:m("mt-2 line-clamp-4 text-sm",v),children:t.overview}),e.jsx("p",{className:m("mt-3 text-xs",v),children:t.mediaType==="movie"?"Movie":t.mediaType==="tv"?"TV":t.mediaType})]})]})})}function ee({initialEntries:t,loading:c,error:u,onReload:T,winnerEntryId:S,winnerEntry:z,winnerLoading:h,winnerError:w,onGoToWinner:_,onMarkWatched:N,onBackToCards:l}){const[k,P]=n.useState([]),[f,C]=n.useState([]),[y,M]=n.useState(null),[I,W]=n.useState(!1),[r,i]=n.useState(null),[a,b]=n.useState({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null}),p=n.useRef(null),g=()=>{P(t),C([]),M(null),i(null),W(!1),b({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null})};n.useEffect(()=>{g()},[t]),n.useEffect(()=>()=>{p.current&&window.clearTimeout(p.current)},[]);const o=k[0]??null,B=k.slice(1,4),D=110,j=t.length===0?0:t.length<3?1:3,q=j>0&&f.length>=j,A=o?F(Math.max(0,a.dx)/D,0,1):0,G=o?F(Math.max(0,-a.dx)/D,0,1):0;function Y(s){if(!o)return;const d=s==="like"?420:-420;b(x=>({...x,animatingOut:!0,decision:s,dx:d,dy:x.dy,isDragging:!1,activeId:o.id})),p.current&&window.clearTimeout(p.current),p.current=window.setTimeout(()=>{P(x=>x.slice(1)),s==="like"&&C(x=>x.length>=j?x:[...x,o]),b({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null})},220)}async function H(s){W(!0),i(null);try{await N(s)}catch(d){const x=d instanceof Error?d.message:typeof d=="object"&&d!==null&&"message"in d&&typeof d.message=="string"?String(d.message):"Failed to mark watched";i(x)}finally{W(!1)}}const K=S!==null;return e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsxs("div",{className:"flex-shrink-0 pb-2 pt-4",children:[e.jsx("h2",{className:Z,children:"Watch"}),e.jsx("p",{className:m("mt-1 text-sm",v),children:"Swipe right to like, left to skip. Pick 1 once you have enough likes."})]}),e.jsx("div",{className:"flex-1 min-h-0 pb-4 overflow-y-auto",children:K?e.jsxs("div",{className:"mx-auto w-full max-w-md",children:[h&&e.jsx("p",{className:m("text-sm",v),children:"Loading selectionâ€¦"}),w&&e.jsx("p",{className:"text-sm text-red-500",children:w}),!h&&!w&&z&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:m("mb-3 text-sm",v),children:"Selected to watch:"}),e.jsx("div",{className:"relative h-[520px] md:h-[560px]",children:e.jsx($,{entry:z,isTop:!1,likeOpacity:0,nopeOpacity:0,style:{zIndex:1,transform:"none",transition:"none"}})}),r&&e.jsx("p",{className:"mt-3 text-sm text-red-500",children:r}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("button",{className:"flex-1 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-4 py-3 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900",onClick:l,disabled:I,children:"Back to cards"}),e.jsx("button",{className:"flex-1 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>void H(z.id),disabled:I,children:I?"Marking...":"Mark as Watched"})]})]})]}):e.jsxs(e.Fragment,{children:[c&&!u&&k.length===0&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),e.jsx("p",{className:v,children:"Loading..."})]})}),u&&e.jsx("p",{className:"text-sm text-red-500",children:u}),!c&&!u&&k.length===0&&f.length<j&&e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 py-12 text-center",children:[e.jsx("p",{className:m("text-sm",v),children:"No unwatched items to swipe on."}),e.jsx("button",{className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500",onClick:()=>void T(),children:"Reload"})]}),q?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:m("text-sm",v),children:["You liked ",f.length,". Pick one to watch:"]}),e.jsx("div",{className:"grid gap-3 md:grid-cols-3",children:(j===1?f:f.slice(0,3)).map(s=>e.jsxs("button",{className:m("rounded-xl border p-4 text-left transition","bg-white dark:bg-zinc-950 border-zinc-200 dark:border-zinc-800 hover:border-indigo-400",y===s.id?"ring-2 ring-indigo-500":""),onClick:()=>M(s.id),children:[e.jsx("div",{className:m("font-semibold",U),children:s.title}),s.releaseYear&&e.jsx("div",{className:m("text-sm",v),children:s.releaseYear}),s.overview&&e.jsx("div",{className:m("mt-2 text-sm line-clamp-3",v),children:s.overview})]},s.id))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"rounded-lg border border-zinc-200 dark:border-zinc-800 px-4 py-2 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900",onClick:()=>{g()},disabled:I,children:"Start over"}),e.jsx("button",{className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>{if(!y)return;const s=f.find(d=>d.id===y);s&&(i(null),_(s))},disabled:!y,children:"Choose winner"})]})]}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-md flex-col",children:[e.jsxs("div",{className:"relative flex-1 min-h-[440px] md:min-h-[520px]",children:[o&&e.jsx($,{entry:o,isTop:!0,likeOpacity:A,nopeOpacity:G,style:{zIndex:50,transform:`translate3d(${a.dx}px, ${a.dy}px, 0) rotate(${a.dx/14}deg)`,transition:a.isDragging?"none":"transform 220ms ease"},onPointerDown:s=>{if(!o||a.animatingOut||f.length>=j)return;s.currentTarget.setPointerCapture(s.pointerId);const{x:d,y:x}=L(s);b(O=>({...O,activeId:o.id,startX:d,startY:x,dx:0,dy:0,isDragging:!0,animatingOut:!1,decision:null}))}}),B.map((s,d)=>e.jsx($,{entry:s,isTop:!1,likeOpacity:0,nopeOpacity:0,style:{zIndex:40-d,transform:`translate3d(0, ${10+d*10}px, 0) scale(${1-(d+1)*.03})`,transition:"transform 220ms ease"}},s.id)),e.jsx("div",{className:"absolute inset-0",onPointerMove:s=>{if(!o||!a.isDragging||a.activeId!==o.id)return;const{x:d,y:x}=L(s);b(O=>({...O,dx:d-O.startX,dy:x-O.startY}))},onPointerUp:()=>{if(o&&a.isDragging&&a.activeId===o.id){if(a.dx>D)return Y("like");if(a.dx<-D)return Y("nope");b(s=>({...s,isDragging:!1,dx:0,dy:0}))}},onPointerCancel:()=>{b(s=>({...s,isDragging:!1,dx:0,dy:0}))}})]}),e.jsx("div",{className:"mt-4 flex-shrink-0 pb-2",children:e.jsxs("div",{className:"flex w-full items-center justify-between gap-3",children:[e.jsx("button",{className:"flex-1 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-4 py-3 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900 disabled:opacity-60",onClick:()=>Y("nope"),disabled:!o||a.animatingOut||f.length>=j,children:"Nope"}),e.jsxs("div",{className:m("text-sm",v),children:["Liked: ",e.jsx("span",{className:"font-semibold",children:f.length}),"/",j||3]}),e.jsx("button",{className:"flex-1 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>Y("like"),disabled:!o||a.animatingOut||f.length>=j,children:"Like"})]})})]})})]})})]})}function X(t){return t&&t.split("-")[0]||""}function R(t){return t?Array.isArray(t)?t[0]??null:t:null}function re(){const t=V(),c=J(),u=n.useMemo(()=>{const r=t.entryId;if(!r)return null;const i=Number(r);return Number.isFinite(i)&&i>0?Math.trunc(i):null},[t.entryId]),[T,S]=n.useState([]),[z,h]=n.useState(!0),[w,_]=n.useState(null),[N,l]=n.useState(null),[k,P]=n.useState(!1),[f,C]=n.useState(null),y=n.useCallback(async()=>{h(!0),_(null);try{const r=E(),{data:i,error:a}=await r.from("entries").select(`
            id,
            added_at,
            media_type,
            watched_at,
            tmdb_details (
              poster_path,
              backdrop_path,
              overview,
              name,
              release_date
            )
          `).is("watched_at",null).order("added_at",{ascending:!1}).limit(50);if(a)throw a;const b=(i??[]).map(p=>{const g=R(p.tmdb_details),o=g?.name||"Untitled";return{id:p.id,title:o,overview:g?.overview??null,releaseYear:X(g?.release_date??null),posterPath:g?.poster_path??null,backdropPath:g?.backdrop_path??null,mediaType:p.media_type}});S(b)}catch(r){const i=r instanceof Error?r.message:typeof r=="object"&&r!==null&&"message"in r&&typeof r.message=="string"?String(r.message):"Failed to load watch deck";_(i),S([])}finally{h(!1)}},[]);n.useEffect(()=>((async()=>{await y()})(),()=>{}),[y]);const M=n.useCallback(async r=>{P(!0),C(null);try{const i=E(),{data:a,error:b}=await i.from("entries").select(`
              id,
              added_at,
              media_type,
              watched_at,
              tmdb_details (
                poster_path,
                backdrop_path,
                overview,
                name,
                release_date
              )
            `).eq("id",r).maybeSingle();if(b)throw b;if(!a){l(null),C("Could not find that entry.");return}const p=a,g=R(p.tmdb_details),o=g?.name||"Untitled";l({id:p.id,title:o,overview:g?.overview??null,releaseYear:X(g?.release_date??null),posterPath:g?.poster_path??null,backdropPath:g?.backdrop_path??null,mediaType:p.media_type})}catch(i){const a=i instanceof Error?i.message:typeof i=="object"&&i!==null&&"message"in i&&typeof i.message=="string"?String(i.message):"Failed to load selected entry";l(null),C(a)}finally{P(!1)}},[]);n.useEffect(()=>{if(!u){l(null),C(null),P(!1);return}N?.id!==u&&M(u)},[M,N?.id,u]);const I=n.useCallback(r=>{l(r),c(`/app/watch/${r.id}`)},[c]),W=n.useCallback(async r=>{const i=E(),{error:a}=await i.from("entries").update({watched_at:new Date().toISOString()}).eq("id",r);if(a)throw a;c("/app/watch"),await y()},[y,c]);return e.jsx(ee,{initialEntries:T,loading:z,error:w,onReload:y,winnerEntryId:u,winnerEntry:N,winnerLoading:k,winnerError:f,onGoToWinner:I,onMarkWatched:W,onBackToCards:()=>c("/app/watch")})}export{re as W};
