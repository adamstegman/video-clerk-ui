import{a as r,x as te,C as se,v as ne,w as ae}from"./chunk-JMJ3UQ3L-DPj_BNs_.js";import{j as t}from"./jsx-runtime-u17CrQMm.js";import{c as K}from"./client-B_XR4Hye.js";import{b as re}from"./tmdb-configuration-BxuIu_6_.js";import{A as J}from"./action-button-BX2IeZ2i.js";import{S as $,a as O}from"./settings-subsection-X7Eq6pXz.js";import{b as oe,a as ie,s as R,c as A,e as le,p as ce}from"./utils-ByhHhwOs.js";import{c as de}from"./createLucideIcon-CMzVMv86.js";const me=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],ue=de("arrow-left",me);function fe({entry:e,loading:d,error:a,tagsInput:n,onTagsChange:u,onSaveTags:D,saving:S,saveError:B,saveSuccess:w,deleting:k,deleteError:C,onDelete:M}){const p=r.useContext(re),F=p.images.poster_sizes.length>2?2:p.images.poster_sizes.length-1,_=p.images.poster_sizes[F]||p.images.poster_sizes[0];return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:oe,children:t.jsxs("div",{className:"flex items-center justify-between gap-4",children:[t.jsx("h2",{className:ie,children:"Edit entry"}),t.jsx(te,{to:"/app/list",className:"text-sm font-medium text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300",children:"Back to list"})]})}),t.jsxs("div",{className:"flex-1 overflow-y-auto min-h-0 pb-4",children:[d&&!a&&t.jsx("div",{className:"flex items-center justify-center py-12",children:t.jsxs("div",{className:"flex flex-col items-center gap-4",children:[t.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),t.jsx("p",{className:R,children:"Loading entry..."})]})}),a&&t.jsx("p",{className:A("text-sm",le),children:a}),!d&&!a&&e&&t.jsxs(t.Fragment,{children:[t.jsx($,{title:"Entry",children:t.jsxs("div",{className:"flex gap-4 md:gap-6 items-start",children:[e.posterPath&&p.images.secure_base_url&&t.jsx("img",{src:`${p.images.secure_base_url}${_}${e.posterPath}`,alt:e.title,className:"flex-shrink-0 w-16 h-24 object-cover rounded md:w-20 md:h-[120px]"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h3",{className:A("font-bold text-base md:text-lg",ce),children:e.title}),e.releaseYear&&t.jsx("p",{className:A("text-sm md:text-base",R),children:e.releaseYear}),e.tags.length>0&&t.jsx("p",{className:A("text-sm md:text-base",R),children:e.tags.map(N=>N.name).join(", ")})]})]})}),t.jsx($,{title:"Tags",children:t.jsxs(O,{description:"Separate tags with commas to add or remove labels for this entry.",error:B,success:w?"Tags updated.":null,children:[t.jsx("label",{htmlFor:"entry-tags",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Tags"}),t.jsx("textarea",{id:"entry-tags",rows:3,value:n,onChange:N=>u(N.target.value),placeholder:"e.g. Cozy, Weekend, Action",className:"w-full rounded-md border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder:text-zinc-400 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-100"}),t.jsx(J,{onClick:D,loading:S,disabled:!e,loadingText:"Saving...",children:"Save tags"})]})}),t.jsx($,{title:"Delete entry",children:t.jsx(O,{description:"Remove this entry from your list. This cannot be undone.",error:C,children:t.jsx(J,{onClick:M,loading:k,loadingText:"Deleting...",variant:"secondary",className:"border border-red-300 text-red-600 hover:bg-red-50 dark:border-red-700 dark:text-red-400 dark:hover:bg-red-900/20",children:"Delete entry"})})})]})]})]})}function ge(e){return e&&e.split("-")[0]||""}function pe(e){return e?Array.isArray(e)?e[0]??null:e:null}function he(e){return e?Array.isArray(e)?e[0]??null:e:null}function E(e){return e.trim().toLowerCase()}function xe(e){const d=new Set,a=[];return e.split(/[,\\n]/).map(n=>n.trim()).filter(n=>n.length>0).forEach(n=>{const u=E(n);d.has(u)||(d.add(u),a.push(n))}),a}function Y(e,d){return e instanceof Error?e.message:typeof e=="object"&&e!==null&&"message"in e&&typeof e.message=="string"?String(e.message):d}function ye(){const e=se(),d=ne(),a=r.useMemo(()=>{const o=e.entryId;if(!o)return null;const l=Number(o);return Number.isFinite(l)&&l>0?Math.trunc(l):null},[e.entryId]),[n,u]=r.useState(null),[D,S]=r.useState(!0),[B,w]=r.useState(null),[k,C]=r.useState(""),[M,p]=r.useState(!1),[F,_]=r.useState(null),[N,I]=r.useState(!1),[L,q]=r.useState(!1),[Q,H]=r.useState(null),U=r.useCallback(async()=>{if(!a){u(null),w("Invalid entry."),S(!1);return}S(!0),w(null);try{const o=K(),{data:l,error:m}=await o.from("entries").select(`
            id,
            added_at,
            tmdb_details (
              poster_path,
              name,
              release_date
            ),
            entry_tags (
              tags (
                id,
                name,
                is_custom
              )
            )
          `).eq("id",a).maybeSingle();if(m)throw m;if(!l){u(null),w("Entry not found.");return}const j=l,v=pe(j.tmdb_details),T=j.entry_tags?.map(i=>he(i.tags)).filter(i=>!!i&&typeof i.id=="number"&&!!i.name).map(i=>({id:i.id,name:i.name,is_custom:!!i.is_custom}))??[];u({id:j.id,title:v?.name||"Untitled",releaseYear:ge(v?.release_date??null),posterPath:v?.poster_path??null,tags:T})}catch(o){u(null),w(Y(o,"Failed to load entry"))}finally{S(!1)}},[a]);r.useEffect(()=>{U()},[U]),r.useEffect(()=>{n&&(C(n.tags.map(o=>o.name).join(", ")),_(null),I(!1))},[n?.id]);const X=r.useCallback(o=>{C(o),_(null),I(!1)},[]),Z=r.useCallback(async()=>{if(!(!a||!n)){p(!0),_(null),I(!1);try{const o=xe(k),l=new Map;for(const s of n.tags)l.set(E(s.name),s);const m=new Map;for(const s of o){const f=E(s);m.has(f)||m.set(f,s)}const j=Array.from(m.keys()).filter(s=>!l.has(s)),v=j.map(s=>m.get(s)),T=new Map,i=K();if(v.length>0){const{data:s,error:f}=await i.from("tags").select("id,name,is_custom").in("name",v);if(f)throw f;const h=new Map;for(const c of s??[]){if(!c.name||typeof c.id!="number")continue;const x={id:c.id,name:c.name,is_custom:!!c.is_custom},y=E(x.name),g=h.get(y)??[];g.push(x),h.set(y,g)}const P=[];for(const c of j){const x=h.get(c)??[],y=x.find(g=>g.is_custom)??x[0];if(y)T.set(c,y);else{const g=m.get(c);g&&P.push(g)}}if(P.length>0){const{data:c,error:x}=await i.rpc("current_user_group_id");if(x)throw x;if(!c)throw new Error("Could not determine group.");const{data:y,error:g}=await i.from("tags").upsert(P.map(b=>({name:b,tmdb_id:null,group_id:c,is_custom:!0})),{onConflict:"name,group_id"}).select("id,name,is_custom");if(g)throw g;for(const b of y??[]){if(!b.name||typeof b.id!="number")continue;const G={id:b.id,name:b.name,is_custom:!!b.is_custom};T.set(E(G.name),G)}}}const z=[],V=new Set;for(const s of o){const f=E(s),h=l.get(f)??T.get(f);!h||V.has(h.id)||(V.add(h.id),z.push(h))}const{error:W}=await i.from("entry_tags").delete().eq("entry_id",a);if(W)throw W;if(z.length>0){const{error:s}=await i.from("entry_tags").insert(z.map(f=>({entry_id:a,tag_id:f.id})));if(s)throw s}u(s=>s&&{...s,tags:z}),C(z.map(s=>s.name).join(", ")),I(!0)}catch(o){_(Y(o,"Failed to update tags"))}finally{p(!1)}}},[n,a,k]),ee=r.useCallback(async()=>{if(!(!a||L||!window.confirm(n?.title?`Delete "${n.title}" from your list?`:"Delete this entry from your list?"))){q(!0),H(null);try{const l=K(),{error:m}=await l.from("entries").delete().eq("id",a);if(m)throw m;d("/app/list")}catch(l){H(Y(l,"Failed to delete entry"))}finally{q(!1)}}},[L,n?.title,a,d]);return t.jsx(fe,{entry:n,loading:D,error:B,tagsInput:k,onTagsChange:X,onSaveTags:Z,saving:M,saveError:F,saveSuccess:N,deleting:L,deleteError:Q,onDelete:ee})}const Ce={leftHeaderAction:{to:"/app/list",icon:t.jsx(ue,{})}};function Ne({}){return[{title:"Video Clerk - Edit Entry"},{name:"description",content:"Edit saved list entries and update tags."}]}const Te=ae(function(){return t.jsx(ye,{})});export{Te as default,Ce as handle,Ne as meta};
