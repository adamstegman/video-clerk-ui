import{a,C as he,v as pe,w as be}from"./chunk-JMJ3UQ3L-DPj_BNs_.js";import{j as e}from"./jsx-runtime-u17CrQMm.js";import{c as U}from"./client-B_XR4Hye.js";import{b as ye}from"./tmdb-configuration-BxuIu_6_.js";import{A as X}from"./action-button-BX2IeZ2i.js";import{S as se,a as we}from"./settings-subsection-X7Eq6pXz.js";import{b as Z,a as ke,s as V,c as z,e as ne,p as _e}from"./utils-ByhHhwOs.js";import{c as je}from"./createLucideIcon-CMzVMv86.js";const Ne=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],ze=je("arrow-left",Ne);function Ce({entry:n,loading:h,error:c,selectedTags:g,availableTags:C,tagQuery:k,suggestions:v,canCreateTag:B,watched:A,onWatchedChange:S,onTagQueryChange:j,onAddTag:_,onRemoveTag:D,onToggleTag:p,onCreateTag:b,onSaveTags:P,saving:M,saveError:$,saveCompleted:L,creatingTag:W,deleting:Y,deleteError:H,onDelete:E}){const N=a.useContext(ye),I=N.images.poster_sizes.length>2?2:N.images.poster_sizes.length-1,F=N.images.poster_sizes[I]||N.images.poster_sizes[0];return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:Z,children:e.jsx("div",{className:"flex items-center justify-between gap-4",children:e.jsx("h2",{className:ke,children:"Edit entry"})})}),e.jsxs("div",{className:"flex-1 overflow-y-auto min-h-0 pb-4",children:[h&&!c&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),e.jsx("p",{className:V,children:"Loading entry..."})]})}),c&&e.jsx("p",{className:z("text-sm",ne),children:c}),!h&&!c&&n&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:Z,children:e.jsxs("div",{className:"flex gap-4 md:gap-6 items-start",children:[n.posterPath&&N.images.secure_base_url&&F&&e.jsx("img",{src:`${N.images.secure_base_url}${F}${n.posterPath}`,alt:n.title,className:"flex-shrink-0 w-16 h-24 object-cover rounded md:w-20 md:h-[120px]"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:z("font-bold text-base md:text-lg",_e),children:n.title}),n.releaseYear&&e.jsx("p",{className:z("text-sm md:text-base",V),children:n.releaseYear})]})]})}),e.jsx(se,{title:"Status",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{id:"entry-watched",type:"checkbox",checked:A,onChange:l=>S(l.target.checked),className:"h-4 w-4 rounded border-zinc-300 text-indigo-600 focus:ring-indigo-500 dark:border-zinc-700 dark:bg-zinc-950"}),e.jsx("label",{htmlFor:"entry-watched",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Watched"})]})}),e.jsx(se,{title:"Tags",children:e.jsxs(we,{description:"",error:$,children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[g.length===0&&e.jsx("p",{className:z("text-sm",V),children:"No tags selected."}),g.map(l=>e.jsx("button",{type:"button",onClick:()=>D(l),className:"rounded-full border border-indigo-200 bg-indigo-50 px-3 py-1 text-xs font-medium text-indigo-700 hover:bg-indigo-100 dark:border-indigo-700 dark:bg-indigo-950 dark:text-indigo-200","aria-label":`Remove tag ${l.name}`,children:l.name},l.id))]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("label",{htmlFor:"entry-tag-query",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Add tag"}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:[e.jsx("input",{id:"entry-tag-query",value:k,onChange:l=>j(l.target.value),onKeyDown:l=>{if(l.key==="Enter"||l.key==="Tab"||l.key===","){if(k.trim().length===0)return;l.preventDefault(),b(k)}},placeholder:"Type a tag name",className:"w-full rounded-md border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder:text-zinc-400 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-100","aria-autocomplete":"list","aria-expanded":v.length>0||B,"aria-controls":"entry-tag-suggestions"}),e.jsx(X,{onClick:()=>b(k),disabled:k.trim().length===0||W,loading:W,loadingText:"Adding...",variant:"secondary",size:"sm",className:"sm:w-auto",children:"Add"})]}),(v.length>0||B)&&e.jsxs("div",{id:"entry-tag-suggestions",role:"listbox",className:"rounded-md border border-zinc-200 bg-white p-2 text-sm shadow-sm dark:border-zinc-700 dark:bg-zinc-900",children:[B&&e.jsxs("button",{type:"button",onClick:()=>b(k),className:"w-full rounded-md px-2 py-1 text-left text-indigo-600 hover:bg-indigo-50 dark:text-indigo-300 dark:hover:bg-indigo-900/40",children:['Create "',k.trim(),'"']}),v.map(l=>e.jsx("button",{type:"button",onClick:()=>_(l),className:"w-full rounded-md px-2 py-1 text-left hover:bg-zinc-100 dark:hover:bg-zinc-800",children:l.name},l.id))]})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("p",{className:"text-xs font-medium text-zinc-500 dark:text-zinc-400",children:"Existing tags"}),C.length===0?e.jsx("p",{className:z("text-sm",V),children:"No tags available."}):e.jsx("div",{className:"flex flex-wrap gap-2",children:C.map(l=>{const q=g.some(K=>K.id===l.id);return e.jsx("button",{type:"button",onClick:()=>p(l),"aria-pressed":q,className:z("rounded-full border px-3 py-1 text-xs font-medium transition",q?"border-indigo-400 bg-indigo-500 text-white hover:bg-indigo-400 dark:border-indigo-500 dark:bg-indigo-500":"border-zinc-200 bg-white text-zinc-600 hover:bg-zinc-100 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-200 dark:hover:bg-zinc-800"),children:l.name},l.id)})})]})]})}),e.jsxs("div",{className:z(Z,"flex flex-col gap-3 md:flex-row md:items-start md:justify-between"),children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(X,{onClick:E,loading:Y,loadingText:"Deleting...",variant:"secondary",className:"border border-red-300 text-red-600 hover:bg-red-50 dark:border-red-700 dark:text-red-400 dark:hover:bg-red-900/20 w-full md:w-auto",children:"Delete entry"}),H&&e.jsx("p",{className:z("text-sm",ne),children:H})]}),e.jsx(X,{onClick:P,loading:M,disabled:!n||W,loadingText:"Saving...",completed:L,completedText:"Saved!",className:"w-full md:w-auto md:ml-auto",children:"Save"})]})]})]})]})}function ve(n){return n&&n.split("-")[0]||""}function Se(n){return n?Array.isArray(n)?n[0]??null:n:null}function Ee(n){return n?Array.isArray(n)?n[0]??null:n:null}function u(n){return J(n).toLowerCase()}function J(n){return n.trim().replace(/\s+/g," ")}function G(n,h){return n instanceof Error?n.message:typeof n=="object"&&n!==null&&"message"in n&&typeof n.message=="string"?String(n.message):h}function Te(){const n=he(),h=pe(),c=a.useMemo(()=>{const t=n.entryId;if(!t)return null;const s=Number(t);return Number.isFinite(s)&&s>0?Math.trunc(s):null},[n.entryId]),[g,C]=a.useState(null),[k,v]=a.useState(!0),[B,A]=a.useState(null),[S,j]=a.useState([]),[_,D]=a.useState([]),[p,b]=a.useState(""),[P,M]=a.useState(!1),[$,L]=a.useState(null),[W,Y]=a.useState(!1),[H,E]=a.useState(null),[N,I]=a.useState(!1),[F,l]=a.useState(!1),[q,K]=a.useState(!1),[ae,Q]=a.useState(null),ee=a.useCallback(async()=>{if(!c){C(null),A("Invalid entry."),v(!1);return}v(!0),A(null);try{const t=U(),[s,r]=await Promise.all([t.from("entries").select(`
              id,
              added_at,
              watched_at,
              tmdb_details (
                poster_path,
                name,
                release_date
              ),
              entry_tags (
                tags (
                  id,
                  name,
                  is_custom
                )
              )
            `).eq("id",c).maybeSingle(),t.from("tags").select("id,name,is_custom").order("name")]);if(s.error)throw s.error;if(!s.data){C(null),A("Entry not found.");return}if(r.error)console.error("Failed to load tags",r.error),D([]);else{const d=r.data?.filter(i=>i.name&&typeof i.id=="number").map(i=>({id:i.id,name:i.name,is_custom:!!i.is_custom}))??[];D(d)}const o=s.data,f=Se(o.tmdb_details),m=o.entry_tags?.map(d=>Ee(d.tags)).filter(d=>!!d&&typeof d.id=="number"&&!!d.name).map(d=>({id:d.id,name:d.name,is_custom:!!d.is_custom}))??[];C({id:o.id,title:f?.name||"Untitled",releaseYear:ve(f?.release_date??null),posterPath:f?.poster_path??null}),j(m),M(!!o.watched_at),L(o.watched_at??null)}catch(t){C(null),A(G(t,"Failed to load entry"))}finally{v(!1)}},[c]);a.useEffect(()=>{ee()},[ee]);const R=a.useRef(null);a.useEffect(()=>{g&&(b(""),E(null),I(!1))},[g?.id]),a.useEffect(()=>()=>{R.current!==null&&(window.clearTimeout(R.current),R.current=null)},[]);const x=a.useCallback(()=>{E(null),I(!1)},[]),re=a.useCallback(t=>{M(t),L(s=>t?s??new Date().toISOString():null),x()},[x]),ie=a.useCallback(t=>{b(t),x()},[x]),oe=a.useCallback(t=>{j(s=>s.some(o=>u(o.name)===u(t.name))?s:[...s,t]),b(""),x()},[x]),le=a.useCallback(t=>{j(s=>s.filter(r=>r.id!==t.id)),x()},[x]),de=a.useCallback(t=>{j(s=>s.some(o=>o.id===t.id)?s.filter(o=>o.id!==t.id):[...s,t]),b(""),x()},[x]),te=a.useCallback(async(t,s)=>{const r=J(s);if(!r)return null;const{data:o,error:f}=await t.from("tags").select("id,name,is_custom").ilike("name",r);if(f)throw f;const m=o?.filter(i=>i.name&&typeof i.id=="number").map(i=>({id:i.id,name:i.name,is_custom:!!i.is_custom}))??[];if(m.length===0)return null;const d=m.find(i=>i.is_custom)??m[0]??null;return d?(D(i=>i.some(T=>u(T.name)===u(d.name))?i:[...i,d]),d):null},[]),O=a.useCallback(async t=>{const s=J(t);if(!s)return null;const r=u(s),o=_.find(w=>u(w.name)===r);if(o)return o;const f=U(),{data:m,error:d}=await f.rpc("current_user_group_id");if(d)throw d;if(!m)throw new Error("Could not determine group.");const{data:i,error:y}=await f.from("tags").insert({name:s,tmdb_id:null,group_id:m,is_custom:!0}).select("id,name,is_custom").maybeSingle();if(y){const w=await te(f,s);if(w)return w;throw y}if(!i||!i.name||typeof i.id!="number")return null;const T={id:i.id,name:i.name,is_custom:!!i.is_custom};return D(w=>w.some(xe=>u(xe.name)===r)?w:[...w,T]),T},[_,te]),ce=a.useCallback(async t=>{if(F)return;const s=J(t);if(s){l(!0),x();try{const r=await O(s);r&&j(o=>o.some(m=>u(m.name)===u(r.name))?o:[...o,r]),b("")}catch(r){E(G(r,"Failed to create tag"))}finally{l(!1)}}},[F,O,x]),ue=a.useMemo(()=>{const t=u(p);if(!t)return[];const s=new Set(S.map(r=>u(r.name)));return _.filter(r=>{const o=u(r.name);return o.includes(t)&&!s.has(o)})},[_,S,p]),me=a.useMemo(()=>{const t=u(p);return t?!_.some(s=>u(s.name)===t):!1},[_,p]),fe=a.useCallback(async()=>{if(!(!c||!g)){Y(!0),E(null),I(!1);try{let t=S;if(p.trim().length>0){const y=await O(p);y&&(t.some(w=>u(w.name)===u(y.name))||(t=[...t,y]),j(t)),b("")}const s=U(),{data:r,error:o}=await s.rpc("current_user_group_id");if(o)throw o;if(!r)throw new Error("Could not determine group.");const f=P?$??new Date().toISOString():null,{data:m,error:d}=await s.from("entries").update({watched_at:f}).eq("id",c).eq("group_id",r).select("watched_at").maybeSingle();if(d)throw d;if(!m)throw new Error("Unable to update watched status.");L(m?.watched_at??null),M(!!m?.watched_at);const{error:i}=await s.from("entry_tags").delete().eq("entry_id",c);if(i)throw i;if(t.length>0){const{error:y}=await s.from("entry_tags").insert(t.map(T=>({entry_id:c,tag_id:T.id})));if(y)throw y}I(!0),R.current!==null&&window.clearTimeout(R.current),R.current=window.setTimeout(()=>{h("/app/list")},500)}catch(t){E(G(t,"Failed to update tags"))}finally{Y(!1)}}},[g,c,O,h,S,p,P,$]),ge=a.useCallback(async()=>{if(!(!c||q||!window.confirm(g?.title?`Delete "${g.title}" from your list?`:"Delete this entry from your list?"))){K(!0),Q(null);try{const s=U(),{error:r}=await s.from("entries").delete().eq("id",c);if(r)throw r;h("/app/list")}catch(s){Q(G(s,"Failed to delete entry"))}finally{K(!1)}}},[q,g?.title,c,h]);return e.jsx(Ce,{entry:g,loading:k,error:B,selectedTags:S,availableTags:_,tagQuery:p,suggestions:ue,canCreateTag:me,watched:P,onWatchedChange:re,onTagQueryChange:ie,onAddTag:oe,onRemoveTag:le,onToggleTag:de,onCreateTag:ce,onSaveTags:fe,saving:W,saveError:H,saveCompleted:N,creatingTag:F,deleting:q,deleteError:ae,onDelete:ge})}const Le={leftHeaderAction:{to:"/app/list",icon:e.jsx(ze,{})}};function We({}){return[{title:"Video Clerk - Edit Entry"},{name:"description",content:"Edit saved list entries and update tags."}]}const $e=be(function(){return e.jsx(Te,{})});export{$e as default,Le as handle,We as meta};
