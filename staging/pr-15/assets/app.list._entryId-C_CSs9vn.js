import{a as r,x as ae,C as re,v as oe,w as ie}from"./chunk-JMJ3UQ3L-DPj_BNs_.js";import{j as t}from"./jsx-runtime-u17CrQMm.js";import{c as $}from"./client-B_XR4Hye.js";import{b as le}from"./tmdb-configuration-BxuIu_6_.js";import{A as X}from"./action-button-BX2IeZ2i.js";import{S as R,a as Z}from"./settings-subsection-X7Eq6pXz.js";import{b as ce,a as de,s as Y,c as M,e as me,p as ue}from"./utils-ByhHhwOs.js";import{c as fe}from"./createLucideIcon-CMzVMv86.js";const ge=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],pe=fe("arrow-left",ge);function he({entry:e,loading:d,error:a,tagsInput:n,onTagsChange:u,onSaveTags:F,saving:C,saveError:L,saveSuccess:v,deleting:N,deleteError:T,onDelete:P}){const p=r.useContext(le),q=p.images.poster_sizes.length>2?2:p.images.poster_sizes.length-1,E=p.images.poster_sizes[q]||p.images.poster_sizes[0];return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:ce,children:t.jsxs("div",{className:"flex items-center justify-between gap-4",children:[t.jsx("h2",{className:de,children:"Edit entry"}),t.jsx(ae,{to:"/app/list",className:"text-sm font-medium text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300",children:"Back to list"})]})}),t.jsxs("div",{className:"flex-1 overflow-y-auto min-h-0 pb-4",children:[d&&!a&&t.jsx("div",{className:"flex items-center justify-center py-12",children:t.jsxs("div",{className:"flex flex-col items-center gap-4",children:[t.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),t.jsx("p",{className:Y,children:"Loading entry..."})]})}),a&&t.jsx("p",{className:M("text-sm",me),children:a}),!d&&!a&&e&&t.jsxs(t.Fragment,{children:[t.jsx(R,{title:"Entry",children:t.jsxs("div",{className:"flex gap-4 md:gap-6 items-start",children:[e.posterPath&&p.images.secure_base_url&&t.jsx("img",{src:`${p.images.secure_base_url}${E}${e.posterPath}`,alt:e.title,className:"flex-shrink-0 w-16 h-24 object-cover rounded md:w-20 md:h-[120px]"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h3",{className:M("font-bold text-base md:text-lg",ue),children:e.title}),e.releaseYear&&t.jsx("p",{className:M("text-sm md:text-base",Y),children:e.releaseYear}),e.tags.length>0&&t.jsx("p",{className:M("text-sm md:text-base",Y),children:e.tags.map(z=>z.name).join(", ")})]})]})}),t.jsx(R,{title:"Tags",children:t.jsxs(Z,{description:"Separate tags with commas to add or remove labels for this entry.",error:L,success:v?"Tags updated.":null,children:[t.jsx("label",{htmlFor:"entry-tags",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Tags"}),t.jsx("textarea",{id:"entry-tags",rows:3,value:n,onChange:z=>u(z.target.value),placeholder:"e.g. Cozy, Weekend, Action",className:"w-full rounded-md border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder:text-zinc-400 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-100"}),t.jsx(X,{onClick:F,loading:C,disabled:!e,loadingText:"Saving...",children:"Save tags"})]})}),t.jsx(R,{title:"Delete entry",children:t.jsx(Z,{description:"Remove this entry from your list. This cannot be undone.",error:T,children:t.jsx(X,{onClick:P,loading:N,loadingText:"Deleting...",variant:"secondary",className:"border border-red-300 text-red-600 hover:bg-red-50 dark:border-red-700 dark:text-red-400 dark:hover:bg-red-900/20",children:"Delete entry"})})})]})]})]})}function xe(e){return e&&e.split("-")[0]||""}function ye(e){return e?Array.isArray(e)?e[0]??null:e:null}function be(e){return e?Array.isArray(e)?e[0]??null:e:null}function b(e){return e.trim().toLowerCase()}function we(e){const d=new Set,a=[];return e.split(/[,\\n]/).map(n=>n.trim()).filter(n=>n.length>0).forEach(n=>{const u=b(n);d.has(u)||(d.add(u),a.push(n))}),a}function H(e,d){return e instanceof Error?e.message:typeof e=="object"&&e!==null&&"message"in e&&typeof e.message=="string"?String(e.message):d}function _e(){const e=re(),d=oe(),a=r.useMemo(()=>{const o=e.entryId;if(!o)return null;const l=Number(o);return Number.isFinite(l)&&l>0?Math.trunc(l):null},[e.entryId]),[n,u]=r.useState(null),[F,C]=r.useState(!0),[L,v]=r.useState(null),[N,T]=r.useState(""),[P,p]=r.useState(!1),[q,E]=r.useState(null),[z,B]=r.useState(!1),[K,U]=r.useState(!1),[ee,V]=r.useState(null),W=r.useCallback(async()=>{if(!a){u(null),v("Invalid entry."),C(!1);return}C(!0),v(null);try{const o=$(),{data:l,error:m}=await o.from("entries").select(`
            id,
            added_at,
            tmdb_details (
              poster_path,
              name,
              release_date
            ),
            entry_tags (
              tags (
                id,
                name,
                is_custom
              )
            )
          `).eq("id",a).maybeSingle();if(m)throw m;if(!l){u(null),v("Entry not found.");return}const S=l,k=ye(S.tmdb_details),w=S.entry_tags?.map(i=>be(i.tags)).filter(i=>!!i&&typeof i.id=="number"&&!!i.name).map(i=>({id:i.id,name:i.name,is_custom:!!i.is_custom}))??[];u({id:S.id,title:k?.name||"Untitled",releaseYear:xe(k?.release_date??null),posterPath:k?.poster_path??null,tags:w})}catch(o){u(null),v(H(o,"Failed to load entry"))}finally{C(!1)}},[a]);r.useEffect(()=>{W()},[W]),r.useEffect(()=>{n&&(T(n.tags.map(o=>o.name).join(", ")),E(null),B(!1))},[n?.id]);const te=r.useCallback(o=>{T(o),E(null),B(!1)},[]),se=r.useCallback(async()=>{if(!(!a||!n)){p(!0),E(null),B(!1);try{const o=we(N),l=new Map;for(const s of n.tags)l.set(b(s.name),s);const m=new Map;for(const s of o){const f=b(s);m.has(f)||m.set(f,s)}const S=Array.from(m.keys()).filter(s=>!l.has(s)),k=S.map(s=>m.get(s)),w=new Map,i=$();if(k.length>0){const{data:s,error:f}=await i.from("tags").select("id,name,is_custom").in("name",k);if(f)throw f;const x=new Map;for(const c of s??[]){if(!c.name||typeof c.id!="number")continue;const y={id:c.id,name:c.name,is_custom:!!c.is_custom},_=b(y.name),g=x.get(_)??[];g.push(y),x.set(_,g)}const D=[];for(const c of S){const y=x.get(c)??[],_=y.find(g=>g.is_custom)??y[0];if(_)w.set(c,_);else{const g=m.get(c);g&&D.push(g)}}if(D.length>0){const{data:c,error:y}=await i.rpc("current_user_group_id");if(y)throw y;if(!c)throw new Error("Could not determine group.");const{data:_,error:g}=await i.from("tags").select("id,name,is_custom").eq("group_id",c).eq("is_custom",!0).in("name",D);if(g)throw g;for(const h of _??[]){if(!h.name||typeof h.id!="number")continue;const A={id:h.id,name:h.name,is_custom:!!h.is_custom};w.set(b(A.name),A)}const O=D.filter(h=>!w.has(b(h)));if(O.length>0){const{data:h,error:A}=await i.from("tags").insert(O.map(j=>({name:j,tmdb_id:null,group_id:c,is_custom:!0}))).select("id,name,is_custom");if(A)throw A;for(const j of h??[]){if(!j.name||typeof j.id!="number")continue;const Q={id:j.id,name:j.name,is_custom:!!j.is_custom};w.set(b(Q.name),Q)}}}}const I=[],G=new Set;for(const s of o){const f=b(s),x=l.get(f)??w.get(f);!x||G.has(x.id)||(G.add(x.id),I.push(x))}const{error:J}=await i.from("entry_tags").delete().eq("entry_id",a);if(J)throw J;if(I.length>0){const{error:s}=await i.from("entry_tags").insert(I.map(f=>({entry_id:a,tag_id:f.id})));if(s)throw s}u(s=>s&&{...s,tags:I}),T(I.map(s=>s.name).join(", ")),B(!0)}catch(o){E(H(o,"Failed to update tags"))}finally{p(!1)}}},[n,a,N]),ne=r.useCallback(async()=>{if(!(!a||K||!window.confirm(n?.title?`Delete "${n.title}" from your list?`:"Delete this entry from your list?"))){U(!0),V(null);try{const l=$(),{error:m}=await l.from("entries").delete().eq("id",a);if(m)throw m;d("/app/list")}catch(l){V(H(l,"Failed to delete entry"))}finally{U(!1)}}},[K,n?.title,a,d]);return t.jsx(he,{entry:n,loading:F,error:L,tagsInput:N,onTagsChange:te,onSaveTags:se,saving:P,saveError:q,saveSuccess:z,deleting:K,deleteError:ee,onDelete:ne})}const ze={leftHeaderAction:{to:"/app/list",icon:t.jsx(pe,{})}};function Ie({}){return[{title:"Video Clerk - Edit Entry"},{name:"description",content:"Edit saved list entries and update tags."}]}const Ae=ie(function(){return t.jsx(_e,{})});export{Ae as default,ze as handle,Ie as meta};
