import{a as r,x as re,C as oe,v as ie,w as le}from"./chunk-JMJ3UQ3L-DPj_BNs_.js";import{j as t}from"./jsx-runtime-u17CrQMm.js";import{c as $}from"./client-B_XR4Hye.js";import{b as ce}from"./tmdb-configuration-BxuIu_6_.js";import{A as Q}from"./action-button-BX2IeZ2i.js";import{S as X,a as de}from"./settings-subsection-X7Eq6pXz.js";import{b as Z,a as me,s as Y,c as B,e as ee,p as ue}from"./utils-ByhHhwOs.js";import{c as fe}from"./createLucideIcon-CMzVMv86.js";const ge=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],pe=fe("arrow-left",ge);function he({entry:e,loading:d,error:a,tagsInput:n,onTagsChange:u,onSaveTags:F,saving:N,saveError:L,saveSuccess:v,deleting:z,deleteError:E,onDelete:P}){const p=r.useContext(ce),q=p.images.poster_sizes.length>2?2:p.images.poster_sizes.length-1,S=p.images.poster_sizes[q]||p.images.poster_sizes[0];return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:Z,children:t.jsxs("div",{className:"flex items-center justify-between gap-4",children:[t.jsx("h2",{className:me,children:"Edit entry"}),t.jsx(re,{to:"/app/list",className:"text-sm font-medium text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300",children:"Back to list"})]})}),t.jsxs("div",{className:"flex-1 overflow-y-auto min-h-0 pb-4",children:[d&&!a&&t.jsx("div",{className:"flex items-center justify-center py-12",children:t.jsxs("div",{className:"flex flex-col items-center gap-4",children:[t.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),t.jsx("p",{className:Y,children:"Loading entry..."})]})}),a&&t.jsx("p",{className:B("text-sm",ee),children:a}),!d&&!a&&e&&t.jsxs(t.Fragment,{children:[t.jsx(X,{title:"Entry",children:t.jsxs("div",{className:"flex gap-4 md:gap-6 items-start",children:[e.posterPath&&p.images.secure_base_url&&t.jsx("img",{src:`${p.images.secure_base_url}${S}${e.posterPath}`,alt:e.title,className:"flex-shrink-0 w-16 h-24 object-cover rounded md:w-20 md:h-[120px]"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h3",{className:B("font-bold text-base md:text-lg",ue),children:e.title}),e.releaseYear&&t.jsx("p",{className:B("text-sm md:text-base",Y),children:e.releaseYear}),e.tags.length>0&&t.jsx("p",{className:B("text-sm md:text-base",Y),children:e.tags.map(T=>T.name).join(", ")})]})]})}),t.jsx(X,{title:"Tags",children:t.jsxs(de,{description:"Separate tags with commas to add or remove labels for this entry.",error:L,success:v?"Tags updated.":null,children:[t.jsx("label",{htmlFor:"entry-tags",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Tags"}),t.jsx("textarea",{id:"entry-tags",rows:3,value:n,onChange:T=>u(T.target.value),placeholder:"e.g. Cozy, Weekend, Action",className:"w-full rounded-md border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder:text-zinc-400 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-100"}),t.jsx(Q,{onClick:F,loading:N,disabled:!e,loadingText:"Saving...",children:"Save tags"})]})}),t.jsx("div",{className:Z,children:t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx(Q,{onClick:P,loading:z,loadingText:"Deleting...",variant:"secondary",className:"border border-red-300 text-red-600 hover:bg-red-50 dark:border-red-700 dark:text-red-400 dark:hover:bg-red-900/20",children:"Delete entry"}),E&&t.jsx("p",{className:B("text-sm",ee),children:E})]})})]})]})]})}function xe(e){return e&&e.split("-")[0]||""}function ye(e){return e?Array.isArray(e)?e[0]??null:e:null}function we(e){return e?Array.isArray(e)?e[0]??null:e:null}function w(e){return e.trim().toLowerCase()}function _e(e){const d=new Set,a=[];return e.split(/[,\\n]/).map(n=>n.trim()).filter(n=>n.length>0).forEach(n=>{const u=w(n);d.has(u)||(d.add(u),a.push(n))}),a}function H(e,d){return e instanceof Error?e.message:typeof e=="object"&&e!==null&&"message"in e&&typeof e.message=="string"?String(e.message):d}function be(){const e=oe(),d=ie(),a=r.useMemo(()=>{const o=e.entryId;if(!o)return null;const l=Number(o);return Number.isFinite(l)&&l>0?Math.trunc(l):null},[e.entryId]),[n,u]=r.useState(null),[F,N]=r.useState(!0),[L,v]=r.useState(null),[z,E]=r.useState(""),[P,p]=r.useState(!1),[q,S]=r.useState(null),[T,D]=r.useState(!1),[K,R]=r.useState(!1),[te,U]=r.useState(null),V=r.useCallback(async()=>{if(!a){u(null),v("Invalid entry."),N(!1);return}N(!0),v(null);try{const o=$(),{data:l,error:m}=await o.from("entries").select(`
            id,
            added_at,
            tmdb_details (
              poster_path,
              name,
              release_date
            ),
            entry_tags (
              tags (
                id,
                name,
                is_custom
              )
            )
          `).eq("id",a).maybeSingle();if(m)throw m;if(!l){u(null),v("Entry not found.");return}const k=l,C=ye(k.tmdb_details),_=k.entry_tags?.map(i=>we(i.tags)).filter(i=>!!i&&typeof i.id=="number"&&!!i.name).map(i=>({id:i.id,name:i.name,is_custom:!!i.is_custom}))??[];u({id:k.id,title:C?.name||"Untitled",releaseYear:xe(C?.release_date??null),posterPath:C?.poster_path??null,tags:_})}catch(o){u(null),v(H(o,"Failed to load entry"))}finally{N(!1)}},[a]);r.useEffect(()=>{V()},[V]),r.useEffect(()=>{n&&(E(n.tags.map(o=>o.name).join(", ")),S(null),D(!1))},[n?.id]);const se=r.useCallback(o=>{E(o),S(null),D(!1)},[]),ne=r.useCallback(async()=>{if(!(!a||!n)){p(!0),S(null),D(!1);try{const o=_e(z),l=new Map;for(const s of n.tags)l.set(w(s.name),s);const m=new Map;for(const s of o){const f=w(s);m.has(f)||m.set(f,s)}const k=Array.from(m.keys()).filter(s=>!l.has(s)),C=k.map(s=>m.get(s)),_=new Map,i=$();if(C.length>0){const{data:s,error:f}=await i.from("tags").select("id,name,is_custom").in("name",C);if(f)throw f;const x=new Map;for(const c of s??[]){if(!c.name||typeof c.id!="number")continue;const y={id:c.id,name:c.name,is_custom:!!c.is_custom},b=w(y.name),g=x.get(b)??[];g.push(y),x.set(b,g)}const M=[];for(const c of k){const y=x.get(c)??[],b=y.find(g=>g.is_custom)??y[0];if(b)_.set(c,b);else{const g=m.get(c);g&&M.push(g)}}if(M.length>0){const{data:c,error:y}=await i.rpc("current_user_group_id");if(y)throw y;if(!c)throw new Error("Could not determine group.");const{data:b,error:g}=await i.from("tags").select("id,name,is_custom").eq("group_id",c).eq("is_custom",!0).in("name",M);if(g)throw g;for(const h of b??[]){if(!h.name||typeof h.id!="number")continue;const A={id:h.id,name:h.name,is_custom:!!h.is_custom};_.set(w(A.name),A)}const J=M.filter(h=>!_.has(w(h)));if(J.length>0){const{data:h,error:A}=await i.from("tags").insert(J.map(j=>({name:j,tmdb_id:null,group_id:c,is_custom:!0}))).select("id,name,is_custom");if(A)throw A;for(const j of h??[]){if(!j.name||typeof j.id!="number")continue;const O={id:j.id,name:j.name,is_custom:!!j.is_custom};_.set(w(O.name),O)}}}}const I=[],W=new Set;for(const s of o){const f=w(s),x=l.get(f)??_.get(f);!x||W.has(x.id)||(W.add(x.id),I.push(x))}const{error:G}=await i.from("entry_tags").delete().eq("entry_id",a);if(G)throw G;if(I.length>0){const{error:s}=await i.from("entry_tags").insert(I.map(f=>({entry_id:a,tag_id:f.id})));if(s)throw s}u(s=>s&&{...s,tags:I}),E(I.map(s=>s.name).join(", ")),D(!0)}catch(o){S(H(o,"Failed to update tags"))}finally{p(!1)}}},[n,a,z]),ae=r.useCallback(async()=>{if(!(!a||K||!window.confirm(n?.title?`Delete "${n.title}" from your list?`:"Delete this entry from your list?"))){R(!0),U(null);try{const l=$(),{error:m}=await l.from("entries").delete().eq("id",a);if(m)throw m;d("/app/list")}catch(l){U(H(l,"Failed to delete entry"))}finally{R(!1)}}},[K,n?.title,a,d]);return t.jsx(he,{entry:n,loading:F,error:L,tagsInput:z,onTagsChange:se,onSaveTags:ne,saving:P,saveError:q,saveSuccess:T,deleting:K,deleteError:te,onDelete:ae})}const Te={leftHeaderAction:{to:"/app/list",icon:t.jsx(pe,{})}};function Ie({}){return[{title:"Video Clerk - Edit Entry"},{name:"description",content:"Edit saved list entries and update tags."}]}const Ae=le(function(){return t.jsx(be,{})});export{Ae as default,Te as handle,Ie as meta};
