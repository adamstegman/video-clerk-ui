import{a as n,C as ge,v as xe,w as he}from"./chunk-JMJ3UQ3L-DPj_BNs_.js";import{j as e}from"./jsx-runtime-u17CrQMm.js";import{c as O}from"./client-B_XR4Hye.js";import{b as pe}from"./tmdb-configuration-BxuIu_6_.js";import{A as J}from"./action-button-BX2IeZ2i.js";import{S as te,a as be}from"./settings-subsection-X7Eq6pXz.js";import{b as X,a as ye,s as U,c as v,e as se,p as we}from"./utils-ByhHhwOs.js";import{c as ke}from"./createLucideIcon-CMzVMv86.js";const je=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],_e=ke("arrow-left",je);function Ne({entry:s,loading:j,error:c,selectedTags:x,availableTags:S,tagQuery:w,suggestions:C,canCreateTag:B,watched:A,onWatchedChange:E,onTagQueryChange:_,onAddTag:k,onRemoveTag:D,onToggleTag:p,onCreateTag:b,onSaveTags:F,saving:L,saveError:M,saveSuccess:W,creatingTag:R,deleting:$,deleteError:Y,onDelete:T}){const N=n.useContext(pe),I=N.images.poster_sizes.length>2?2:N.images.poster_sizes.length-1,q=N.images.poster_sizes[I]||N.images.poster_sizes[0];return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:X,children:e.jsx("div",{className:"flex items-center justify-between gap-4",children:e.jsx("h2",{className:ye,children:"Edit entry"})})}),e.jsxs("div",{className:"flex-1 overflow-y-auto min-h-0 pb-4",children:[j&&!c&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),e.jsx("p",{className:U,children:"Loading entry..."})]})}),c&&e.jsx("p",{className:v("text-sm",se),children:c}),!j&&!c&&s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:X,children:e.jsxs("div",{className:"flex gap-4 md:gap-6 items-start",children:[s.posterPath&&N.images.secure_base_url&&q&&e.jsx("img",{src:`${N.images.secure_base_url}${q}${s.posterPath}`,alt:s.title,className:"flex-shrink-0 w-16 h-24 object-cover rounded md:w-20 md:h-[120px]"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:v("font-bold text-base md:text-lg",we),children:s.title}),s.releaseYear&&e.jsx("p",{className:v("text-sm md:text-base",U),children:s.releaseYear})]})]})}),e.jsx(te,{title:"Status",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{id:"entry-watched",type:"checkbox",checked:A,onChange:i=>E(i.target.checked),className:"h-4 w-4 rounded border-zinc-300 text-indigo-600 focus:ring-indigo-500 dark:border-zinc-700 dark:bg-zinc-950"}),e.jsx("label",{htmlFor:"entry-watched",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Watched"})]})}),e.jsx(te,{title:"Tags",children:e.jsxs(be,{description:"",error:M,success:W?"Tags updated.":null,children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[x.length===0&&e.jsx("p",{className:v("text-sm",U),children:"No tags selected."}),x.map(i=>e.jsx("button",{type:"button",onClick:()=>D(i),className:"rounded-full border border-indigo-200 bg-indigo-50 px-3 py-1 text-xs font-medium text-indigo-700 hover:bg-indigo-100 dark:border-indigo-700 dark:bg-indigo-950 dark:text-indigo-200","aria-label":`Remove tag ${i.name}`,children:i.name},i.id))]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("label",{htmlFor:"entry-tag-query",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Add tag"}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:[e.jsx("input",{id:"entry-tag-query",value:w,onChange:i=>_(i.target.value),onKeyDown:i=>{if(i.key==="Enter"||i.key==="Tab"||i.key===","){if(w.trim().length===0)return;i.preventDefault(),b(w)}},placeholder:"Type a tag name",className:"w-full rounded-md border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder:text-zinc-400 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-100","aria-autocomplete":"list","aria-expanded":C.length>0||B,"aria-controls":"entry-tag-suggestions"}),e.jsx(J,{onClick:()=>b(w),disabled:w.trim().length===0||R,loading:R,loadingText:"Adding...",variant:"secondary",size:"sm",className:"sm:w-auto",children:"Add"})]}),(C.length>0||B)&&e.jsxs("div",{id:"entry-tag-suggestions",role:"listbox",className:"rounded-md border border-zinc-200 bg-white p-2 text-sm shadow-sm dark:border-zinc-700 dark:bg-zinc-900",children:[B&&e.jsxs("button",{type:"button",onClick:()=>b(w),className:"w-full rounded-md px-2 py-1 text-left text-indigo-600 hover:bg-indigo-50 dark:text-indigo-300 dark:hover:bg-indigo-900/40",children:['Create "',w.trim(),'"']}),C.map(i=>e.jsx("button",{type:"button",onClick:()=>k(i),className:"w-full rounded-md px-2 py-1 text-left hover:bg-zinc-100 dark:hover:bg-zinc-800",children:i.name},i.id))]})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("p",{className:"text-xs font-medium text-zinc-500 dark:text-zinc-400",children:"Existing tags"}),S.length===0?e.jsx("p",{className:v("text-sm",U),children:"No tags available."}):e.jsx("div",{className:"flex flex-wrap gap-2",children:S.map(i=>{const P=x.some(H=>H.id===i.id);return e.jsx("button",{type:"button",onClick:()=>p(i),"aria-pressed":P,className:v("rounded-full border px-3 py-1 text-xs font-medium transition",P?"border-indigo-400 bg-indigo-500 text-white hover:bg-indigo-400 dark:border-indigo-500 dark:bg-indigo-500":"border-zinc-200 bg-white text-zinc-600 hover:bg-zinc-100 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-200 dark:hover:bg-zinc-800"),children:i.name},i.id)})})]})]})}),e.jsxs("div",{className:v(X,"flex flex-col gap-3 md:flex-row md:items-start md:justify-between"),children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(J,{onClick:T,loading:$,loadingText:"Deleting...",variant:"secondary",className:"border border-red-300 text-red-600 hover:bg-red-50 dark:border-red-700 dark:text-red-400 dark:hover:bg-red-900/20 w-full md:w-auto",children:"Delete entry"}),Y&&e.jsx("p",{className:v("text-sm",se),children:Y})]}),e.jsx(J,{onClick:F,loading:L,disabled:!s||R,loadingText:"Saving...",className:"w-full md:w-auto md:ml-auto",children:"Save"})]})]})]})]})}function ze(s){return s&&s.split("-")[0]||""}function ve(s){return s?Array.isArray(s)?s[0]??null:s:null}function Se(s){return s?Array.isArray(s)?s[0]??null:s:null}function m(s){return G(s).toLowerCase()}function G(s){return s.trim().replace(/\s+/g," ")}function V(s,j){return s instanceof Error?s.message:typeof s=="object"&&s!==null&&"message"in s&&typeof s.message=="string"?String(s.message):j}function Ce(){const s=ge(),j=xe(),c=n.useMemo(()=>{const t=s.entryId;if(!t)return null;const a=Number(t);return Number.isFinite(a)&&a>0?Math.trunc(a):null},[s.entryId]),[x,S]=n.useState(null),[w,C]=n.useState(!0),[B,A]=n.useState(null),[E,_]=n.useState([]),[k,D]=n.useState([]),[p,b]=n.useState(""),[F,L]=n.useState(!1),[M,W]=n.useState(null),[R,$]=n.useState(!1),[Y,T]=n.useState(null),[N,I]=n.useState(!1),[q,i]=n.useState(!1),[P,H]=n.useState(!1),[ae,Z]=n.useState(null),Q=n.useCallback(async()=>{if(!c){S(null),A("Invalid entry."),C(!1);return}C(!0),A(null);try{const t=O(),a=F?M??new Date().toISOString():null,{error:r}=await t.from("entries").update({watched_at:a}).eq("id",c);if(r)throw r;const[o,f]=await Promise.all([t.from("entries").select(`
              id,
              added_at,
              watched_at,
              tmdb_details (
                poster_path,
                name,
                release_date
              ),
              entry_tags (
                tags (
                  id,
                  name,
                  is_custom
                )
              )
            `).eq("id",c).maybeSingle(),t.from("tags").select("id,name,is_custom").order("name")]);if(o.error)throw o.error;if(!o.data){S(null),A("Entry not found.");return}if(f.error)console.error("Failed to load tags",f.error),D([]);else{const u=f.data?.filter(h=>h.name&&typeof h.id=="number").map(h=>({id:h.id,name:h.name,is_custom:!!h.is_custom}))??[];D(u)}const d=o.data,g=ve(d.tmdb_details),l=d.entry_tags?.map(u=>Se(u.tags)).filter(u=>!!u&&typeof u.id=="number"&&!!u.name).map(u=>({id:u.id,name:u.name,is_custom:!!u.is_custom}))??[];S({id:d.id,title:g?.name||"Untitled",releaseYear:ze(g?.release_date??null),posterPath:g?.poster_path??null}),_(l),L(!!d.watched_at),W(d.watched_at??null)}catch(t){S(null),A(V(t,"Failed to load entry"))}finally{C(!1)}},[c]);n.useEffect(()=>{Q()},[Q]),n.useEffect(()=>{x&&(b(""),T(null),I(!1))},[x?.id]);const y=n.useCallback(()=>{T(null),I(!1)},[]),ne=n.useCallback(t=>{b(t),y()},[y]),re=n.useCallback(t=>{_(a=>a.some(o=>m(o.name)===m(t.name))?a:[...a,t]),b(""),y()},[y]),ie=n.useCallback(t=>{_(a=>a.filter(r=>r.id!==t.id)),y()},[y]),oe=n.useCallback(t=>{_(a=>a.some(o=>o.id===t.id)?a.filter(o=>o.id!==t.id):[...a,t]),b(""),y()},[y]),ee=n.useCallback(async(t,a)=>{const r=G(a);if(!r)return null;const{data:o,error:f}=await t.from("tags").select("id,name,is_custom").ilike("name",r);if(f)throw f;const d=o?.filter(l=>l.name&&typeof l.id=="number").map(l=>({id:l.id,name:l.name,is_custom:!!l.is_custom}))??[];if(d.length===0)return null;const g=d.find(l=>l.is_custom)??d[0]??null;return g?(D(l=>l.some(h=>m(h.name)===m(g.name))?l:[...l,g]),g):null},[]),K=n.useCallback(async t=>{const a=G(t);if(!a)return null;const r=m(a),o=k.find(z=>m(z.name)===r);if(o)return o;const f=O(),{data:d,error:g}=await f.rpc("current_user_group_id");if(g)throw g;if(!d)throw new Error("Could not determine group.");const{data:l,error:u}=await f.from("tags").insert({name:a,tmdb_id:null,group_id:d,is_custom:!0}).select("id,name,is_custom").maybeSingle();if(u){const z=await ee(f,a);if(z)return z;throw u}if(!l||!l.name||typeof l.id!="number")return null;const h={id:l.id,name:l.name,is_custom:!!l.is_custom};return D(z=>z.some(fe=>m(fe.name)===r)?z:[...z,h]),h},[k,ee]),le=n.useCallback(async t=>{if(q)return;const a=G(t);if(a){i(!0),y();try{const r=await K(a);r&&_(o=>o.some(d=>m(d.name)===m(r.name))?o:[...o,r]),b("")}catch(r){T(V(r,"Failed to create tag"))}finally{i(!1)}}},[q,K,y]),de=n.useMemo(()=>{const t=m(p);if(!t)return[];const a=new Set(E.map(r=>m(r.name)));return k.filter(r=>{const o=m(r.name);return o.includes(t)&&!a.has(o)})},[k,E,p]),ce=n.useMemo(()=>{const t=m(p);return t?!k.some(a=>m(a.name)===t):!1},[k,p]),me=n.useCallback(async()=>{if(!(!c||!x)){$(!0),T(null),I(!1);try{let t=E;if(p.trim().length>0){const d=await K(p);d&&(t.some(l=>m(l.name)===m(d.name))||(t=[...t,d]),_(t)),b("")}const a=O(),r=F?M??new Date().toISOString():null,{error:o}=await a.from("entries").update({watched_at:r}).eq("id",c);if(o)throw o;const{error:f}=await a.from("entry_tags").delete().eq("entry_id",c);if(f)throw f;if(t.length>0){const{error:d}=await a.from("entry_tags").insert(t.map(g=>({entry_id:c,tag_id:g.id})));if(d)throw d}W(r),I(!0)}catch(t){T(V(t,"Failed to update tags"))}finally{$(!1)}}},[x,c,K,E,p,F,M]),ue=n.useCallback(async()=>{if(!(!c||P||!window.confirm(x?.title?`Delete "${x.title}" from your list?`:"Delete this entry from your list?"))){H(!0),Z(null);try{const a=O(),{error:r}=await a.from("entries").delete().eq("id",c);if(r)throw r;j("/app/list")}catch(a){Z(V(a,"Failed to delete entry"))}finally{H(!1)}}},[P,x?.title,c,j]);return e.jsx(Ne,{entry:x,loading:w,error:B,selectedTags:E,availableTags:k,tagQuery:p,suggestions:de,canCreateTag:ce,watched:F,onWatchedChange:L,onTagQueryChange:ne,onAddTag:re,onRemoveTag:ie,onToggleTag:oe,onCreateTag:le,onSaveTags:me,saving:R,saveError:Y,saveSuccess:N,creatingTag:q,deleting:P,deleteError:ae,onDelete:ue})}const Me={leftHeaderAction:{to:"/app/list",icon:e.jsx(_e,{})}};function Re({}){return[{title:"Video Clerk - Edit Entry"},{name:"description",content:"Edit saved list entries and update tags."}]}const Le=he(function(){return e.jsx(Ce,{})});export{Le as default,Me as handle,Re as meta};
