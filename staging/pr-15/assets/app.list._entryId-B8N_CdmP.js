import{a as r,C as de,v as ce,w as me}from"./chunk-JMJ3UQ3L-DPj_BNs_.js";import{j as e}from"./jsx-runtime-u17CrQMm.js";import{c as Y}from"./client-B_XR4Hye.js";import{b as ue}from"./tmdb-configuration-BxuIu_6_.js";import{A as J}from"./action-button-BX2IeZ2i.js";import{S as fe,a as ge}from"./settings-subsection-X7Eq6pXz.js";import{b as O,a as xe,s as H,c as v,e as Z,p as pe}from"./utils-ByhHhwOs.js";import{c as he}from"./createLucideIcon-CMzVMv86.js";const be=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],ye=he("arrow-left",be);function ke({entry:n,loading:k,error:m,selectedTags:f,availableTags:z,tagQuery:b,suggestions:C,canCreateTag:F,onTagQueryChange:E,onAddTag:S,onRemoveTag:j,onToggleTag:y,onCreateTag:w,onSaveTags:x,saving:N,saveError:V,saveSuccess:P,creatingTag:I,deleting:T,deleteError:q,onDelete:A}){const p=r.useContext(ue),M=p.images.poster_sizes.length>2?2:p.images.poster_sizes.length-1,D=p.images.poster_sizes[M]||p.images.poster_sizes[0];return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:O,children:e.jsx("div",{className:"flex items-center justify-between gap-4",children:e.jsx("h2",{className:xe,children:"Edit entry"})})}),e.jsxs("div",{className:"flex-1 overflow-y-auto min-h-0 pb-4",children:[k&&!m&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),e.jsx("p",{className:H,children:"Loading entry..."})]})}),m&&e.jsx("p",{className:v("text-sm",Z),children:m}),!k&&!m&&n&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:O,children:e.jsxs("div",{className:"flex gap-4 md:gap-6 items-start",children:[n.posterPath&&p.images.secure_base_url&&D&&e.jsx("img",{src:`${p.images.secure_base_url}${D}${n.posterPath}`,alt:n.title,className:"flex-shrink-0 w-16 h-24 object-cover rounded md:w-20 md:h-[120px]"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:v("font-bold text-base md:text-lg",pe),children:n.title}),n.releaseYear&&e.jsx("p",{className:v("text-sm md:text-base",H),children:n.releaseYear})]})]})}),e.jsx(fe,{title:"Tags",children:e.jsxs(ge,{description:"",error:V,success:P?"Tags updated.":null,children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[f.length===0&&e.jsx("p",{className:v("text-sm",H),children:"No tags selected."}),f.map(l=>e.jsx("button",{type:"button",onClick:()=>j(l),className:"rounded-full border border-indigo-200 bg-indigo-50 px-3 py-1 text-xs font-medium text-indigo-700 hover:bg-indigo-100 dark:border-indigo-700 dark:bg-indigo-950 dark:text-indigo-200","aria-label":`Remove tag ${l.name}`,children:l.name},l.id))]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("label",{htmlFor:"entry-tag-query",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Add tag"}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:[e.jsx("input",{id:"entry-tag-query",value:b,onChange:l=>E(l.target.value),onKeyDown:l=>{if(l.key==="Enter"||l.key==="Tab"||l.key===","){if(b.trim().length===0)return;l.preventDefault(),w(b)}},placeholder:"Type a tag name",className:"w-full rounded-md border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder:text-zinc-400 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-100","aria-autocomplete":"list","aria-expanded":C.length>0||F,"aria-controls":"entry-tag-suggestions"}),e.jsx(J,{onClick:()=>w(b),disabled:b.trim().length===0||I,loading:I,loadingText:"Adding...",variant:"secondary",size:"sm",className:"sm:w-auto",children:"Add"})]}),(C.length>0||F)&&e.jsxs("div",{id:"entry-tag-suggestions",role:"listbox",className:"rounded-md border border-zinc-200 bg-white p-2 text-sm shadow-sm dark:border-zinc-700 dark:bg-zinc-900",children:[F&&e.jsxs("button",{type:"button",onClick:()=>w(b),className:"w-full rounded-md px-2 py-1 text-left text-indigo-600 hover:bg-indigo-50 dark:text-indigo-300 dark:hover:bg-indigo-900/40",children:['Create "',b.trim(),'"']}),C.map(l=>e.jsx("button",{type:"button",onClick:()=>S(l),className:"w-full rounded-md px-2 py-1 text-left hover:bg-zinc-100 dark:hover:bg-zinc-800",children:l.name},l.id))]})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("p",{className:"text-xs font-medium text-zinc-500 dark:text-zinc-400",children:"Existing tags"}),z.length===0?e.jsx("p",{className:v("text-sm",H),children:"No tags available."}):e.jsx("div",{className:"flex flex-wrap gap-2",children:z.map(l=>{const R=f.some(B=>B.id===l.id);return e.jsx("button",{type:"button",onClick:()=>y(l),"aria-pressed":R,className:v("rounded-full border px-3 py-1 text-xs font-medium transition",R?"border-indigo-400 bg-indigo-500 text-white hover:bg-indigo-400 dark:border-indigo-500 dark:bg-indigo-500":"border-zinc-200 bg-white text-zinc-600 hover:bg-zinc-100 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-200 dark:hover:bg-zinc-800"),children:l.name},l.id)})})]})]})}),e.jsxs("div",{className:v(O,"flex flex-col gap-3 md:flex-row md:items-start md:justify-between"),children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(J,{onClick:A,loading:T,loadingText:"Deleting...",variant:"secondary",className:"border border-red-300 text-red-600 hover:bg-red-50 dark:border-red-700 dark:text-red-400 dark:hover:bg-red-900/20 w-full md:w-auto",children:"Delete entry"}),q&&e.jsx("p",{className:v("text-sm",Z),children:q})]}),e.jsx(J,{onClick:x,loading:N,disabled:!n||I,loadingText:"Saving...",className:"w-full md:w-auto md:ml-auto",children:"Save"})]})]})]})]})}function je(n){return n&&n.split("-")[0]||""}function we(n){return n?Array.isArray(n)?n[0]??null:n:null}function Ne(n){return n?Array.isArray(n)?n[0]??null:n:null}function c(n){return U(n).toLowerCase()}function U(n){return n.trim().replace(/\s+/g," ")}function K(n,k){return n instanceof Error?n.message:typeof n=="object"&&n!==null&&"message"in n&&typeof n.message=="string"?String(n.message):k}function _e(){const n=de(),k=ce(),m=r.useMemo(()=>{const t=n.entryId;if(!t)return null;const s=Number(t);return Number.isFinite(s)&&s>0?Math.trunc(s):null},[n.entryId]),[f,z]=r.useState(null),[b,C]=r.useState(!0),[F,E]=r.useState(null),[S,j]=r.useState([]),[y,w]=r.useState([]),[x,N]=r.useState(""),[V,P]=r.useState(!1),[I,T]=r.useState(null),[q,A]=r.useState(!1),[p,M]=r.useState(!1),[D,l]=r.useState(!1),[R,B]=r.useState(null),W=r.useCallback(async()=>{if(!m){z(null),E("Invalid entry."),C(!1);return}C(!0),E(null);try{const t=Y(),[s,a]=await Promise.all([t.from("entries").select(`
              id,
              added_at,
              tmdb_details (
                poster_path,
                name,
                release_date
              ),
              entry_tags (
                tags (
                  id,
                  name,
                  is_custom
                )
              )
            `).eq("id",m).maybeSingle(),t.from("tags").select("id,name,is_custom").order("name")]);if(s.error)throw s.error;if(!s.data){z(null),E("Entry not found.");return}if(a.error)console.error("Failed to load tags",a.error),w([]);else{const d=a.data?.filter(o=>o.name&&typeof o.id=="number").map(o=>({id:o.id,name:o.name,is_custom:!!o.is_custom}))??[];w(d)}const i=s.data,u=we(i.tmdb_details),g=i.entry_tags?.map(d=>Ne(d.tags)).filter(d=>!!d&&typeof d.id=="number"&&!!d.name).map(d=>({id:d.id,name:d.name,is_custom:!!d.is_custom}))??[];z({id:i.id,title:u?.name||"Untitled",releaseYear:je(u?.release_date??null),posterPath:u?.poster_path??null}),j(g)}catch(t){z(null),E(K(t,"Failed to load entry"))}finally{C(!1)}},[m]);r.useEffect(()=>{W()},[W]),r.useEffect(()=>{f&&(N(""),T(null),A(!1))},[f?.id]);const h=r.useCallback(()=>{T(null),A(!1)},[]),Q=r.useCallback(t=>{N(t),h()},[h]),ee=r.useCallback(t=>{j(s=>s.some(i=>c(i.name)===c(t.name))?s:[...s,t]),N(""),h()},[h]),te=r.useCallback(t=>{j(s=>s.filter(a=>a.id!==t.id)),h()},[h]),se=r.useCallback(t=>{j(s=>s.some(i=>i.id===t.id)?s.filter(i=>i.id!==t.id):[...s,t]),N(""),h()},[h]),X=r.useCallback(async(t,s)=>{const a=U(s);if(!a)return null;const{data:i,error:u}=await t.from("tags").select("id,name,is_custom").ilike("name",a);if(u)throw u;const g=i?.filter(o=>o.name&&typeof o.id=="number").map(o=>({id:o.id,name:o.name,is_custom:!!o.is_custom}))??[];if(g.length===0)return null;const d=g.find(o=>o.is_custom)??g[0]??null;return d?(w(o=>o.some($=>c($.name)===c(d.name))?o:[...o,d]),d):null},[]),L=r.useCallback(async t=>{const s=U(t);if(!s)return null;const a=c(s),i=y.find(_=>c(_.name)===a);if(i)return i;const u=Y(),{data:g,error:d}=await u.rpc("current_user_group_id");if(d)throw d;if(!g)throw new Error("Could not determine group.");const{data:o,error:G}=await u.from("tags").insert({name:s,tmdb_id:null,group_id:g,is_custom:!0}).select("id,name,is_custom").maybeSingle();if(G){const _=await X(u,s);if(_)return _;throw G}if(!o||!o.name||typeof o.id!="number")return null;const $={id:o.id,name:o.name,is_custom:!!o.is_custom};return w(_=>_.some(le=>c(le.name)===a)?_:[..._,$]),$},[y,X]),ne=r.useCallback(async t=>{if(p)return;const s=U(t);if(s){M(!0),h();try{const a=await L(s);a&&j(i=>i.some(g=>c(g.name)===c(a.name))?i:[...i,a]),N("")}catch(a){T(K(a,"Failed to create tag"))}finally{M(!1)}}},[p,L,h]),ae=r.useMemo(()=>{const t=c(x);if(!t)return[];const s=new Set(S.map(a=>c(a.name)));return y.filter(a=>{const i=c(a.name);return i.includes(t)&&!s.has(i)})},[y,S,x]),re=r.useMemo(()=>{const t=c(x);return t?!y.some(s=>c(s.name)===t):!1},[y,x]),ie=r.useCallback(async()=>{if(!(!m||!f)){P(!0),T(null),A(!1);try{let t=S;if(x.trim().length>0){const i=await L(x);i&&(t.some(g=>c(g.name)===c(i.name))||(t=[...t,i]),j(t)),N("")}const s=Y(),{error:a}=await s.from("entry_tags").delete().eq("entry_id",m);if(a)throw a;if(t.length>0){const{error:i}=await s.from("entry_tags").insert(t.map(u=>({entry_id:m,tag_id:u.id})));if(i)throw i}A(!0)}catch(t){T(K(t,"Failed to update tags"))}finally{P(!1)}}},[f,m,L,S,x]),oe=r.useCallback(async()=>{if(!(!m||D||!window.confirm(f?.title?`Delete "${f.title}" from your list?`:"Delete this entry from your list?"))){l(!0),B(null);try{const s=Y(),{error:a}=await s.from("entries").delete().eq("id",m);if(a)throw a;k("/app/list")}catch(s){B(K(s,"Failed to delete entry"))}finally{l(!1)}}},[D,f?.title,m,k]);return e.jsx(ke,{entry:f,loading:b,error:F,selectedTags:S,availableTags:y,tagQuery:x,suggestions:ae,canCreateTag:re,onTagQueryChange:Q,onAddTag:ee,onRemoveTag:te,onToggleTag:se,onCreateTag:ne,onSaveTags:ie,saving:V,saveError:I,saveSuccess:q,creatingTag:p,deleting:D,deleteError:R,onDelete:oe})}const Ie={leftHeaderAction:{to:"/app/list",icon:e.jsx(ye,{})}};function Pe({}){return[{title:"Video Clerk - Edit Entry"},{name:"description",content:"Edit saved list entries and update tags."}]}const qe=me(function(){return e.jsx(_e,{})});export{qe as default,Ie as handle,Pe as meta};
