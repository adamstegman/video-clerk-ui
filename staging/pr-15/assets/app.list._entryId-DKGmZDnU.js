import{a as r,x as le,C as de,v as ce,w as me}from"./chunk-JMJ3UQ3L-DPj_BNs_.js";import{j as e}from"./jsx-runtime-u17CrQMm.js";import{c as Y}from"./client-B_XR4Hye.js";import{b as ue}from"./tmdb-configuration-BxuIu_6_.js";import{A as G}from"./action-button-BX2IeZ2i.js";import{S as fe,a as ge}from"./settings-subsection-X7Eq6pXz.js";import{b as H,a as xe,s as K,c as E,e as X,p as he}from"./utils-ByhHhwOs.js";import{c as pe}from"./createLucideIcon-CMzVMv86.js";const be=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],ye=pe("arrow-left",be);function ke({entry:n,loading:y,error:c,selectedTags:g,availableTags:N,tagQuery:p,suggestions:_,canCreateTag:q,onTagQueryChange:A,onAddTag:C,onRemoveTag:k,onToggleTag:b,onCreateTag:j,onSaveTags:x,saving:v,saveError:V,saveSuccess:B,creatingTag:P,deleting:S,deleteError:I,onDelete:D}){const z=r.useContext(ue),T=z.images.backdrop_sizes,F=T.length>1?T[1]:T.length===1?T[0]:"";return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:H,children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("h2",{className:xe,children:"Edit entry"}),e.jsx(le,{to:"/app/list",className:"text-sm font-medium text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300",children:"Back to list"})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto min-h-0 pb-4",children:[y&&!c&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),e.jsx("p",{className:K,children:"Loading entry..."})]})}),c&&e.jsx("p",{className:E("text-sm",X),children:c}),!y&&!c&&n&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:H,children:[n.backdropPath&&z.images.secure_base_url&&F&&e.jsx("img",{src:`${z.images.secure_base_url}${F}${n.backdropPath}`,alt:`${n.title} backdrop`,className:"w-full rounded-lg object-cover aspect-[21/9] mb-4"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:E("font-bold text-base md:text-lg",he),children:n.title}),n.releaseYear&&e.jsx("p",{className:E("text-sm md:text-base",K),children:n.releaseYear})]})]}),e.jsx(fe,{title:"Tags",children:e.jsxs(ge,{description:"Separate tags with commas to add or remove labels for this entry.",error:V,success:B?"Tags updated.":null,children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[g.length===0&&e.jsx("p",{className:E("text-sm",K),children:"No tags selected."}),g.map(l=>e.jsx("button",{type:"button",onClick:()=>k(l),className:"rounded-full border border-indigo-200 bg-indigo-50 px-3 py-1 text-xs font-medium text-indigo-700 hover:bg-indigo-100 dark:border-indigo-700 dark:bg-indigo-950 dark:text-indigo-200","aria-label":`Remove tag ${l.name}`,children:l.name},l.id))]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("label",{htmlFor:"entry-tag-query",className:"text-sm font-medium text-zinc-700 dark:text-zinc-300",children:"Add tag"}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:[e.jsx("input",{id:"entry-tag-query",value:p,onChange:l=>A(l.target.value),onKeyDown:l=>{if(l.key==="Enter"||l.key==="Tab"||l.key===","){if(p.trim().length===0)return;l.preventDefault(),j(p)}},placeholder:"Type a tag name",className:"w-full rounded-md border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder:text-zinc-400 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-100","aria-autocomplete":"list","aria-expanded":_.length>0||q,"aria-controls":"entry-tag-suggestions"}),e.jsx(G,{onClick:()=>j(p),disabled:p.trim().length===0||P,loading:P,loadingText:"Adding...",variant:"secondary",size:"sm",className:"sm:w-auto",children:"Add"})]}),(_.length>0||q)&&e.jsxs("div",{id:"entry-tag-suggestions",role:"listbox",className:"rounded-md border border-zinc-200 bg-white p-2 text-sm shadow-sm dark:border-zinc-700 dark:bg-zinc-900",children:[q&&e.jsxs("button",{type:"button",onClick:()=>j(p),className:"w-full rounded-md px-2 py-1 text-left text-indigo-600 hover:bg-indigo-50 dark:text-indigo-300 dark:hover:bg-indigo-900/40",children:['Create "',p.trim(),'"']}),_.map(l=>e.jsx("button",{type:"button",onClick:()=>C(l),className:"w-full rounded-md px-2 py-1 text-left hover:bg-zinc-100 dark:hover:bg-zinc-800",children:l.name},l.id))]})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("p",{className:"text-xs font-medium text-zinc-500 dark:text-zinc-400",children:"Existing tags"}),N.length===0?e.jsx("p",{className:E("text-sm",K),children:"No tags available."}):e.jsx("div",{className:"flex flex-wrap gap-2",children:N.map(l=>{const L=g.some(M=>M.id===l.id);return e.jsx("button",{type:"button",onClick:()=>b(l),"aria-pressed":L,className:E("rounded-full border px-3 py-1 text-xs font-medium transition",L?"border-indigo-400 bg-indigo-500 text-white hover:bg-indigo-400 dark:border-indigo-500 dark:bg-indigo-500":"border-zinc-200 bg-white text-zinc-600 hover:bg-zinc-100 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-200 dark:hover:bg-zinc-800"),children:l.name},l.id)})})]})]})}),e.jsx("div",{className:H,children:e.jsx(G,{onClick:x,loading:v,disabled:!n||P,loadingText:"Saving...",className:"w-full sm:w-auto",children:"Save"})}),e.jsx("div",{className:H,children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(G,{onClick:D,loading:S,loadingText:"Deleting...",variant:"secondary",className:"border border-red-300 text-red-600 hover:bg-red-50 dark:border-red-700 dark:text-red-400 dark:hover:bg-red-900/20",children:"Delete entry"}),I&&e.jsx("p",{className:E("text-sm",X),children:I})]})})]})]})]})}function je(n){return n&&n.split("-")[0]||""}function ve(n){return n?Array.isArray(n)?n[0]??null:n:null}function we(n){return n?Array.isArray(n)?n[0]??null:n:null}function d(n){return n.trim().toLowerCase()}function U(n,y){return n instanceof Error?n.message:typeof n=="object"&&n!==null&&"message"in n&&typeof n.message=="string"?String(n.message):y}function Ne(){const n=de(),y=ce(),c=r.useMemo(()=>{const t=n.entryId;if(!t)return null;const s=Number(t);return Number.isFinite(s)&&s>0?Math.trunc(s):null},[n.entryId]),[g,N]=r.useState(null),[p,_]=r.useState(!0),[q,A]=r.useState(null),[C,k]=r.useState([]),[b,j]=r.useState([]),[x,v]=r.useState(""),[V,B]=r.useState(!1),[P,S]=r.useState(null),[I,D]=r.useState(!1),[z,T]=r.useState(!1),[F,l]=r.useState(!1),[L,M]=r.useState(null),J=r.useCallback(async()=>{if(!c){N(null),A("Invalid entry."),_(!1);return}_(!0),A(null);try{const t=Y(),[s,i]=await Promise.all([t.from("entries").select(`
              id,
              added_at,
              tmdb_details (
                backdrop_path,
                name,
                release_date
              ),
              entry_tags (
                tags (
                  id,
                  name,
                  is_custom
                )
              )
            `).eq("id",c).maybeSingle(),t.from("tags").select("id,name,is_custom").order("name")]);if(s.error)throw s.error;if(!s.data){N(null),A("Entry not found.");return}if(i.error)console.error("Failed to load tags",i.error),j([]);else{const o=i.data?.filter(u=>u.name&&typeof u.id=="number").map(u=>({id:u.id,name:u.name,is_custom:!!u.is_custom}))??[];j(o)}const a=s.data,m=ve(a.tmdb_details),f=a.entry_tags?.map(o=>we(o.tags)).filter(o=>!!o&&typeof o.id=="number"&&!!o.name).map(o=>({id:o.id,name:o.name,is_custom:!!o.is_custom}))??[];N({id:a.id,title:m?.name||"Untitled",releaseYear:je(m?.release_date??null),backdropPath:m?.backdrop_path??null}),k(f)}catch(t){N(null),A(U(t,"Failed to load entry"))}finally{_(!1)}},[c]);r.useEffect(()=>{J()},[J]),r.useEffect(()=>{g&&(v(""),S(null),D(!1))},[g?.id]);const h=r.useCallback(()=>{S(null),D(!1)},[]),Z=r.useCallback(t=>{v(t),h()},[h]),Q=r.useCallback(t=>{k(s=>s.some(a=>d(a.name)===d(t.name))?s:[...s,t]),v(""),h()},[h]),ee=r.useCallback(t=>{k(s=>s.filter(i=>i.id!==t.id)),h()},[h]),te=r.useCallback(t=>{k(s=>s.some(a=>a.id===t.id)?s.filter(a=>a.id!==t.id):[...s,t]),v(""),h()},[h]),O=r.useCallback(async(t,s)=>{const{data:i,error:a}=await t.from("tags").select("id,name,is_custom").eq("name",s);if(a)throw a;const m=i?.filter(o=>o.name&&typeof o.id=="number").map(o=>({id:o.id,name:o.name,is_custom:!!o.is_custom}))??[];if(m.length===0)return null;const f=m.find(o=>o.is_custom)??m[0]??null;return f?(j(o=>o.some($=>d($.name)===d(f.name))?o:[...o,f]),f):null},[]),R=r.useCallback(async t=>{const s=t.trim();if(!s)return null;const i=d(s),a=b.find(w=>d(w.name)===i);if(a)return a;const m=Y(),{data:f,error:o}=await m.rpc("current_user_group_id");if(o)throw o;if(!f)throw new Error("Could not determine group.");const{data:u,error:$}=await m.from("tags").insert({name:s,tmdb_id:null,group_id:f,is_custom:!0}).select("id,name,is_custom").maybeSingle();if($){const w=await O(m,s);if(w)return w;throw $}if(!u||!u.name||typeof u.id!="number")return null;const W={id:u.id,name:u.name,is_custom:!!u.is_custom};return j(w=>w.some(oe=>d(oe.name)===i)?w:[...w,W]),W},[b,O]),se=r.useCallback(async t=>{if(z)return;const s=t.trim();if(s){T(!0),h();try{const i=await R(s);i&&k(a=>a.some(f=>d(f.name)===d(i.name))?a:[...a,i]),v("")}catch(i){S(U(i,"Failed to create tag"))}finally{T(!1)}}},[z,R,h]),ne=r.useMemo(()=>{const t=d(x);if(!t)return[];const s=new Set(C.map(i=>d(i.name)));return b.filter(i=>{const a=d(i.name);return a.includes(t)&&!s.has(a)})},[b,C,x]),ae=r.useMemo(()=>{const t=d(x);return t?!b.some(s=>d(s.name)===t):!1},[b,x]),re=r.useCallback(async()=>{if(!(!c||!g)){B(!0),S(null),D(!1);try{let t=C;if(x.trim().length>0){const a=await R(x);a&&(t.some(f=>d(f.name)===d(a.name))||(t=[...t,a]),k(t)),v("")}const s=Y(),{error:i}=await s.from("entry_tags").delete().eq("entry_id",c);if(i)throw i;if(t.length>0){const{error:a}=await s.from("entry_tags").insert(t.map(m=>({entry_id:c,tag_id:m.id})));if(a)throw a}D(!0)}catch(t){S(U(t,"Failed to update tags"))}finally{B(!1)}}},[g,c,R,C,x]),ie=r.useCallback(async()=>{if(!(!c||F||!window.confirm(g?.title?`Delete "${g.title}" from your list?`:"Delete this entry from your list?"))){l(!0),M(null);try{const s=Y(),{error:i}=await s.from("entries").delete().eq("id",c);if(i)throw i;y("/app/list")}catch(s){M(U(s,"Failed to delete entry"))}finally{l(!1)}}},[F,g?.title,c,y]);return e.jsx(ke,{entry:g,loading:p,error:q,selectedTags:C,availableTags:b,tagQuery:x,suggestions:ne,canCreateTag:ae,onTagQueryChange:Z,onAddTag:Q,onRemoveTag:ee,onToggleTag:te,onCreateTag:se,onSaveTags:re,saving:V,saveError:P,saveSuccess:I,creatingTag:z,deleting:F,deleteError:L,onDelete:ie})}const qe={leftHeaderAction:{to:"/app/list",icon:e.jsx(ye,{})}};function Pe({}){return[{title:"Video Clerk - Edit Entry"},{name:"description",content:"Edit saved list entries and update tags."}]}const Be=me(function(){return e.jsx(Ne,{})});export{Be as default,qe as handle,Pe as meta};
