import{j as e}from"./jsx-runtime-u17CrQMm.js";import{a as n,C as J,v as Q}from"./chunk-JMJ3UQ3L-DNRSL2Hf.js";import{c as $}from"./client-B_XR4Hye.js";import{b as Z}from"./tmdb-configuration-CpwZmLCk.js";import{a as ee,c as g,s as k,p as B}from"./utils-ByhHhwOs.js";function F(t,m,x){return Math.min(x,Math.max(m,t))}function X(t){return{x:t.clientX,y:t.clientY}}function L({entry:t,isTop:m,style:x,onPointerDown:M,likeOpacity:T,nopeOpacity:C}){const f=n.useContext(Z),N=n.useMemo(()=>{const d=f.images.poster_sizes;if(!d.length)return null;const c=d.length>4?3:d.length-1;return d[c]||d[0]||null},[f.images.poster_sizes]),S=n.useMemo(()=>{const d=f.images.backdrop_sizes;if(!d.length)return null;const c=d.length>2?1:d.length-1;return d[c]||d[0]||null},[f.images.backdrop_sizes]),z=f.images.secure_base_url&&(t.backdropPath||t.posterPath)?t.backdropPath&&S?`${f.images.secure_base_url}${S}${t.backdropPath}`:t.posterPath&&N?`${f.images.secure_base_url}${N}${t.posterPath}`:null:null,j=t.mediaType==="movie"?"Movie":t.mediaType==="tv"?"TV":t.mediaType,_=t.tags.length>0?` | ${t.tags.join(", ")}`:"";return e.jsx("div",{className:g("absolute inset-0 rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 shadow-lg","overflow-hidden select-none touch-none",m?"cursor-grab active:cursor-grabbing":"pointer-events-none"),style:x,onPointerDown:M,role:m?"group":void 0,"aria-label":m?`Swipe card for ${t.title}`:void 0,children:e.jsxs("div",{className:"flex h-full w-full flex-col",children:[e.jsxs("div",{className:"relative w-full flex-none shrink-0 basis-[62%]",children:[z?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:z,alt:t.title,className:"absolute inset-0 h-full w-full object-cover",draggable:!1}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/45 via-black/15 to-black/0"})]}):e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-zinc-900 via-zinc-800 to-zinc-700"}),e.jsx("div",{className:"absolute left-4 top-4 rounded-lg border-2 border-emerald-300 bg-emerald-500/10 px-3 py-1 text-lg font-extrabold tracking-widest text-emerald-100",style:{opacity:T},children:"LIKE"}),e.jsx("div",{className:"absolute right-4 top-4 rounded-lg border-2 border-rose-300 bg-rose-500/10 px-3 py-1 text-lg font-extrabold tracking-widest text-rose-100",style:{opacity:C},children:"NOPE"})]}),e.jsxs("div",{className:"flex-1 min-h-0 border-t border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-5 pt-5 pb-6",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("h3",{className:g("text-xl font-bold",B),children:t.title}),t.releaseYear&&e.jsx("span",{className:g("text-sm",k),children:t.releaseYear})]}),t.overview&&e.jsx("p",{className:g("mt-2 line-clamp-4 text-sm",k),children:t.overview}),e.jsxs("p",{className:g("mt-3 text-xs",k),children:[j,_]})]})]})})}function te({initialEntries:t,loading:m,error:x,onReload:M,winnerEntryId:T,winnerEntry:C,winnerLoading:f,winnerError:N,onGoToWinner:S,onMarkWatched:z,onBackToCards:j}){const[_,d]=n.useState([]),[c,P]=n.useState([]),[y,W]=n.useState(null),[I,O]=n.useState(!1),[r,i]=n.useState(null),[a,b]=n.useState({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null}),u=n.useRef(null),h=()=>{d(t),P([]),W(null),i(null),O(!1),b({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null})};n.useEffect(()=>{h()},[t]),n.useEffect(()=>()=>{u.current&&window.clearTimeout(u.current)},[]);const l=_[0]??null,D=_.slice(1,4),v=110,w=t.length===0?0:t.length<3?1:3,q=w>0&&c.length>=w,G=l?F(Math.max(0,a.dx)/v,0,1):0,H=l?F(Math.max(0,-a.dx)/v,0,1):0;function E(s){if(!l)return;const o=s==="like"?420:-420;b(p=>({...p,animatingOut:!0,decision:s,dx:o,dy:p.dy,isDragging:!1,activeId:l.id})),u.current&&window.clearTimeout(u.current),u.current=window.setTimeout(()=>{d(p=>p.slice(1)),s==="like"&&P(p=>p.length>=w?p:[...p,l]),b({activeId:null,startX:0,startY:0,dx:0,dy:0,isDragging:!1,animatingOut:!1,decision:null})},220)}async function K(s){O(!0),i(null);try{await z(s)}catch(o){const p=o instanceof Error?o.message:typeof o=="object"&&o!==null&&"message"in o&&typeof o.message=="string"?String(o.message):"Failed to mark watched";i(p)}finally{O(!1)}}const V=T!==null;return e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsxs("div",{className:"flex-shrink-0 pb-2 pt-4",children:[e.jsx("h2",{className:ee,children:"Watch"}),e.jsx("p",{className:g("mt-1 text-sm",k),children:"Swipe right to like, left to skip. Pick 1 once you have enough likes."})]}),e.jsx("div",{className:"flex-1 min-h-0 pb-4 overflow-y-auto",children:V?e.jsxs("div",{className:"mx-auto w-full max-w-md",children:[f&&e.jsx("p",{className:g("text-sm",k),children:"Loading selectionâ€¦"}),N&&e.jsx("p",{className:"text-sm text-red-500",children:N}),!f&&!N&&C&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:g("mb-3 text-sm",k),children:"Selected to watch:"}),e.jsx("div",{className:"relative h-[520px] md:h-[560px]",children:e.jsx(L,{entry:C,isTop:!1,likeOpacity:0,nopeOpacity:0,style:{zIndex:1,transform:"none",transition:"none"}})}),r&&e.jsx("p",{className:"mt-3 text-sm text-red-500",children:r}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("button",{className:"flex-1 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-4 py-3 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900",onClick:j,disabled:I,children:"Back to cards"}),e.jsx("button",{className:"flex-1 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>void K(C.id),disabled:I,children:I?"Marking...":"Mark as Watched"})]})]})]}):e.jsxs(e.Fragment,{children:[m&&!x&&_.length===0&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-zinc-300 border-t-indigo-500"}),e.jsx("p",{className:k,children:"Loading..."})]})}),x&&e.jsx("p",{className:"text-sm text-red-500",children:x}),!m&&!x&&_.length===0&&c.length<w&&e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 py-12 text-center",children:[e.jsx("p",{className:g("text-sm",k),children:"No unwatched items to swipe on."}),e.jsx("button",{className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500",onClick:()=>void M(),children:"Reload"})]}),q?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:g("text-sm",k),children:["You liked ",c.length,". Pick one to watch:"]}),e.jsx("div",{className:"grid gap-3 md:grid-cols-3",children:(w===1?c:c.slice(0,3)).map(s=>e.jsxs("button",{className:g("rounded-xl border p-4 text-left transition","bg-white dark:bg-zinc-950 border-zinc-200 dark:border-zinc-800 hover:border-indigo-400",y===s.id?"ring-2 ring-indigo-500":""),onClick:()=>W(s.id),children:[e.jsx("div",{className:g("font-semibold",B),children:s.title}),s.releaseYear&&e.jsx("div",{className:g("text-sm",k),children:s.releaseYear}),s.overview&&e.jsx("div",{className:g("mt-2 text-sm line-clamp-3",k),children:s.overview})]},s.id))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"rounded-lg border border-zinc-200 dark:border-zinc-800 px-4 py-2 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900",onClick:()=>{h()},disabled:I,children:"Start over"}),e.jsx("button",{className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>{if(!y)return;const s=c.find(o=>o.id===y);s&&(i(null),S(s))},disabled:!y,children:"Choose winner"})]})]}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-md flex-col",children:[e.jsxs("div",{className:"relative flex-1 min-h-[440px] md:min-h-[520px]",children:[l&&e.jsx(L,{entry:l,isTop:!0,likeOpacity:G,nopeOpacity:H,style:{zIndex:50,transform:`translate3d(${a.dx}px, ${a.dy}px, 0) rotate(${a.dx/14}deg)`,transition:a.isDragging?"none":"transform 220ms ease"},onPointerDown:s=>{if(!l||a.animatingOut||c.length>=w)return;s.currentTarget.setPointerCapture(s.pointerId);const{x:o,y:p}=X(s);b(Y=>({...Y,activeId:l.id,startX:o,startY:p,dx:0,dy:0,isDragging:!0,animatingOut:!1,decision:null}))}}),D.map((s,o)=>e.jsx(L,{entry:s,isTop:!1,likeOpacity:0,nopeOpacity:0,style:{zIndex:40-o,transform:`translate3d(0, ${10+o*10}px, 0) scale(${1-(o+1)*.03})`,transition:"transform 220ms ease"}},s.id)),e.jsx("div",{className:"absolute inset-0",onPointerMove:s=>{if(!l||!a.isDragging||a.activeId!==l.id)return;const{x:o,y:p}=X(s);b(Y=>({...Y,dx:o-Y.startX,dy:p-Y.startY}))},onPointerUp:()=>{if(l&&a.isDragging&&a.activeId===l.id){if(a.dx>v)return E("like");if(a.dx<-v)return E("nope");b(s=>({...s,isDragging:!1,dx:0,dy:0}))}},onPointerCancel:()=>{b(s=>({...s,isDragging:!1,dx:0,dy:0}))}})]}),e.jsx("div",{className:"mt-4 flex-shrink-0 pb-2",children:e.jsxs("div",{className:"flex w-full items-center justify-between gap-3",children:[e.jsx("button",{className:"flex-1 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 px-4 py-3 text-sm font-semibold hover:bg-zinc-50 dark:hover:bg-zinc-900 disabled:opacity-60",onClick:()=>E("nope"),disabled:!l||a.animatingOut||c.length>=w,children:"Nope"}),e.jsxs("div",{className:g("text-sm",k),children:["Liked: ",e.jsx("span",{className:"font-semibold",children:c.length}),"/",w||3]}),e.jsx("button",{className:"flex-1 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-500 disabled:opacity-60",onClick:()=>E("like"),disabled:!l||a.animatingOut||c.length>=w,children:"Like"})]})})]})})]})})]})}function R(t){return t&&t.split("-")[0]||""}function A(t){return t?Array.isArray(t)?t[0]??null:t:null}function U(t){return t?Array.isArray(t)?t[0]?.name??null:t.name??null:null}function le(){const t=J(),m=Q(),x=n.useMemo(()=>{const r=t.entryId;if(!r)return null;const i=Number(r);return Number.isFinite(i)&&i>0?Math.trunc(i):null},[t.entryId]),[M,T]=n.useState([]),[C,f]=n.useState(!0),[N,S]=n.useState(null),[z,j]=n.useState(null),[_,d]=n.useState(!1),[c,P]=n.useState(null),y=n.useCallback(async()=>{f(!0),S(null);try{const r=$(),{data:i,error:a}=await r.from("entries").select(`
            id,
            added_at,
            media_type,
            watched_at,
            tmdb_details (
              poster_path,
              backdrop_path,
              overview,
              name,
              release_date
            ),
            entry_tags (
              tags (
                name
              )
            )
          `).is("watched_at",null).order("added_at",{ascending:!1}).limit(50);if(a)throw a;const b=(i??[]).map(u=>{const h=A(u.tmdb_details),l=h?.name||"Untitled",D=u.entry_tags?.map(v=>U(v.tags)).filter(v=>!!v)??[];return{id:u.id,title:l,overview:h?.overview??null,releaseYear:R(h?.release_date??null),posterPath:h?.poster_path??null,backdropPath:h?.backdrop_path??null,mediaType:u.media_type,tags:D}});T(b)}catch(r){const i=r instanceof Error?r.message:typeof r=="object"&&r!==null&&"message"in r&&typeof r.message=="string"?String(r.message):"Failed to load watch deck";S(i),T([])}finally{f(!1)}},[]);n.useEffect(()=>((async()=>{await y()})(),()=>{}),[y]);const W=n.useCallback(async r=>{d(!0),P(null);try{const i=$(),{data:a,error:b}=await i.from("entries").select(`
              id,
              added_at,
              media_type,
              watched_at,
              tmdb_details (
                poster_path,
                backdrop_path,
                overview,
                name,
                release_date
              ),
              entry_tags (
                tags (
                  name
                )
              )
            `).eq("id",r).maybeSingle();if(b)throw b;if(!a){j(null),P("Could not find that entry.");return}const u=a,h=A(u.tmdb_details),l=h?.name||"Untitled",D=u.entry_tags?.map(v=>U(v.tags)).filter(v=>!!v)??[];j({id:u.id,title:l,overview:h?.overview??null,releaseYear:R(h?.release_date??null),posterPath:h?.poster_path??null,backdropPath:h?.backdrop_path??null,mediaType:u.media_type,tags:D})}catch(i){const a=i instanceof Error?i.message:typeof i=="object"&&i!==null&&"message"in i&&typeof i.message=="string"?String(i.message):"Failed to load selected entry";j(null),P(a)}finally{d(!1)}},[]);n.useEffect(()=>{if(!x){j(null),P(null),d(!1);return}z?.id!==x&&W(x)},[W,z?.id,x]);const I=n.useCallback(r=>{j(r),m(`/app/watch/${r.id}`)},[m]),O=n.useCallback(async r=>{const i=$(),{error:a}=await i.from("entries").update({watched_at:new Date().toISOString()}).eq("id",r);if(a)throw a;m("/app/watch"),await y()},[y,m]);return e.jsx(te,{initialEntries:M,loading:C,error:N,onReload:y,winnerEntryId:x,winnerEntry:z,winnerLoading:_,winnerError:c,onGoToWinner:I,onMarkWatched:O,onBackToCards:()=>m("/app/watch")})}export{le as W};
